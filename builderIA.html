<!DOCTYPE html>
<html lang="fr" data-fr-theme>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>gouv-widgets ‚Äî Builder IA</title>

  <!-- DSFR -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/utility/utility.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- DSFR Chart (pour les cartes) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr-chart@2.0.4/dist/DSFRChart/DSFRChart.css">
  <script type="module" src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr-chart@2.0.4/dist/DSFRChart/DSFRChart.js"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: var(--background-alt-grey);
    }

    .builder-header {
      background: var(--background-default-grey);
      border-bottom: 1px solid var(--border-default-grey);
      padding: 0.75rem 0;
    }

    .builder-header h1 {
      margin: 0;
      font-size: 1.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .builder-container {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* ============================================ */
    /* PANNEAU GAUCHE : CONFIG + CHAT */
    /* ============================================ */
    .builder-config {
      width: 420px;
      background: var(--background-default-grey);
      border-right: 1px solid var(--border-default-grey);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }

    .config-section {
      padding: 1rem;
      border-bottom: 1px solid var(--border-default-grey);
    }

    .config-section h3 {
      margin: 0 0 0.75rem;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .step-number {
      background: var(--background-action-high-blue-france);
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
    }

    /* Config IA collapsible */
    .ia-config-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      padding: 0.5rem;
      background: var(--background-contrast-grey);
      border-radius: 4px;
      margin-top: 0.5rem;
      font-size: 0.8rem;
    }

    .ia-config-toggle:hover {
      background: var(--background-alt-grey);
    }

    .ia-config-content {
      display: none;
      padding: 0.75rem;
      background: var(--background-alt-grey);
      border-radius: 0 0 4px 4px;
      margin-top: -4px;
    }

    .ia-config-content.open {
      display: block;
    }

    .ia-config-content .fr-input-group {
      margin-bottom: 0.5rem;
    }

    .ia-config-content label {
      font-size: 0.75rem;
    }

    .ia-config-content input,
    .ia-config-content textarea,
    .ia-config-content select {
      font-size: 0.8rem;
    }

    /* ============================================ */
    /* ZONE CHAT */
    /* ============================================ */
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }

    .chat-header {
      padding: 0.75rem 1rem;
      background: var(--background-contrast-info);
      border-bottom: 1px solid var(--border-default-grey);
      font-size: 0.85rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      min-height: 0;
    }

    .chat-message {
      max-width: 90%;
      padding: 0.75rem 1rem;
      border-radius: 12px;
      font-size: 0.85rem;
      line-height: 1.4;
    }

    .chat-message.user {
      align-self: flex-end;
      background: var(--background-action-high-blue-france);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .chat-message.assistant {
      align-self: flex-start;
      background: var(--background-contrast-grey);
      border-bottom-left-radius: 4px;
    }

    .chat-message.assistant.thinking {
      opacity: 0.7;
      font-style: italic;
    }

    .chat-message pre {
      background: var(--background-alt-grey);
      padding: 0.5rem;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 0.75rem;
      margin: 0.5rem 0;
    }

    .chat-message code {
      font-family: monospace;
      font-size: 0.8rem;
    }

    /* Suggestions */
    .chat-suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .chat-suggestion {
      padding: 0.4rem 0.75rem;
      background: var(--background-default-grey);
      border: 1px solid var(--border-action-high-blue-france);
      border-radius: 16px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.15s;
    }

    .chat-suggestion:hover {
      background: var(--background-action-high-blue-france);
      color: white;
    }

    /* Input zone */
    .chat-input-container {
      padding: 1rem;
      border-top: 1px solid var(--border-default-grey);
      background: var(--background-default-grey);
      flex-shrink: 0;
    }

    .chat-input-wrapper {
      display: flex;
      gap: 0.5rem;
      align-items: flex-end;
    }

    .chat-input {
      flex: 1;
      border: 1px solid var(--border-default-grey);
      border-radius: 12px;
      padding: 0.75rem 1rem;
      font-size: 0.9rem;
      resize: none;
      min-height: 60px;
      max-height: 150px;
      font-family: inherit;
      line-height: 1.4;
    }

    .chat-input:focus {
      outline: none;
      border-color: var(--border-action-high-blue-france);
    }

    .chat-send-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--background-action-high-blue-france);
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      flex-shrink: 0;
    }

    .chat-send-btn:hover {
      opacity: 0.9;
    }

    .chat-send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ============================================ */
    /* PANNEAU DROIT : APER√áU */
    /* ============================================ */
    .builder-preview {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--background-alt-grey);
      overflow: hidden;
    }

    .preview-tabs {
      display: flex;
      background: var(--background-default-grey);
      border-bottom: 1px solid var(--border-default-grey);
    }

    .tab-btn {
      padding: 0.75rem 1.5rem;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 0.85rem;
      border-bottom: 2px solid transparent;
      color: var(--text-mention-grey);
    }

    .tab-btn.active {
      color: var(--text-action-high-blue-france);
      border-bottom-color: var(--border-action-high-blue-france);
      font-weight: 600;
    }

    .tab-content {
      display: none;
      flex: 1;
      overflow: auto;
    }

    .tab-content.active {
      display: flex;
      flex-direction: column;
    }

    /* Preview chart */
    .preview-chart {
      flex: 1;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      position: sticky;
      top: 0;
    }

    .preview-title {
      font-size: 1.25rem;
      margin: 0 0 0.25rem;
      color: var(--text-title-grey);
    }

    .preview-subtitle {
      font-size: 0.9rem;
      color: var(--text-mention-grey);
      margin: 0 0 1rem;
    }

    .chart-wrapper {
      position: relative;
      height: 350px;
      background: var(--background-default-grey);
      border-radius: 8px;
      padding: 1rem;
    }

    #preview-canvas {
      width: 100% !important;
      height: 100% !important;
    }

    .empty-state {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--text-mention-grey);
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    /* Code tab */
    #tab-code {
      padding: 1rem;
    }

    #generated-code {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 1rem;
      border-radius: 8px;
      font-family: 'Fira Code', monospace;
      font-size: 0.8rem;
      white-space: pre-wrap;
      overflow: auto;
      flex: 1;
    }

    .copy-btn {
      align-self: flex-end;
      margin-bottom: 0.5rem;
    }

    /* Data tab */
    #tab-data {
      padding: 1rem;
    }

    .data-summary {
      background: var(--background-default-grey);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .data-summary h4 {
      margin: 0 0 0.5rem;
      font-size: 0.9rem;
    }

    .field-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .field-tag {
      padding: 0.25rem 0.5rem;
      background: var(--background-contrast-info);
      border-radius: 4px;
      font-size: 0.75rem;
    }

    .field-tag.numeric {
      background: var(--background-contrast-success);
    }

    #raw-data {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 1rem;
      border-radius: 8px;
      font-family: monospace;
      font-size: 0.75rem;
      white-space: pre-wrap;
      overflow: auto;
      max-height: 400px;
    }

    /* KPI Cards */
    .kpi-card {
      background: var(--background-default-grey);
      border-left: 4px solid var(--border-default-grey);
      padding: 1.5rem 2rem;
      text-align: center;
      border-radius: 4px;
    }
    .kpi-card--info { border-left-color: #0063CB; }
    .kpi-card--success { border-left-color: #18753C; }
    .kpi-card--warning { border-left-color: #D64D00; }
    .kpi-card--error { border-left-color: #C9191E; }
    .kpi-value { display: block; font-size: 2.5rem; font-weight: 700; color: var(--text-title-grey); }
    .kpi-label { display: block; font-size: 0.875rem; color: var(--text-mention-grey); margin-top: 0.5rem; }

    /* Gauge Cards */
    .gauge-card {
      background: var(--background-default-grey);
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .gauge-container { position: relative; width: 200px; }
    .gauge-svg { width: 100%; height: auto; }
    .gauge-value {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-title-grey);
    }
    .gauge-label {
      margin-top: 0.5rem;
      font-size: 0.875rem;
      color: var(--text-mention-grey);
    }

    /* Source badges */
    .source-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.125rem 0.5rem;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .source-badge-grist { background: #16a34a; color: white; }
    .source-badge-manual { background: #9333ea; color: white; }
    .source-badge-api { background: #2563eb; color: white; }

    .source-tab {
      flex: 1;
      padding: 0.4rem;
      border: 1px solid var(--border-default-grey);
      background: var(--background-default-grey);
      cursor: pointer;
      font-size: 0.75rem;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
    }
    .source-tab:hover { background: var(--background-contrast-grey); }
    .source-tab.active {
      background: var(--background-contrast-info);
      border-color: var(--border-action-high-blue-france);
      font-weight: 600;
    }

    /* Resizer */
    .resizer {
      width: 6px;
      background: var(--border-default-grey);
      cursor: col-resize;
      flex-shrink: 0;
      transition: background 0.15s;
    }
    .resizer:hover, .resizer.dragging {
      background: var(--border-action-high-blue-france);
    }

    /* Responsive */
    @media (max-width: 900px) {
      .builder-container {
        flex-direction: column;
      }
      .builder-config {
        width: 100%;
        max-height: 50vh;
      }
      .resizer { display: none; }
    }
    /* Sections collapsibles */
    .config-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
    }

    .config-section-header:hover {
      opacity: 0.8;
    }

    .config-section-header .collapse-icon {
      transition: transform 0.2s;
      font-size: 1rem;
      color: var(--text-mention-grey);
    }

    .config-section.collapsed .collapse-icon {
      transform: rotate(-90deg);
    }

    .config-section-content {
      overflow: hidden;
      max-height: 1000px;
      transition: max-height 0.3s ease, padding 0.3s ease;
    }

    .config-section.collapsed .config-section-content {
      max-height: 0;
      padding-top: 0;
      padding-bottom: 0;
    }

    .config-section h3 {
      margin: 0;
    }
  </style>
</head>
<body>
  <!-- ============================================ -->
  <!-- HEADER DSFR -->
  <!-- ============================================ -->
  <header role="banner" class="fr-header">
    <div class="fr-header__body">
      <div class="fr-container">
        <div class="fr-header__body-row">
          <div class="fr-header__brand fr-enlarge-link">
            <div class="fr-header__brand-top">
              <div class="fr-header__logo">
                <p class="fr-logo">
                  R√©publique<br>Fran√ßaise
                </p>
              </div>
              <div class="fr-header__navbar">
                <button class="fr-btn--menu fr-btn" data-fr-opened="false" aria-controls="modal-menu" aria-haspopup="menu" id="button-menu" title="Menu">
                  Menu
                </button>
              </div>
            </div>
            <div class="fr-header__service">
              <a href="index.html" title="Accueil - gouv-widgets">
                <p class="fr-header__service-title">Charts builder</p>
              </a>
              <p class="fr-header__service-tagline">Cr√©ation de visualisations dynamiques conformes DSFR</p>
            </div>
          </div>
          <div class="fr-header__tools">
            <div class="fr-header__tools-links">
              <ul class="fr-btns-group">
                <li>
                  <a class="fr-btn fr-icon-github-fill" href="https://github.com/bmatge/datasource-charts-webcomponents" target="_blank" rel="noopener">
                    GitHub
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="fr-header__menu fr-modal" id="modal-menu" aria-labelledby="button-menu">
      <div class="fr-container">
        <button class="fr-btn--close fr-btn" aria-controls="modal-menu" title="Fermer">
          Fermer
        </button>
        <div class="fr-header__menu-links"></div>
        <nav class="fr-nav" id="header-navigation" role="navigation" aria-label="Menu principal">
          <ul class="fr-nav__list">
            <li class="fr-nav__item">
              <a class="fr-nav__link" href="index.html">Accueil</a>
            </li>
            <li class="fr-nav__item">
              <a class="fr-nav__link" href="demo/index.html">Composants</a>
            </li>
            <li class="fr-nav__item">
              <a class="fr-nav__link" href="builder.html">Builder</a>
            </li>
            <li class="fr-nav__item">
              <a class="fr-nav__link" href="builderIA.html" aria-current="page">Builder IA</a>
            </li>
            <li class="fr-nav__item">
              <a class="fr-nav__link" href="playground.html">Playground</a>
            </li>
            <li class="fr-nav__item">
              <a class="fr-nav__link" href="sources.html">Sources</a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </header>

  <div class="builder-container">
    <!-- ============================================ -->
    <!-- PANNEAU GAUCHE : CONFIG + CHAT -->
    <!-- ============================================ -->
    <aside class="builder-config">

      <!-- Source de donn√©es + Config IA -->
      <div class="config-section" id="section-source">
        <div class="config-section-header" onclick="toggleSection('section-source')">
          <h3><span class="step-number">1</span> Source de donn√©es</h3>
          <i class="ri-arrow-down-s-line collapse-icon"></i>
        </div>
        <div class="config-section-content">

        <!-- Onglets de type de source -->
        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
          <button class="source-tab active" data-source-type="api" onclick="switchSourceType('api')">
            <i class="ri-cloud-line"></i> API
          </button>
          <button class="source-tab" data-source-type="saved" onclick="switchSourceType('saved')">
            <i class="ri-database-2-line"></i> Mes sources
          </button>
        </div>

        <!-- Panel API publique -->
        <div id="source-panel-api" class="source-panel">
          <div class="fr-select-group fr-select-group--sm">
            <label class="fr-label" for="preset-api">API pr√©d√©finie</label>
            <select class="fr-select" id="preset-api">
              <option value="">‚Äî Choisir ‚Äî</option>
              <option value="controle-technique">Contr√¥le technique</option>
              <option value="elections">√âlections</option>
              <option value="qualite-air">Qualit√© de l'air</option>
              <option value="custom">URL personnalis√©e...</option>
            </select>
          </div>
          <div class="fr-input-group fr-input-group--sm fr-mt-1w" id="custom-url-group" style="display: none;">
            <label class="fr-label" for="custom-api-url">URL de l'API (OpenDataSoft v2.1)</label>
            <input class="fr-input" type="url" id="custom-api-url" placeholder="https://...">
          </div>
          <button class="fr-btn fr-btn--sm fr-btn--secondary fr-mt-1w" onclick="loadAPIData()">
            <i class="ri-download-line"></i> Charger
          </button>
        </div>

        <!-- Panel Mes sources -->
        <div id="source-panel-saved" class="source-panel" style="display: none;">
          <div class="fr-select-group fr-select-group--sm">
            <label class="fr-label" for="saved-source">Source</label>
            <select class="fr-select" id="saved-source">
              <option value="">‚Äî Choisir ‚Äî</option>
            </select>
          </div>
        </div>

        <div id="source-info" style="font-size: 0.8rem; color: var(--text-mention-grey); margin-top: 0.5rem;"></div>

        <!-- Config IA (collapsible) -->
        <div class="ia-config-toggle" onclick="toggleIAConfig()">
          <span><i class="ri-robot-line"></i> Configuration Albert IA</span>
          <i class="ri-arrow-down-s-line" id="ia-config-arrow"></i>
        </div>
        <div class="ia-config-content" id="ia-config-content">
          <div class="fr-input-group">
            <label class="fr-label" for="ia-api-url">URL de l'API</label>
            <input class="fr-input" type="url" id="ia-api-url"
                   value="https://albert.api.etalab.gouv.fr/v1/chat/completions"
                   placeholder="https://albert.api.etalab.gouv.fr/v1/chat/completions">
          </div>
          <div class="fr-input-group">
            <label class="fr-label" for="ia-model">Mod√®le</label>
            <select class="fr-select" id="ia-model">
              <option value="albert-small">albert-small ‚Äî Llama 3.1 8B (rapide)</option>
              <option value="albert-large" selected>albert-large ‚Äî Mistral Small 24B (recommand√©)</option>
              <option value="albert-code">albert-code ‚Äî Qwen Coder 32B</option>
              <option value="openweight-large">openweight-large ‚Äî GPT OSS 120B (lent)</option>
              <option value="openweight-code">openweight-code ‚Äî Qwen3 Coder 30B</option>
            </select>
          </div>
          <div class="fr-input-group">
            <label class="fr-label" for="ia-token">Token API</label>
            <input class="fr-input" type="password" id="ia-token" placeholder="Votre token Albert">
          </div>
          <div class="fr-input-group">
            <label class="fr-label" for="ia-system-prompt">System prompt</label>
            <textarea class="fr-input" id="ia-system-prompt" rows="4" style="font-size: 0.75rem;">Tu es un assistant expert en visualisation de donn√©es pour les services publics fran√ßais.

R√¥le : Analyser les donn√©es fournies, sugg√©rer des visualisations, et g√©n√©rer des graphiques ou KPIs.

Pour cr√©er un graphique, g√©n√®re un bloc JSON :
```json
{
  "action": "createChart",
  "config": {
    "type": "bar|line|pie|doughnut|radar|horizontalBar|scatter|gauge|kpi|map",
    "labelField": "champ_labels",
    "valueField": "champ_valeurs",
    "valueField2": "champ_valeurs_serie2",  // Optionnel: pour bar/line/radar avec 2 s√©ries
    "codeField": "code_departement",  // Requis pour map: code INSEE (01-95, 2A, 2B, 971-976)
    "aggregation": "sum|avg|count|min|max",
    "limit": 10,
    "sortOrder": "desc|asc",
    "title": "Titre",
    "subtitle": "Sous-titre",
    "color": "#000091",
    "color2": "#E1000F",  // Couleur s√©rie 2
    "variant": "info|success|warning|error",
    "unit": "‚Ç¨|%|unit√©"
  }
}
```

Pour un KPI (indicateur chiffr√© unique), utilise type:"kpi" avec un seul valueField. Le labelField n'est pas requis pour un KPI. Les options variant et unit sont optionnelles.

Tu disposes de SKILLS (connaissances sp√©cialis√©es) qui seront inject√©s automatiquement selon le contexte : ODSQL, versions API, types de graphiques, couleurs DSFR.

Sois concis. Utilise le fran√ßais.</textarea>
          </div>
          <button class="fr-btn fr-btn--sm fr-btn--secondary" onclick="saveIAConfig()">
            <i class="ri-save-line"></i> Sauvegarder config
          </button>
        </div>
        </div>
      </div>

      <!-- Zone Chat -->
      <div class="chat-container">
        <div class="chat-header">
          <i class="ri-chat-3-line"></i>
          Assistant graphiques
        </div>

        <div class="chat-messages" id="chat-messages">
          <!-- Messages will be added here -->
        </div>

        <div class="chat-input-container">
          <div class="chat-input-wrapper">
            <textarea class="chat-input" id="chat-input"
                      placeholder="D√©crivez le graphique que vous souhaitez cr√©er..."
                      rows="1"></textarea>
            <button class="chat-send-btn" id="chat-send-btn" onclick="sendMessage()">
              <i class="ri-send-plane-fill"></i>
            </button>
          </div>
        </div>
      </div>

    </aside>

    <!-- Resizer -->
    <div class="resizer" id="resizer"></div>

    <!-- ============================================ -->
    <!-- PANNEAU DROIT : APER√áU -->
    <!-- ============================================ -->
    <main class="builder-preview">
      <div class="preview-tabs">
        <button class="tab-btn active" data-tab="preview">Aper√ßu</button>
        <button class="tab-btn" data-tab="code">Code</button>
        <button class="tab-btn" data-tab="data">Donn√©es</button>
      </div>

      <!-- Tab Aper√ßu -->
      <div class="tab-content active" id="tab-preview">
        <div class="preview-chart">
          <h2 class="preview-title" id="preview-title">Mon graphique</h2>
          <p class="preview-subtitle" id="preview-subtitle"></p>
          <div class="chart-wrapper">
            <div class="empty-state" id="empty-state">
              <i class="ri-bar-chart-box-line"></i>
              <p>Discutez avec l'assistant pour cr√©er votre graphique</p>
            </div>
            <canvas id="preview-canvas" style="display: none;"></canvas>
          </div>
        </div>
      </div>

      <!-- Tab Code -->
      <div class="tab-content" id="tab-code">
        <button class="fr-btn fr-btn--sm fr-btn--secondary copy-btn" onclick="copyCode()">
          <i class="ri-file-copy-line"></i> Copier le code
        </button>
        <pre id="generated-code">// Le code sera g√©n√©r√© ici apr√®s cr√©ation du graphique</pre>
      </div>

      <!-- Tab Donn√©es -->
      <div class="tab-content" id="tab-data">
        <div class="data-summary" id="data-summary">
          <h4>Champs disponibles</h4>
          <div class="field-list" id="field-list">
            <span style="color: var(--text-mention-grey); font-size: 0.8rem;">
              S√©lectionnez une source de donn√©es
            </span>
          </div>
        </div>
        <h4 style="font-size: 0.9rem; margin-bottom: 0.5rem;">Donn√©es brutes</h4>
        <pre id="raw-data">// S√©lectionnez une source pour voir les donn√©es</pre>
      </div>
    </main>
  </div>

  <script>
    // ============================================================
    // SKILLS DE L'ASSISTANT IA
    // ============================================================
    const SKILLS = {
      odsql: {
        id: 'odsql',
        name: 'ODSQL (OpenDataSoft Query Language)',
        description: 'Syntaxe de requ√™tes pour les APIs OpenDataSoft',
        trigger: ['api', 'requ√™te', 'query', 'filtre', 'agr√©gation', 'opendatasoft'],
        content: `## ODSQL - OpenDataSoft Query Language

### Param√®tres de requ√™te
- **select**: Champs √† retourner. Ex: \`select=nom,population\` ou avec alias \`select=avg(prix) as prix_moyen\`
- **where**: Filtres. Ex: \`where=population>10000\` ou \`where=nom like "Paris%"\`
- **group_by**: Groupement. Ex: \`group_by=region\`
- **order_by**: Tri. Ex: \`order_by=population DESC\` ou \`order_by=nom ASC\`
- **limit**: Nombre max de r√©sultats. Ex: \`limit=100\` (d√©faut: 10, max: 100)
- **offset**: Pagination. Ex: \`offset=20\`

### Fonctions d'agr√©gation
- count(*), count(champ)
- sum(champ), avg(champ), min(champ), max(champ)
- percentile(champ, 50) pour la m√©diane

### Op√©rateurs WHERE
- Comparaison: =, !=, <, >, <=, >=
- Texte: like, not like (% = wildcard)
- Liste: in, not in. Ex: \`region in ("IDF","PACA")\`
- Null: is null, is not null
- Logique: and, or, not

### Fonctions sur les dates
- year(date), month(date), day(date)
- date_format(date, "YYYY-MM")

### Exemple complet
\`?select=region,avg(prix) as prix_moyen&where=annee>=2020&group_by=region&order_by=prix_moyen DESC&limit=10\``
      },

      odsApiVersions: {
        id: 'odsApiVersions',
        name: 'Versions API OpenDataSoft',
        description: 'Diff√©rences entre v1, v2 et v2.1',
        trigger: ['version', 'v1', 'v2', 'v2.1', 'api', 'migration'],
        content: `## Versions des APIs OpenDataSoft

### API v2.1 (recommand√©e)
- URL: \`/api/explore/v2.1/catalog/datasets/{dataset_id}/records\`
- R√©ponse: \`{ results: [...], total_count: N }\`
- ODSQL complet support√©
- Pagination: limit + offset

### API v2.0
- URL: \`/api/v2/catalog/datasets/{dataset_id}/records\`
- Similaire √† v2.1, quelques fonctions ODSQL manquantes
- D√©pr√©ci√©, pr√©f√©rer v2.1

### API v1 (legacy)
- URL: \`/api/records/1.0/search/?dataset={dataset_id}\`
- R√©ponse: \`{ records: [{ fields: {...}, recordid: "..." }] }\`
- Param√®tres diff√©rents: q (recherche), refine, exclude, rows, start
- Les donn√©es sont dans record.fields

### D√©tection automatique
- Si l'URL contient \`/v2.1/\` ‚Üí v2.1
- Si l'URL contient \`/v2/\` ‚Üí v2
- Si l'URL contient \`/1.0/\` ou \`rows=\` ‚Üí v1
- Par d√©faut essayer v2.1

### Migration v1 ‚Üí v2.1
| v1 | v2.1 |
|---|---|
| rows=N | limit=N |
| start=N | offset=N |
| q=texte | where=search(champ,"texte") |
| refine.champ=val | where=champ="val" |
| record.fields.X | record.X |`
      },

      chartTypes: {
        id: 'chartTypes',
        name: 'Types de graphiques',
        description: 'Quand utiliser quel type de graphique',
        trigger: ['graphique', 'chart', 'visualisation', 'barres', 'camembert', 'ligne', 'kpi', 'indicateur', 'chiffre', 'jauge', 'nuage', 'scatter', 'carte', 'map', 'd√©partement'],
        content: `## Choix du type de graphique

### KPI (kpi)
- Afficher une valeur unique importante
- Indicateur cl√©, chiffre global, total
- Ex: nombre total d'utilisateurs, CA annuel, taux de satisfaction
- Options: variant (info|success|warning|error), unit (‚Ç¨, %, etc.)

### Jauge (gauge)
- Afficher une progression vers un objectif (0-100%)
- Valeur unique avec repr√©sentation visuelle
- Ex: score de conformit√©, progression projet

### Barres verticales (bar)
- Comparer des cat√©gories
- Id√©al: 5-15 cat√©gories
- Supporte 2 s√©ries (valueField2)
- Ex: ventes par r√©gion, scores par √©quipe

### Barres horizontales (horizontalBar)
- Cat√©gories avec noms longs
- Classements (top 10)
- Supporte 2 s√©ries (valueField2)
- Ex: top 10 des villes, classement produits

### Lignes (line)
- √âvolution temporelle
- Tendances, s√©ries chronologiques
- Supporte 2 s√©ries (valueField2) pour comparaisons
- Ex: temp√©rature par mois, CA par ann√©e

### Nuage de points (scatter)
- Corr√©lation entre deux variables num√©riques
- Pas de cat√©gories, juste X et Y num√©riques
- Ex: prix vs surface, √¢ge vs revenu

### Camembert (pie)
- Parts d'un tout (100%)
- Max 5-7 segments
- Ex: r√©partition budget, parts de march√©

### Anneau (doughnut)
- Comme pie mais plus lisible
- Permet d'afficher une valeur au centre
- Ex: progression vers objectif

### Radar
- Comparer plusieurs dimensions
- Profils, scores multicrit√®res
- Supporte 2 s√©ries (valueField2)
- Ex: √©valuation comp√©tences, comparatif produits

### Carte de France (map)
- Visualiser des donn√©es par d√©partement
- Requiert codeField: champ avec code INSEE (01-95, 2A, 2B, 971-976)
- Ex: prix immobilier par d√©partement, taux de ch√¥mage r√©gional
- Utilise DSFR map-chart (pas Chart.js)

## S√©ries multiples (bar, line, radar)
Pour comparer 2 m√©triques, utilise valueField2:
- valueField: premi√®re s√©rie (couleur principale)
- valueField2: seconde s√©rie (couleur secondaire)`
      },

      dsfrColors: {
        id: 'dsfrColors',
        name: 'Couleurs DSFR',
        description: 'Palette officielle du Design System de l\'√âtat',
        trigger: ['couleur', 'color', 'dsfr', 'palette', 'style'],
        content: `## Palette DSFR (Design System de l'√âtat)

### Couleurs principales
- **Bleu France**: #000091 (couleur par d√©faut)
- **Bleu France clair**: #6A6AF4
- **√âmeraude**: #009081 (succ√®s, positif)
- **Marianne**: #C9191E (erreur, alerte)

### Couleurs secondaires
- **Orange**: #FF9940 (avertissement)
- **Violet**: #A558A0
- **Bleu ciel**: #417DC4
- **Marron**: #716043
- **Vert for√™t**: #18753C
- **Gris**: #3A3A3A

### Bonnes pratiques
- Utiliser #000091 par d√©faut pour graphiques mono-couleur
- Pour pie/doughnut, utiliser la palette compl√®te
- Assurer un contraste suffisant (accessibilit√© RGAA)
- √âviter le rouge/vert seuls (daltonisme)`
      },

      apiQuery: {
        id: 'apiQuery',
        name: 'Requ√™tes API avanc√©es',
        description: 'Filtrer et agr√©ger les donn√©es via l\'API',
        trigger: ['filtre', 'filtrer', 'seulement', 'uniquement', 'plus de', 'moins de', 'entre', 'top', 'recherche'],
        content: `## Requ√™tes API avanc√©es

Tu peux sugg√©rer de recharger les donn√©es avec des filtres en g√©n√©rant:
\`\`\`json
{
  "action": "reloadData",
  "query": {
    "where": "condition ODSQL",
    "select": "champs √† s√©lectionner",
    "group_by": "champ de groupement",
    "order_by": "champ ASC|DESC",
    "limit": 100
  },
  "reason": "Explication pour l'utilisateur"
}
\`\`\`

### Exemples de filtres
- Top 10 : \`{ "order_by": "valeur DESC", "limit": 10 }\`
- Filtrer par valeur : \`{ "where": "prix > 50" }\`
- Filtrer par texte : \`{ "where": "region like '√éle%'" }\`
- Agr√©ger : \`{ "select": "region, avg(prix) as prix_moyen", "group_by": "region" }\`

Note: Cette action recharge les donn√©es depuis l'API avec les nouveaux param√®tres.`
      }
    };

    // Fonction pour obtenir les skills pertinents selon le contexte
    function getRelevantSkills(message, currentSource) {
      const relevant = [];
      const lowerMsg = message.toLowerCase();

      for (const [key, skill] of Object.entries(SKILLS)) {
        // V√©rifier si un des triggers est pr√©sent
        const triggered = skill.trigger.some(t => lowerMsg.includes(t.toLowerCase()));
        if (triggered) {
          relevant.push(skill);
        }
      }

      // Toujours inclure ODSQL si on a une source API
      if (currentSource?.type === 'api' && !relevant.find(s => s.id === 'odsql')) {
        relevant.push(SKILLS.odsql);
        relevant.push(SKILLS.odsApiVersions);
      }

      return relevant;
    }

    // G√©n√®re le contexte des skills pour le prompt
    function buildSkillsContext(relevantSkills) {
      if (relevantSkills.length === 0) return '';

      return '\n\n---\nCONNAISSANCES DISPONIBLES:\n' +
        relevantSkills.map(s => s.content).join('\n\n');
    }

    // ============================================================
    // COULEURS DSFR
    // ============================================================
    const DSFR_COLORS = [
      '#000091', '#6A6AF4', '#009081', '#C9191E', '#FF9940',
      '#A558A0', '#417DC4', '#716043', '#18753C', '#3A3A3A'
    ];

    // ============================================================
    // √âTAT DE L'APPLICATION
    // ============================================================
    let state = {
      source: null,
      localData: null,
      fields: [],
      chartConfig: null,
      chart: null,
      messages: [],
      isThinking: false
    };

    // ============================================================
    // INITIALISATION
    // ============================================================
    document.addEventListener('DOMContentLoaded', () => {
      // Tabs
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => switchTab(btn.dataset.tab));
      });

      // Source selection
      document.getElementById('saved-source').addEventListener('change', handleSourceChange);

      // Chat input
      const chatInput = document.getElementById('chat-input');
      chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      // Auto-resize textarea
      chatInput.addEventListener('input', () => {
        chatInput.style.height = 'auto';
        chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
      });

      // Load sources and IA config
      loadSavedSources();
      loadIAConfig();

      // Welcome message
      addMessage('assistant', `Bonjour ! S√©lectionnez une source de donn√©es, puis d√©crivez le graphique souhait√©.`, [
        'Aide',
        'Suggestion'
      ]);
    });

    // ============================================================
    // GESTION DES TABS
    // ============================================================
    function switchTab(tabId) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
      document.getElementById(`tab-${tabId}`).classList.add('active');
    }

    // ============================================================
    // GESTION DES SOURCES
    // ============================================================
    const API_PRESETS = {
      'controle-technique': 'https://data.economie.gouv.fr/api/explore/v2.1/catalog/datasets/prix-controle-technique/records',
      'elections': 'https://data.economie.gouv.fr/api/explore/v2.1/catalog/datasets/resultats-legislatives-2024/records',
      'qualite-air': 'https://data.economie.gouv.fr/api/explore/v2.1/catalog/datasets/qualite-de-lair-mesuree-dans-la-station-pa04/records'
    };

    function switchSourceType(type) {
      document.querySelectorAll('.source-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-source-type="${type}"]`).classList.add('active');
      document.getElementById('source-panel-api').style.display = type === 'api' ? 'block' : 'none';
      document.getElementById('source-panel-saved').style.display = type === 'saved' ? 'block' : 'none';
    }

    // Handle preset change to show/hide custom URL input
    document.getElementById('preset-api').addEventListener('change', (e) => {
      const customGroup = document.getElementById('custom-url-group');
      customGroup.style.display = e.target.value === 'custom' ? 'block' : 'none';
    });

    async function loadAPIData() {
      const preset = document.getElementById('preset-api').value;
      let apiUrl;

      if (preset === 'custom') {
        apiUrl = document.getElementById('custom-api-url').value.trim();
        if (!apiUrl) {
          alert('Entrez une URL d\'API');
          return;
        }
      } else if (preset && API_PRESETS[preset]) {
        apiUrl = API_PRESETS[preset];
      } else {
        alert('S√©lectionnez une API');
        return;
      }

      const infoEl = document.getElementById('source-info');
      infoEl.innerHTML = '<i class="ri-loader-4-line"></i> Chargement...';

      const sourceName = preset === 'custom' ? 'API personnalis√©e' : preset;

      try {
        const response = await fetch(apiUrl + '?limit=100');
        const json = await response.json();
        const records = json.results || json.records || [];

        if (records.length === 0) throw new Error('Aucune donn√©e');

        state.source = { name: sourceName, type: 'api', url: apiUrl };
        state.localData = records.map(r => r.fields || r);
        analyzeFields();
        updateFieldsList();
        updateRawData();

        infoEl.innerHTML = `<span class="source-badge source-badge-api">API</span> ${state.localData.length} enregistrements`;

        addMessage('assistant', `API "${sourceName}" charg√©e (${state.localData.length} lignes). Que voulez-vous visualiser ?`, [
          'Barres',
          'Camembert',
          'Courbe'
        ]);
      } catch (error) {
        infoEl.innerHTML = `<span style="color: red;">Erreur: ${error.message}</span>`;
      }
    }

    function loadSavedSources() {
      const select = document.getElementById('saved-source');
      select.innerHTML = '<option value="">‚Äî Choisir une source ‚Äî</option>';

      const sources = JSON.parse(localStorage.getItem('gouv_widgets_sources') || '[]');
      const selectedSource = JSON.parse(localStorage.getItem('gouv_widgets_selected_source') || 'null');

      sources.forEach(source => {
        const option = document.createElement('option');
        option.value = source.id;
        const badge = source.type === 'grist' ? 'üü¢' : source.type === 'manual' ? 'üü£' : 'üîµ';
        option.textContent = `${badge} ${source.name}`;
        option.dataset.source = JSON.stringify(source);
        select.appendChild(option);
      });

      // Check for recently selected source
      if (selectedSource && selectedSource.data) {
        let found = false;
        for (const opt of select.options) {
          if (opt.value === selectedSource.id) {
            opt.selected = true;
            found = true;
            break;
          }
        }
        if (!found) {
          const option = document.createElement('option');
          option.value = selectedSource.id;
          const badge = selectedSource.type === 'grist' ? 'üü¢' : 'üü£';
          option.textContent = `${badge} ${selectedSource.name} (r√©cent)`;
          option.dataset.source = JSON.stringify(selectedSource);
          option.selected = true;
          select.appendChild(option);
        }
        handleSourceChange();
      }
    }

    function handleSourceChange() {
      const select = document.getElementById('saved-source');
      const selectedOption = select.options[select.selectedIndex];
      const infoEl = document.getElementById('source-info');

      if (!selectedOption || !selectedOption.dataset.source) {
        state.source = null;
        state.localData = null;
        state.fields = [];
        infoEl.innerHTML = '';
        updateFieldsList();
        return;
      }

      const source = JSON.parse(selectedOption.dataset.source);
      state.source = source;

      const badge = source.type === 'grist' ? 'source-badge-grist' : source.type === 'manual' ? 'source-badge-manual' : 'source-badge-api';
      const badgeText = source.type === 'grist' ? 'Grist' : source.type === 'manual' ? 'Manuel' : 'API';

      infoEl.innerHTML = `
        <span class="source-badge ${badge}">${badgeText}</span>
        ${source.recordCount || source.data?.length || '?'} enregistrements
      `;

      if (source.data && source.data.length > 0) {
        state.localData = source.data;
        analyzeFields();
        updateFieldsList();
        updateRawData();

        // Inform the chat
        addMessage('assistant', `Source "${source.name}" charg√©e (${source.data.length} lignes, ${state.fields.length} champs). Que voulez-vous visualiser ?`, [
          'Barres',
          'Camembert',
          'Courbe'
        ]);
      }
    }

    function analyzeFields() {
      if (!state.localData || state.localData.length === 0) return;

      const record = state.localData[0];
      state.fields = Object.keys(record).map(key => {
        const value = record[key];
        let type = typeof value;
        if (type === 'number') type = 'num√©rique';
        else if (type === 'string') {
          if (!isNaN(Date.parse(value))) type = 'date';
          else type = 'texte';
        }
        return { name: key, type, sample: value };
      });
    }

    function updateFieldsList() {
      const container = document.getElementById('field-list');
      if (state.fields.length === 0) {
        container.innerHTML = '<span style="color: var(--text-mention-grey); font-size: 0.8rem;">S√©lectionnez une source de donn√©es</span>';
        return;
      }

      container.innerHTML = state.fields.map(f => {
        const isNumeric = f.type === 'num√©rique';
        return `<span class="field-tag ${isNumeric ? 'numeric' : ''}">${f.name} <small>(${f.type})</small></span>`;
      }).join('');
    }

    function updateRawData() {
      const pre = document.getElementById('raw-data');
      if (state.localData) {
        pre.textContent = JSON.stringify(state.localData.slice(0, 50), null, 2);
      }
    }

    // ============================================================
    // CONFIG IA
    // ============================================================
    function toggleIAConfig() {
      const content = document.getElementById('ia-config-content');
      const arrow = document.getElementById('ia-config-arrow');
      content.classList.toggle('open');
      arrow.style.transform = content.classList.contains('open') ? 'rotate(180deg)' : '';
    }

    function loadIAConfig() {
      const config = JSON.parse(localStorage.getItem('gouv_widgets_ia_config') || 'null');
      if (config) {
        if (config.apiUrl) document.getElementById('ia-api-url').value = config.apiUrl;
        if (config.model) document.getElementById('ia-model').value = config.model;
        if (config.token) document.getElementById('ia-token').value = config.token;
        if (config.systemPrompt) document.getElementById('ia-system-prompt').value = config.systemPrompt;
      }
    }

    function saveIAConfig() {
      const config = {
        apiUrl: document.getElementById('ia-api-url').value,
        model: document.getElementById('ia-model').value,
        token: document.getElementById('ia-token').value,
        systemPrompt: document.getElementById('ia-system-prompt').value
      };
      localStorage.setItem('gouv_widgets_ia_config', JSON.stringify(config));
      alert('Configuration sauvegard√©e !');
    }

    function getIAConfig() {
      return {
        apiUrl: document.getElementById('ia-api-url').value,
        model: document.getElementById('ia-model').value,
        token: document.getElementById('ia-token').value,
        systemPrompt: document.getElementById('ia-system-prompt').value
      };
    }

    // ============================================================
    // CHAT
    // ============================================================
    function addMessage(role, content, suggestions = []) {
      const container = document.getElementById('chat-messages');

      const messageEl = document.createElement('div');
      messageEl.className = `chat-message ${role}`;

      // Simple markdown-like formatting
      let html = content
        .replace(/```json\n?([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
        .replace(/```\n?([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');

      messageEl.innerHTML = html;

      // Add suggestions if any
      if (suggestions.length > 0 && role === 'assistant') {
        const suggestionsEl = document.createElement('div');
        suggestionsEl.className = 'chat-suggestions';
        suggestions.forEach(s => {
          const btn = document.createElement('button');
          btn.className = 'chat-suggestion';
          btn.textContent = s;
          btn.onclick = () => {
            document.getElementById('chat-input').value = s;
            sendMessage();
          };
          suggestionsEl.appendChild(btn);
        });
        messageEl.appendChild(suggestionsEl);
      }

      container.appendChild(messageEl);
      container.scrollTop = container.scrollHeight;

      state.messages.push({ role, content });

      return messageEl;
    }

    function addThinkingMessage() {
      const container = document.getElementById('chat-messages');
      const messageEl = document.createElement('div');
      messageEl.className = 'chat-message assistant thinking';
      messageEl.id = 'thinking-message';
      messageEl.innerHTML = '<i class="ri-loader-4-line"></i> R√©flexion en cours...';
      container.appendChild(messageEl);
      container.scrollTop = container.scrollHeight;
      return messageEl;
    }

    function removeThinkingMessage() {
      const el = document.getElementById('thinking-message');
      if (el) el.remove();
    }

    async function sendMessage() {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();

      if (!message || state.isThinking) return;

      // Add user message
      addMessage('user', message);
      input.value = '';
      input.style.height = 'auto';

      // Check if we have a token
      const config = getIAConfig();
      if (!config.token) {
        addMessage('assistant', `Je n'ai pas de token API configur√©. Veuillez ouvrir "Configuration Albert IA" et entrer votre token.

En attendant, je peux vous aider avec des commandes simples. Essayez :
- "barres [champ_label] [champ_valeur]"
- "pie [champ_label] [champ_valeur]"
- "ligne [champ_label] [champ_valeur]"`, [
          'Configurer le token',
          'Cr√©er un graphique simple'
        ]);
        return;
      }

      // Show thinking
      state.isThinking = true;
      document.getElementById('chat-send-btn').disabled = true;
      addThinkingMessage();

      try {
        const response = await callAlbertAPI(message, config);
        removeThinkingMessage();

        // Check if response contains an action
        const action = extractAction(response);
        const textWithoutJson = response.replace(/```json[\s\S]*?```/g, '').trim();

        if (action?.action === 'createChart' && action.config) {
          applyChartConfig(action.config);
          addMessage('assistant', textWithoutJson || 'Voici votre graphique !', [
            'Changer le type',
            'Modifier les couleurs',
            'Ajuster le tri'
          ]);
        } else if (action?.action === 'reloadData') {
          const success = await handleReloadData(action);
          if (success) {
            addMessage('assistant', textWithoutJson || action.reason || 'Donn√©es recharg√©es avec les filtres.', [
              'Barres',
              'Camembert',
              'Courbe'
            ]);
          } else {
            addMessage('assistant', textWithoutJson || 'Impossible de recharger les donn√©es avec ces filtres.');
          }
        } else {
          addMessage('assistant', response);
        }

      } catch (error) {
        removeThinkingMessage();
        console.error('API Error:', error);
        addMessage('assistant', `Erreur de communication avec l'API : ${error.message}

V√©rifiez votre token et l'URL de l'API dans la configuration.`);
      }

      state.isThinking = false;
      document.getElementById('chat-send-btn').disabled = false;
    }

    async function callAlbertAPI(userMessage, config) {
      // Build context with data info
      let dataContext = '';
      if (state.localData && state.fields.length > 0) {
        dataContext = `\n\nDonn√©es actuelles (${state.localData.length} enregistrements) :
Champs : ${state.fields.map(f => `${f.name} (${f.type})`).join(', ')}
Exemple d'enregistrement : ${JSON.stringify(state.localData[0])}`;
      }

      // Inject relevant skills based on the user message
      const relevantSkills = getRelevantSkills(userMessage, state.source);
      const skillsContext = buildSkillsContext(relevantSkills);

      // Build available skills list for the system prompt
      const skillsList = Object.values(SKILLS).map(s => `- ${s.name}: ${s.description}`).join('\n');

      const systemPromptWithSkills = config.systemPrompt +
        `\n\nSKILLS DISPONIBLES (seront inject√©s si pertinents):\n${skillsList}` +
        dataContext +
        skillsContext;

      const messages = [
        { role: 'system', content: systemPromptWithSkills },
        ...state.messages.slice(-10).map(m => ({
          role: m.role === 'assistant' ? 'assistant' : 'user',
          content: m.content
        })),
        { role: 'user', content: userMessage }
      ];

      // Use proxy for Albert API to avoid CORS
      let apiUrl = config.apiUrl;
      if (apiUrl.includes('albert.api.etalab.gouv.fr')) {
        apiUrl = apiUrl.replace('https://albert.api.etalab.gouv.fr', '/albert-proxy');
      }

      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${config.token}`
        },
        body: JSON.stringify({
          model: config.model,
          messages: messages,
          temperature: 0.7,
          max_tokens: 1000
        })
      });

      if (!response.ok) {
        const error = await response.text();
        throw new Error(`HTTP ${response.status}: ${error}`);
      }

      const data = await response.json();
      return data.choices[0].message.content;
    }

    function extractAction(text) {
      // Look for JSON block with action
      const jsonMatch = text.match(/```json\s*([\s\S]*?)```/);
      if (jsonMatch) {
        try {
          const parsed = JSON.parse(jsonMatch[1]);
          if (parsed.action) {
            return parsed;
          }
        } catch (e) {
          console.warn('Failed to parse action:', e);
        }
      }
      return null;
    }

    // Handle reloadData action from AI
    async function handleReloadData(actionData) {
      if (!state.source?.url) {
        addMessage('assistant', 'Je ne peux pas recharger les donn√©es car aucune URL source n\'est disponible.');
        return false;
      }

      const infoEl = document.getElementById('source-info');
      infoEl.innerHTML = '<i class="ri-loader-4-line"></i> Rechargement avec filtres...';

      try {
        // Build query URL
        let url = new URL(state.source.url);
        const query = actionData.query || {};

        if (query.select) url.searchParams.set('select', query.select);
        if (query.where) url.searchParams.set('where', query.where);
        if (query.group_by) url.searchParams.set('group_by', query.group_by);
        if (query.order_by) url.searchParams.set('order_by', query.order_by);
        if (query.limit) url.searchParams.set('limit', query.limit.toString());

        const response = await fetch(url.toString());
        const json = await response.json();
        const records = json.results || json.records || [];

        if (records.length === 0) {
          infoEl.innerHTML = '<span style="color: orange;">Aucun r√©sultat avec ces filtres</span>';
          return false;
        }

        state.localData = records.map(r => r.fields || r);
        analyzeFields();
        updateFieldsList();
        updateRawData();

        infoEl.innerHTML = `<span class="source-badge source-badge-api">API</span> ${state.localData.length} r√©sultats (filtr√©)`;

        return true;
      } catch (error) {
        infoEl.innerHTML = `<span style="color: red;">Erreur: ${error.message}</span>`;
        return false;
      }
    }

    // ============================================================
    // G√âN√âRATION DU GRAPHIQUE
    // ============================================================
    function applyChartConfig(config) {
      state.chartConfig = config;

      // Update UI
      document.getElementById('preview-title').textContent = config.title || 'Mon graphique';
      document.getElementById('preview-subtitle').textContent = config.subtitle || '';

      // Generate chart data
      if (!state.localData || state.localData.length === 0) {
        addMessage('assistant', 'Aucune donn√©e disponible. Veuillez s√©lectionner une source de donn√©es.');
        return;
      }

      // For KPI, aggregate all values into a single result
      if (config.type === 'kpi') {
        let kpiValue;
        const values = state.localData.map(r => parseFloat(r[config.valueField]) || 0);

        switch (config.aggregation) {
          case 'sum':
            kpiValue = values.reduce((a, b) => a + b, 0);
            break;
          case 'count':
            kpiValue = state.localData.length;
            break;
          case 'min':
            kpiValue = Math.min(...values);
            break;
          case 'max':
            kpiValue = Math.max(...values);
            break;
          case 'avg':
          default:
            kpiValue = values.reduce((a, b) => a + b, 0) / values.length;
        }

        const results = [{ label: config.title || 'Valeur', value: kpiValue }];
        renderKPI(config, kpiValue);
        generateCode(config, results);
        return;
      }

      // Aggregate data for charts
      const aggregated = {};
      const isMap = config.type === 'map';
      const codeField = config.codeField || config.labelField;

      state.localData.forEach(record => {
        const label = isMap
          ? (record[codeField] || 'N/A')
          : (record[config.labelField] || 'N/A');
        const value = parseFloat(record[config.valueField]) || 0;

        if (!aggregated[label]) {
          aggregated[label] = { values: [], count: 0, code: isMap ? record[codeField] : null };
        }
        aggregated[label].values.push(value);
        aggregated[label].count++;
      });

      let results = Object.entries(aggregated).map(([label, data]) => {
        let value;
        switch (config.aggregation) {
          case 'sum':
            value = data.values.reduce((a, b) => a + b, 0);
            break;
          case 'count':
            value = data.count;
            break;
          case 'min':
            value = Math.min(...data.values);
            break;
          case 'max':
            value = Math.max(...data.values);
            break;
          case 'avg':
          default:
            value = data.values.reduce((a, b) => a + b, 0) / data.values.length;
        }
        return { label, value, code: data.code };
      });

      // Sort
      results.sort((a, b) => {
        return config.sortOrder === 'asc' ? a.value - b.value : b.value - a.value;
      });

      // Limit
      const limit = config.limit || 10;
      results = results.slice(0, limit);

      // Render chart
      renderChart(config, results);

      // Generate code
      generateCode(config, results);
    }

    // Format KPI value
    function formatKPIValue(value, unit) {
      const num = Math.round(value * 100) / 100;
      if (unit === '‚Ç¨' || unit === 'EUR') {
        return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(num);
      } else if (unit === '%') {
        return new Intl.NumberFormat('fr-FR', { maximumFractionDigits: 1 }).format(num) + ' %';
      } else {
        const formatted = new Intl.NumberFormat('fr-FR', { maximumFractionDigits: 2 }).format(num);
        return unit ? `${formatted} ${unit}` : formatted;
      }
    }

    // Render KPI card
    function renderKPI(config, value) {
      const canvas = document.getElementById('preview-canvas');
      const emptyState = document.getElementById('empty-state');
      const chartWrapper = document.querySelector('.chart-wrapper');

      emptyState.style.display = 'none';
      canvas.style.display = 'none';

      if (state.chart) {
        state.chart.destroy();
        state.chart = null;
      }

      // Remove any existing KPI card
      const existingKpi = chartWrapper.querySelector('.kpi-card');
      if (existingKpi) existingKpi.remove();

      const variant = config.variant || '';
      const unit = config.unit || '';
      const formattedValue = formatKPIValue(value, unit);

      const kpiCard = document.createElement('div');
      kpiCard.className = `kpi-card${variant ? ' kpi-card--' + variant : ''}`;
      kpiCard.style.marginTop = '2rem';
      kpiCard.innerHTML = `
        <span class="kpi-value">${formattedValue}</span>
        <span class="kpi-label">${escapeHtml(config.title || 'Indicateur')}</span>
      `;
      chartWrapper.appendChild(kpiCard);
    }

    function renderChart(config, data) {
      const canvas = document.getElementById('preview-canvas');
      const emptyState = document.getElementById('empty-state');
      const chartWrapper = document.querySelector('.chart-wrapper');

      // Remove any existing KPI card, gauge card, or map card
      const existingKpi = chartWrapper.querySelector('.kpi-card');
      if (existingKpi) existingKpi.remove();
      const existingGauge = chartWrapper.querySelector('.gauge-card');
      if (existingGauge) existingGauge.remove();
      const existingMap = chartWrapper.querySelector('.map-card');
      if (existingMap) existingMap.remove();

      if (state.chart) {
        state.chart.destroy();
        state.chart = null;
      }

      // Handle gauge type specially (no Chart.js canvas)
      if (config.type === 'gauge') {
        canvas.style.display = 'none';
        emptyState.style.display = 'none';

        const gaugeValue = data[0]?.value || 0;
        const gaugeCard = document.createElement('div');
        gaugeCard.className = 'gauge-card';
        gaugeCard.innerHTML = `
          <div class="gauge-container">
            <svg viewBox="0 0 200 120" class="gauge-svg">
              <path d="M 20 100 A 80 80 0 0 1 180 100" fill="none" stroke="#e0e0e0" stroke-width="20" stroke-linecap="round"/>
              <path d="M 20 100 A 80 80 0 0 1 180 100" fill="none" stroke="${config.color || '#000091'}" stroke-width="20" stroke-linecap="round"
                    stroke-dasharray="${(gaugeValue / 100) * 251.2} 251.2"/>
            </svg>
            <div class="gauge-value">${Math.round(gaugeValue)}%</div>
            <div class="gauge-label">${escapeHtml(config.title || 'Jauge')}</div>
          </div>
        `;
        chartWrapper.appendChild(gaugeCard);
        return;
      }

      // Handle map type (uses DSFR map-chart)
      if (config.type === 'map') {
        canvas.style.display = 'none';
        emptyState.style.display = 'none';

        // Transform data to DSFR format: {"code": value, ...}
        const mapData = {};
        data.forEach(d => {
          const code = String(d.code || d.label || '').padStart(2, '0');
          const value = d.value || 0;
          if (code && code !== '00') {
            mapData[code] = Math.round(value * 100) / 100;
          }
        });

        const mapCard = document.createElement('div');
        mapCard.className = 'map-card';
        mapCard.innerHTML = `
          <map-chart
            data='${JSON.stringify(mapData)}'
            name="${escapeHtml(config.title || 'Carte')}"
            selected-palette="${config.palette || 'sequentialAscending'}"
          ></map-chart>
        `;
        chartWrapper.appendChild(mapCard);
        return;
      }

      emptyState.style.display = 'none';
      canvas.style.display = 'block';

      const labels = data.map(d => d.label);
      const values = data.map(d => Math.round(d.value * 100) / 100);

      // Handle scatter type
      if (config.type === 'scatter') {
        const scatterData = data.map(d => ({
          x: parseFloat(d.label) || 0,
          y: d.value
        }));

        state.chart = new Chart(canvas, {
          type: 'scatter',
          data: {
            datasets: [{
              label: config.valueField,
              data: scatterData,
              backgroundColor: config.color || '#000091',
              borderColor: config.color || '#000091',
              pointRadius: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            }
          }
        });
        return;
      }

      const chartType = config.type === 'horizontalBar' ? 'bar' : config.type;
      const isMultiColor = ['pie', 'doughnut', 'radar'].includes(config.type);

      // Build datasets array
      const datasets = [{
        label: config.valueField,
        data: values,
        backgroundColor: isMultiColor ? DSFR_COLORS.slice(0, data.length) : (config.color || '#000091'),
        borderColor: config.color || '#000091',
        borderWidth: config.type === 'line' ? 2 : 1
      }];

      // Handle multi-series (valueField2)
      if (config.valueField2 && config.data2 && config.data2.length > 0) {
        const values2 = config.data2.map(d => Math.round(d.value * 100) / 100);
        datasets.push({
          label: config.valueField2,
          data: values2,
          backgroundColor: config.color2 || '#E1000F',
          borderColor: config.color2 || '#E1000F',
          borderWidth: config.type === 'line' ? 2 : 1
        });
      }

      state.chart = new Chart(canvas, {
        type: chartType,
        data: {
          labels: labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: config.type === 'horizontalBar' ? 'y' : 'x',
          plugins: {
            legend: {
              display: isMultiColor || datasets.length > 1
            }
          }
        }
      });
    }

    function generateCode(config, data) {
      // Handle KPI type
      if (config.type === 'kpi') {
        const kpiValue = data[0]?.value || 0;
        const variant = config.variant || '';
        const unit = config.unit || '';

        // Si la source est une API, g√©n√©rer du code dynamique pour KPI
        if (state.source?.type === 'api' && state.source?.url) {
          const valueExpr = config.aggregation === 'count'
            ? 'count(*) as value'
            : `${config.aggregation}(${config.valueField}) as value`;

          const params = new URLSearchParams({
            select: valueExpr
          });

          const apiUrl = `${state.source.url}?${params}`;

          const code = `<!-- KPI g√©n√©r√© avec gouv-widgets Builder IA -->
<!-- Source API dynamique : les donn√©es se mettent √† jour automatiquement -->

<!-- D√©pendances CSS (DSFR) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/utility/utility.min.css">

<style>
.kpi-card {
  background: var(--background-default-grey);
  border-left: 4px solid var(--border-default-grey);
  padding: 1.5rem 2rem;
  text-align: center;
  border-radius: 4px;
}
.kpi-card--info { border-left-color: #0063CB; }
.kpi-card--success { border-left-color: #18753C; }
.kpi-card--warning { border-left-color: #D64D00; }
.kpi-card--error { border-left-color: #C9191E; }
.kpi-value { display: block; font-size: 2.5rem; font-weight: 700; color: var(--text-title-grey); }
.kpi-label { display: block; font-size: 0.875rem; color: var(--text-mention-grey); margin-top: 0.5rem; }
</style>

<div class="fr-container fr-my-4w">
  <div class="kpi-card${variant ? ' kpi-card--' + variant : ''}" id="kpi-container">
    <span class="kpi-value" id="kpi-value">‚Äî</span>
    <span class="kpi-label">${escapeHtml(config.title || 'Indicateur')}</span>
  </div>
</div>

<script>
// URL de l'API avec agr√©gation ODSQL
const API_URL = '${apiUrl}';

function formatKPIValue(value, unit) {
  const num = Math.round(value * 100) / 100;
  if (unit === '‚Ç¨' || unit === 'EUR') {
    return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(num);
  } else if (unit === '%') {
    return new Intl.NumberFormat('fr-FR', { maximumFractionDigits: 1 }).format(num) + ' %';
  } else {
    const formatted = new Intl.NumberFormat('fr-FR', { maximumFractionDigits: 2 }).format(num);
    return unit ? formatted + ' ' + unit : formatted;
  }
}

async function loadKPI() {
  try {
    const response = await fetch(API_URL);
    const json = await response.json();
    const data = json.results || [];
    const value = data[0]?.value || 0;
    document.getElementById('kpi-value').textContent = formatKPIValue(value, '${unit}');
  } catch (error) {
    console.error('Erreur chargement KPI:', error);
    document.getElementById('kpi-value').textContent = 'Erreur';
  }
}

loadKPI();
<\/script>`;

          document.getElementById('generated-code').textContent = code;
        } else {
          // Pour les sources non-API, g√©n√©rer du code avec valeur embarqu√©e
          const code = `<!-- KPI g√©n√©r√© avec gouv-widgets Builder IA -->
<!-- Source : ${state.source?.name || 'Donn√©es locales'} - valeur embarqu√©e -->

<!-- D√©pendances CSS (DSFR) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/utility/utility.min.css">

<style>
.kpi-card {
  background: var(--background-default-grey);
  border-left: 4px solid var(--border-default-grey);
  padding: 1.5rem 2rem;
  text-align: center;
  border-radius: 4px;
}
.kpi-card--info { border-left-color: #0063CB; }
.kpi-card--success { border-left-color: #18753C; }
.kpi-card--warning { border-left-color: #D64D00; }
.kpi-card--error { border-left-color: #C9191E; }
.kpi-value { display: block; font-size: 2.5rem; font-weight: 700; color: var(--text-title-grey); }
.kpi-label { display: block; font-size: 0.875rem; color: var(--text-mention-grey); margin-top: 0.5rem; }
</style>

<div class="fr-container fr-my-4w">
  <div class="kpi-card${variant ? ' kpi-card--' + variant : ''}">
    <span class="kpi-value">${formatKPIValue(kpiValue, unit)}</span>
    <span class="kpi-label">${escapeHtml(config.title || 'Indicateur')}</span>
  </div>
</div>`;

          document.getElementById('generated-code').textContent = code;
        }
        return;
      }

      // Handle gauge type
      if (config.type === 'gauge') {
        const gaugeValue = data[0]?.value || 0;
        const code = `<!-- Jauge g√©n√©r√©e avec gouv-widgets Builder IA -->
<!-- Source : ${state.source?.name || 'Donn√©es locales'} -->

<!-- D√©pendances CSS (DSFR) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/utility/utility.min.css">

<style>
.gauge-card {
  background: var(--background-default-grey);
  border-radius: 8px;
  padding: 2rem;
  text-align: center;
  display: inline-block;
}
.gauge-container { position: relative; width: 200px; }
.gauge-svg { width: 100%; height: auto; }
.gauge-value {
  position: absolute;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  font-size: 2rem;
  font-weight: 700;
  color: var(--text-title-grey);
}
.gauge-label {
  margin-top: 0.5rem;
  font-size: 0.875rem;
  color: var(--text-mention-grey);
}
</style>

<div class="fr-container fr-my-4w">
  <div class="gauge-card">
    <div class="gauge-container">
      <svg viewBox="0 0 200 120" class="gauge-svg">
        <path d="M 20 100 A 80 80 0 0 1 180 100" fill="none" stroke="#e0e0e0" stroke-width="20" stroke-linecap="round"/>
        <path d="M 20 100 A 80 80 0 0 1 180 100" fill="none" stroke="${config.color || '#000091'}" stroke-width="20" stroke-linecap="round"
              stroke-dasharray="${(gaugeValue / 100) * 251.2} 251.2"/>
      </svg>
      <div class="gauge-value">${Math.round(gaugeValue)}%</div>
      <div class="gauge-label">${escapeHtml(config.title || 'Jauge')}</div>
    </div>
  </div>
</div>`;

        document.getElementById('generated-code').textContent = code;
        return;
      }

      // Handle scatter type
      if (config.type === 'scatter') {
        const scatterData = data.map(d => ({ x: parseFloat(d.label) || 0, y: d.value }));
        const code = `<!-- Nuage de points g√©n√©r√© avec gouv-widgets Builder IA -->
<!-- Source : ${state.source?.name || 'Donn√©es locales'} -->

<!-- D√©pendances CSS (DSFR) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/utility/utility.min.css">

<!-- D√©pendances JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"><\/script>

<div class="fr-container fr-my-4w">
  <h2>${escapeHtml(config.title || 'Nuage de points')}</h2>
  ${config.subtitle ? `<p class="fr-text--sm fr-text--light">${escapeHtml(config.subtitle)}</p>` : ''}

  <div id="chart-container" style="height: 400px; position: relative;">
    <canvas id="myChart"></canvas>
  </div>
</div>

<script>
// Donn√©es embarqu√©es
const scatterData = ${JSON.stringify(scatterData, null, 2)};

new Chart(document.getElementById('myChart'), {
  type: 'scatter',
  data: {
    datasets: [{
      label: '${config.valueField}',
      data: scatterData,
      backgroundColor: '${config.color || '#000091'}',
      borderColor: '${config.color || '#000091'}',
      pointRadius: 6
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false
  }
});
<\/script>`;

        document.getElementById('generated-code').textContent = code;
        return;
      }

      // Handle map type
      if (config.type === 'map') {
        // Transform data to DSFR format: {"code": value, ...}
        const mapData = {};
        data.forEach(d => {
          const code = String(d.code || d.label || '').padStart(2, '0');
          const value = d.value || 0;
          if (code && code !== '00') {
            mapData[code] = Math.round(value * 100) / 100;
          }
        });

        // Si la source est une API, g√©n√©rer du code dynamique
        if (state.source?.type === 'api' && state.source?.url) {
          const valueExpr = config.aggregation === 'count'
            ? 'count(*) as value'
            : `${config.aggregation}(${config.valueField}) as value`;

          const params = new URLSearchParams({
            select: `${config.codeField}, ${valueExpr}`,
            group_by: config.codeField,
            limit: '200'  // Get all departments
          });

          const apiUrl = `${state.source.url}?${params}`;

          const code = `<!-- Carte g√©n√©r√©e avec gouv-widgets Builder IA -->
<!-- Source API dynamique : les donn√©es se mettent √† jour automatiquement -->

<!-- D√©pendances CSS (DSFR) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/utility/utility.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr-chart@2.0.4/dist/DSFRChart/DSFRChart.css">
<script type="module" src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr-chart@2.0.4/dist/DSFRChart/DSFRChart.js"><\/script>

<div class="fr-container fr-my-4w">
  <h2>${escapeHtml(config.title || 'Carte de France')}</h2>
  ${config.subtitle ? `<p class="fr-text--sm fr-text--light">${escapeHtml(config.subtitle)}</p>` : ''}
  <div id="map-container"></div>
</div>

<script type="module">
const API_URL = '${apiUrl}';

async function loadMap() {
  try {
    const response = await fetch(API_URL);
    const json = await response.json();
    const records = json.results || [];

    // Transformer les donn√©es en format carte: {"code": valeur, ...}
    const mapData = {};
    records.forEach(d => {
      const code = String(d['${config.codeField}'] || '').padStart(2, '0');
      const value = d.value || 0;
      if (code && code !== '00') {
        mapData[code] = Math.round(value * 100) / 100;
      }
    });

    document.getElementById('map-container').innerHTML = \`
      <map-chart
        data='\${JSON.stringify(mapData)}'
        name="${escapeHtml(config.title || 'Carte')}"
        selected-palette="${config.palette || 'sequentialAscending'}"
      ></map-chart>
    \`;
  } catch (error) {
    console.error('Erreur chargement carte:', error);
    document.getElementById('map-container').innerHTML = '<p class="fr-text--error">Erreur de chargement</p>';
  }
}

loadMap();
<\/script>`;

          document.getElementById('generated-code').textContent = code;
        } else {
          // Pour les sources non-API, g√©n√©rer du code avec donn√©es embarqu√©es
          const code = `<!-- Carte g√©n√©r√©e avec gouv-widgets Builder IA -->
<!-- Source : ${state.source?.name || 'Donn√©es locales'} -->

<!-- D√©pendances CSS (DSFR) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/utility/utility.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr-chart@2.0.4/dist/DSFRChart/DSFRChart.css">
<script type="module" src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr-chart@2.0.4/dist/DSFRChart/DSFRChart.js"><\/script>

<div class="fr-container fr-my-4w">
  <h2>${escapeHtml(config.title || 'Carte de France')}</h2>
  ${config.subtitle ? `<p class="fr-text--sm fr-text--light">${escapeHtml(config.subtitle)}</p>` : ''}
  <map-chart
    data='${JSON.stringify(mapData)}'
    name="${escapeHtml(config.title || 'Carte')}"
    selected-palette="${config.palette || 'sequentialAscending'}"
  ></map-chart>
</div>`;

          document.getElementById('generated-code').textContent = code;
        }
        return;
      }

      // Handle chart types
      const isMultiColor = ['pie', 'doughnut', 'radar'].includes(config.type);
      const colorsArray = JSON.stringify(DSFR_COLORS.slice(0, config.limit || 10));

      // Si la source est une API, g√©n√©rer du code dynamique
      if (state.source?.type === 'api' && state.source?.url) {
        // Construire l'URL avec les param√®tres ODSQL
        const valueExpr = config.aggregation === 'count'
          ? 'count(*) as value'
          : `${config.aggregation}(${config.valueField}) as value`;

        const params = new URLSearchParams({
          select: `${config.labelField}, ${valueExpr}`,
          group_by: config.labelField,
          order_by: `value ${config.sortOrder || 'desc'}`,
          limit: (config.limit || 10).toString()
        });

        const apiUrl = `${state.source.url}?${params}`;

        const code = `<!-- Graphique g√©n√©r√© avec gouv-widgets Builder IA -->
<!-- Source API dynamique : les donn√©es se mettent √† jour automatiquement -->

<!-- D√©pendances CSS (DSFR) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/utility/utility.min.css">

<!-- D√©pendances JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"><\/script>

<div class="fr-container fr-my-4w">
  <h2>${escapeHtml(config.title || 'Mon graphique')}</h2>
  ${config.subtitle ? `<p class="fr-text--sm fr-text--light">${escapeHtml(config.subtitle)}</p>` : ''}

  <div id="chart-container" style="height: 400px; position: relative;">
    <canvas id="myChart"></canvas>
  </div>

  <!-- Alternative accessible (RGAA) -->
  <details class="fr-accordion fr-mt-2w">
    <summary class="fr-accordion__btn">Voir les donn√©es en tableau</summary>
    <div class="fr-accordion__content">
      <table class="fr-table" id="data-table">
        <thead><tr><th>${escapeHtml(config.labelField)}</th><th>Valeur</th></tr></thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>
  </details>
</div>

<script>
// URL de l'API avec agr√©gation ODSQL
const API_URL = '${apiUrl}';

// Palette DSFR
const DSFR_COLORS = ${colorsArray};

async function loadChart() {
  try {
    const response = await fetch(API_URL);
    const json = await response.json();
    const data = json.results || [];

    const labels = data.map(d => d['${config.labelField}'] || 'N/A');
    const values = data.map(d => Math.round((d.value || 0) * 100) / 100);

    new Chart(document.getElementById('myChart'), {
      type: '${config.type === 'horizontalBar' ? 'bar' : config.type}',
      data: {
        labels: labels,
        datasets: [{
          label: '${config.valueField}',
          data: values,
          backgroundColor: ${isMultiColor ? 'DSFR_COLORS.slice(0, data.length)' : `'${config.color || '#000091'}'`},
          borderColor: '${config.color || '#000091'}',
          borderWidth: ${config.type === 'line' ? 2 : 1}
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false${config.type === 'horizontalBar' ? ",\n        indexAxis: 'y'" : ''},
        plugins: { legend: { display: ${isMultiColor} } }
      }
    });

    // Remplir le tableau accessible
    const tbody = document.getElementById('table-body');
    data.forEach(d => {
      const tr = document.createElement('tr');
      tr.innerHTML = '<td>' + (d['${config.labelField}'] || 'N/A') + '</td><td>' + (d.value?.toFixed(2) || '‚Äî') + '</td>';
      tbody.appendChild(tr);
    });
  } catch (error) {
    console.error('Erreur chargement donn√©es:', error);
    document.getElementById('chart-container').innerHTML = '<p class="fr-text--error">Erreur de chargement des donn√©es</p>';
  }
}

loadChart();
<\/script>`;

        document.getElementById('generated-code').textContent = code;
      } else {
        // Pour les sources non-API (Grist, manuel), g√©n√©rer du code avec donn√©es embarqu√©es
        const sourceName = state.source?.name || 'Donn√©es locales';
        const sourceType = state.source?.type === 'grist' ? 'Grist' : 'source manuelle';
        const hasSecondSeries = config.valueField2 && config.data2 && config.data2.length > 0;

        // Build datasets code
        let datasetsCode = `[{
      label: '${config.valueField}',
      data: values,
      backgroundColor: ${isMultiColor ? 'DSFR_COLORS.slice(0, data.length)' : `'${config.color || '#000091'}'`},
      borderColor: '${config.color || '#000091'}',
      borderWidth: ${config.type === 'line' ? 2 : 1}
    }`;

        if (hasSecondSeries) {
          datasetsCode += `, {
      label: '${config.valueField2}',
      data: values2,
      backgroundColor: '${config.color2 || '#E1000F'}',
      borderColor: '${config.color2 || '#E1000F'}',
      borderWidth: ${config.type === 'line' ? 2 : 1}
    }`;
        }
        datasetsCode += ']';

        const code = `<!-- Graphique g√©n√©r√© avec gouv-widgets Builder IA -->
<!-- Source : ${sourceName} (${sourceType}) - donn√©es embarqu√©es -->
${hasSecondSeries ? '<!-- Note: Graphique multi-s√©ries -->' : ''}

<!-- D√©pendances CSS (DSFR) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/utility/utility.min.css">

<!-- D√©pendances JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"><\/script>

<div class="fr-container fr-my-4w">
  <h2>${escapeHtml(config.title || 'Mon graphique')}</h2>
  ${config.subtitle ? `<p class="fr-text--sm fr-text--light">${escapeHtml(config.subtitle)}</p>` : ''}

  <div id="chart-container" style="height: 400px; position: relative;">
    <canvas id="myChart"></canvas>
  </div>
</div>

<script>
// Donn√©es embarqu√©es (depuis ${sourceType})
const data = ${JSON.stringify(data, null, 2)};
${hasSecondSeries ? `const data2 = ${JSON.stringify(config.data2, null, 2)};` : ''}

// Palette DSFR
const DSFR_COLORS = ${colorsArray};

const labels = data.map(d => d.label);
const values = data.map(d => Math.round(d.value * 100) / 100);
${hasSecondSeries ? 'const values2 = data2.map(d => Math.round(d.value * 100) / 100);' : ''}

new Chart(document.getElementById('myChart'), {
  type: '${config.type === 'horizontalBar' ? 'bar' : config.type}',
  data: {
    labels: labels,
    datasets: ${datasetsCode}
  },
  options: {
    responsive: true,
    maintainAspectRatio: false${config.type === 'horizontalBar' ? ",\n    indexAxis: 'y'" : ''},
    plugins: { legend: { display: ${hasSecondSeries || isMultiColor} } }
  }
});
<\/script>`;

        document.getElementById('generated-code').textContent = code;
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function copyCode() {
      const code = document.getElementById('generated-code').textContent;
      navigator.clipboard.writeText(code).then(() => {
        alert('Code copi√© dans le presse-papiers !');
      });
    }

    // ============================================================
    // RESIZER
    // ============================================================
    (function initResizer() {
      const resizer = document.getElementById('resizer');
      const leftPanel = document.querySelector('.builder-config');
      const container = document.querySelector('.builder-container');
      let isResizing = false;

      resizer.addEventListener('mousedown', (e) => {
        isResizing = true;
        resizer.classList.add('dragging');
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
      });

      document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        const containerRect = container.getBoundingClientRect();
        let newWidth = e.clientX - containerRect.left;
        newWidth = Math.max(280, Math.min(newWidth, containerRect.width - 300));
        leftPanel.style.width = newWidth + 'px';
      });

      document.addEventListener('mouseup', () => {
        if (isResizing) {
          isResizing = false;
          resizer.classList.remove('dragging');
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        }
      });
    })();

    // ============================================================
    // SECTIONS COLLAPSIBLES
    // ============================================================
    function toggleSection(sectionId) {
      const section = document.getElementById(sectionId);
      section.classList.toggle('collapsed');
    }
  </script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.module.min.js"></script>
</body>
</html>
