<!DOCTYPE html>
<html lang="fr" data-fr-theme>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>gouv-widgets ‚Äî G√©n√©rateur de graphiques</title>

  <!-- DSFR -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/utility/utility.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .builder-header {
      background: var(--background-alt-blue-france);
      padding: 1rem;
      border-bottom: 1px solid var(--border-default-grey);
    }

    .builder-header h1 {
      margin: 0;
      font-size: 1.25rem;
      color: var(--text-title-blue-france);
    }

    .builder-container {
      display: flex;
      flex: 1;
      min-height: 0;
    }

    .builder-config {
      width: 400px;
      min-width: 350px;
      overflow-y: auto;
      border-right: 1px solid var(--border-default-grey);
      background: var(--background-alt-grey);
    }

    .builder-preview {
      flex: 1;
      overflow: auto;
      padding: 1.5rem;
      background: var(--background-default-grey);
    }

    .config-section {
      padding: 1rem;
      border-bottom: 1px solid var(--border-default-grey);
    }

    .config-section h3 {
      margin: 0 0 1rem 0;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .config-section h3 .step-number {
      background: var(--background-action-high-blue-france);
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
    }

    .field-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
    }

    .field-item {
      background: var(--background-default-grey);
      padding: 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.15s;
    }

    .field-item:hover {
      border-color: var(--border-action-high-blue-france);
    }

    .field-item.selected {
      background: var(--background-contrast-info);
      border-color: var(--border-action-high-blue-france);
    }

    .field-item .field-name {
      font-weight: 600;
      display: block;
    }

    .field-item .field-type {
      color: var(--text-mention-grey);
      font-size: 0.7rem;
    }

    .chart-type-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
    }

    .chart-type-btn {
      background: var(--background-default-grey);
      border: 2px solid transparent;
      padding: 1rem 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      text-align: center;
      transition: all 0.15s;
    }

    .chart-type-btn:hover {
      border-color: var(--border-action-high-blue-france);
    }

    .chart-type-btn.selected {
      background: var(--background-contrast-info);
      border-color: var(--border-action-high-blue-france);
    }

    .chart-type-btn i {
      font-size: 1.5rem;
      display: block;
      margin-bottom: 0.25rem;
    }

    .chart-type-btn span {
      font-size: 0.75rem;
    }

    /* Sections collapsibles */
    .config-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      user-select: none;
    }

    .config-section-header:hover {
      opacity: 0.8;
    }

    .config-section-header .collapse-icon {
      transition: transform 0.2s;
      font-size: 1rem;
      color: var(--text-mention-grey);
    }

    .config-section.collapsed .collapse-icon {
      transform: rotate(-90deg);
    }

    .config-section-content {
      overflow: hidden;
      max-height: 1000px;
      transition: max-height 0.3s ease, padding 0.3s ease;
    }

    .config-section.collapsed .config-section-content {
      max-height: 0;
      padding-top: 0;
      padding-bottom: 0;
    }

    .config-section h3 {
      margin: 0;
    }

    .preview-chart {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
      position: sticky;
      top: 1rem;
    }

    .preview-chart h2 {
      margin: 0 0 0.5rem 0;
      font-size: 1.25rem;
    }

    .preview-chart .subtitle {
      color: var(--text-mention-grey);
      font-size: 0.875rem;
      margin-bottom: 1rem;
    }

    .chart-container {
      position: relative;
      height: 350px;
    }

    .code-output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 1rem;
      border-radius: 8px;
      font-family: monospace;
      font-size: 0.8rem;
      overflow-x: auto;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--text-mention-grey);
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .loading-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      background: var(--background-contrast-info);
      border-radius: 4px;
      font-size: 0.875rem;
    }

    .error-message {
      background: var(--background-contrast-error);
      color: var(--text-default-error);
      padding: 0.75rem;
      border-radius: 4px;
      font-size: 0.875rem;
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border-default-grey);
    }

    .tab-btn {
      padding: 0.75rem 1rem;
      border: none;
      background: none;
      cursor: pointer;
      font-weight: 500;
      color: var(--text-mention-grey);
      border-bottom: 2px solid transparent;
    }

    .tab-btn.active {
      color: var(--text-action-high-blue-france);
      border-bottom-color: var(--border-action-high-blue-france);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .aggregation-hint {
      font-size: 0.75rem;
      color: var(--text-mention-grey);
      margin-top: 0.25rem;
    }

    .source-type-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .source-type-tab {
      flex: 1;
      padding: 0.5rem;
      border: 1px solid var(--border-default-grey);
      background: var(--background-default-grey);
      cursor: pointer;
      font-size: 0.75rem;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
    }

    .source-type-tab:hover {
      background: var(--background-contrast-grey);
    }

    .source-type-tab.active {
      background: var(--background-contrast-info);
      border-color: var(--border-action-high-blue-france);
      font-weight: 600;
    }

    .source-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.125rem 0.5rem;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .source-badge-grist { background: #16a34a; color: white; }
    .source-badge-manual { background: #9333ea; color: white; }
    .source-badge-api { background: #2563eb; color: white; }

    /* Resizer */
    .resizer {
      width: 6px;
      background: var(--border-default-grey);
      cursor: col-resize;
      flex-shrink: 0;
      transition: background 0.15s;
    }
    .resizer:hover, .resizer.dragging {
      background: var(--border-action-high-blue-france);
    }

    /* KPI Cards */
    .kpi-card {
      background: var(--background-default-grey);
      border-left: 4px solid var(--border-default-grey);
      padding: 1.5rem 2rem;
      text-align: center;
      border-radius: 4px;
    }
    .kpi-card--info { border-left-color: #0063CB; }
    .kpi-card--success { border-left-color: #18753C; }
    .kpi-card--warning { border-left-color: #D64D00; }
    .kpi-card--error { border-left-color: #C9191E; }

    /* Gauge Card */
    .gauge-card {
      background: var(--background-default-grey);
      padding: 1.5rem;
      text-align: center;
      border-radius: 4px;
    }
    .gauge-container { position: relative; width: 150px; margin: 0 auto; }
    .gauge-svg { width: 100%; height: auto; }
    .gauge-fill { transition: stroke-dasharray 0.5s ease; }
    .gauge-value {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-title-grey);
    }
    .gauge-label {
      font-size: 0.875rem;
      color: var(--text-mention-grey);
      margin-top: 0.5rem;
    }

    .kpi-value {
      display: block;
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--text-title-grey);
      line-height: 1.2;
    }
    .kpi-label {
      font-size: 0.875rem;
      color: var(--text-mention-grey);
      margin-top: 0.5rem;
      display: block;
    }

    .kpi-config {
      display: none;
    }
    .kpi-config.visible {
      display: block;
    }

    @media (max-width: 900px) {
      .builder-container {
        flex-direction: column;
      }
      .builder-config {
        width: 100%;
        max-height: 50vh;
      }
      .resizer { display: none; }
    }
  </style>
</head>
<body>
  <!-- ============================================ -->
  <!-- HEADER DSFR -->
  <!-- ============================================ -->
  <header role="banner" class="fr-header">
    <div class="fr-header__body">
      <div class="fr-container">
        <div class="fr-header__body-row">
          <div class="fr-header__brand fr-enlarge-link">
            <div class="fr-header__brand-top">
              <div class="fr-header__logo">
                <p class="fr-logo">
                  R√©publique<br>Fran√ßaise
                </p>
              </div>
              <div class="fr-header__navbar">
                <button class="fr-btn--menu fr-btn" data-fr-opened="false" aria-controls="modal-menu" aria-haspopup="menu" id="button-menu" title="Menu">
                  Menu
                </button>
              </div>
            </div>
            <div class="fr-header__service">
              <a href="index.html" title="Accueil - gouv-widgets">
                <p class="fr-header__service-title">Charts builder</p>
              </a>
              <p class="fr-header__service-tagline">Cr√©ation de visualisations dynamiques conformes DSFR</p>
            </div>
          </div>
          <div class="fr-header__tools">
            <div class="fr-header__tools-links">
              <ul class="fr-btns-group">
                <li>
                  <a class="fr-btn fr-icon-github-fill" href="https://github.com/bmatge/datasource-charts-webcomponents" target="_blank" rel="noopener">
                    GitHub
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="fr-header__menu fr-modal" id="modal-menu" aria-labelledby="button-menu">
      <div class="fr-container">
        <button class="fr-btn--close fr-btn" aria-controls="modal-menu" title="Fermer">
          Fermer
        </button>
        <div class="fr-header__menu-links"></div>
        <nav class="fr-nav" id="header-navigation" role="navigation" aria-label="Menu principal">
          <ul class="fr-nav__list">
            <li class="fr-nav__item">
              <a class="fr-nav__link" href="index.html">Accueil</a>
            </li>
            <li class="fr-nav__item">
              <a class="fr-nav__link" href="demo/index.html">Composants</a>
            </li>
            <li class="fr-nav__item">
              <a class="fr-nav__link" href="builder.html" aria-current="page">Builder</a>
            </li>
            <li class="fr-nav__item">
              <a class="fr-nav__link" href="builderIA.html">Builder IA</a>
            </li>
            <li class="fr-nav__item">
              <a class="fr-nav__link" href="playground.html">Playground</a>
            </li>
            <li class="fr-nav__item">
              <a class="fr-nav__link" href="sources.html">Sources</a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </header>

  <div class="builder-container">
    <!-- ============================================ -->
    <!-- PANNEAU DE CONFIGURATION -->
    <!-- ============================================ -->
    <aside class="builder-config">

      <!-- √âTAPE 1 : Source de donn√©es -->
      <div class="config-section" id="section-source">
        <div class="config-section-header" onclick="toggleSection('section-source')">
          <h3><span class="step-number">1</span> Source de donn√©es</h3>
          <i class="ri-arrow-down-s-line collapse-icon"></i>
        </div>
        <div class="config-section-content">

        <!-- Onglets de type de source -->
        <div class="source-type-tabs">
          <button class="source-type-tab active" data-source-type="api">
            <i class="ri-cloud-line"></i> API publique
          </button>
          <button class="source-type-tab" data-source-type="saved">
            <i class="ri-database-2-line"></i> Mes sources
          </button>
        </div>

        <!-- Panel API publique -->
        <div id="source-panel-api" class="source-panel">
          <div class="fr-select-group fr-select-group--sm fr-mt-1w">
            <label class="fr-label" for="preset-api">API pr√©d√©finie</label>
            <select class="fr-select" id="preset-api">
              <option value="">‚Äî Choisir une API ‚Äî</option>
              <option value="controle-technique">Prix contr√¥le technique (economie.gouv.fr)</option>
              <option value="resultats-elections">R√©sultats √©lections (data.gouv.fr)</option>
              <option value="qualite-air">Qualit√© de l'air (geodair)</option>
              <option value="custom">URL personnalis√©e...</option>
            </select>
          </div>

          <div class="fr-input-group fr-input-group--sm fr-mt-1w" id="custom-url-group" style="display: none;">
            <label class="fr-label" for="api-url">URL de l'API (OpenDataSoft v2.1)</label>
            <input class="fr-input" type="url" id="api-url" placeholder="https://...">
          </div>
        </div>

        <!-- Panel Mes sources (Grist / Manuel) -->
        <div id="source-panel-saved" class="source-panel" style="display: none;">
          <div class="fr-select-group fr-select-group--sm fr-mt-1w">
            <label class="fr-label" for="saved-source">Source enregistr√©e</label>
            <select class="fr-select" id="saved-source">
              <option value="">‚Äî Choisir une source ‚Äî</option>
            </select>
          </div>

          <div id="saved-source-info" class="fr-mt-1w" style="font-size: 0.8rem; color: var(--text-mention-grey);"></div>

          <a href="sources.html" class="fr-link fr-link--sm fr-mt-1w" style="display: inline-block;">
            <i class="ri-add-line"></i> Ajouter une nouvelle source
          </a>
        </div>

        <button class="fr-btn fr-btn--sm fr-btn--secondary fr-mt-2w" id="load-fields-btn">
          <i class="ri-refresh-line"></i> Charger les champs
        </button>

        <div id="fields-status" class="fr-mt-1w"></div>
        </div>
      </div>

      <!-- √âTAPE 1.5 : Mode de g√©n√©ration (visible si source Grist) -->
      <div class="config-section" id="section-generation-mode" style="display: none;">
        <div class="config-section-header" onclick="toggleSection('section-generation-mode')">
          <h3><span class="step-number">1.5</span> Mode de g√©n√©ration</h3>
          <i class="ri-arrow-down-s-line collapse-icon"></i>
        </div>
        <div class="config-section-content">
          <div class="fr-radio-group">
            <input type="radio" id="mode-embedded" name="generation-mode" value="embedded" checked>
            <label class="fr-label" for="mode-embedded">
              Donn√©es int√©gr√©es
              <span class="fr-hint-text">Les donn√©es sont copi√©es dans le code HTML</span>
            </label>
          </div>
          <div class="fr-radio-group fr-mt-1w">
            <input type="radio" id="mode-dynamic" name="generation-mode" value="dynamic">
            <label class="fr-label" for="mode-dynamic">
              Chargement dynamique
              <span class="fr-hint-text">Utilise &lt;gouv-source&gt; et &lt;gouv-chart&gt; pour charger les donn√©es en temps r√©el</span>
            </label>
          </div>

          <div id="dynamic-options" class="fr-mt-2w" style="display: none;">
            <div class="fr-input-group fr-input-group--sm">
              <label class="fr-label" for="refresh-interval">
                Rafra√Æchissement automatique
                <span class="fr-hint-text">En secondes (0 = pas de rafra√Æchissement)</span>
              </label>
              <input class="fr-input" type="number" id="refresh-interval" value="0" min="0" max="3600">
            </div>
          </div>

          <div id="dynamic-warning" class="fr-alert fr-alert--warning fr-alert--sm fr-mt-2w" style="display: none;">
            <p>Ce document Grist n'est pas public. Le code g√©n√©r√© ne fonctionnera que si le document est rendu public dans Grist.</p>
          </div>
        </div>
      </div>

      <!-- √âTAPE 2 : Type de graphique -->
      <div class="config-section" id="section-type">
        <div class="config-section-header" onclick="toggleSection('section-type')">
          <h3><span class="step-number">2</span> Type de graphique</h3>
          <i class="ri-arrow-down-s-line collapse-icon"></i>
        </div>
        <div class="config-section-content">

        <div class="chart-type-grid">
          <button class="chart-type-btn selected" data-type="bar">
            <i class="ri-bar-chart-fill"></i>
            <span>Barres</span>
          </button>
          <button class="chart-type-btn" data-type="horizontalBar">
            <i class="ri-bar-chart-horizontal-fill"></i>
            <span>Barres H</span>
          </button>
          <button class="chart-type-btn" data-type="line">
            <i class="ri-line-chart-fill"></i>
            <span>Lignes</span>
          </button>
          <button class="chart-type-btn" data-type="pie">
            <i class="ri-pie-chart-fill"></i>
            <span>Camembert</span>
          </button>
          <button class="chart-type-btn" data-type="doughnut">
            <i class="ri-donut-chart-fill"></i>
            <span>Anneau</span>
          </button>
          <button class="chart-type-btn" data-type="radar">
            <i class="ri-radar-fill"></i>
            <span>Radar</span>
          </button>
          <button class="chart-type-btn" data-type="scatter">
            <i class="ri-bubble-chart-fill"></i>
            <span>Nuage</span>
          </button>
          <button class="chart-type-btn" data-type="gauge">
            <i class="ri-speed-fill"></i>
            <span>Jauge</span>
          </button>
          <button class="chart-type-btn" data-type="kpi">
            <i class="ri-numbers-fill"></i>
            <span>KPI</span>
          </button>
        </div>
        </div>
      </div>

      <!-- √âTAPE 3 : Mapping des donn√©es -->
      <div class="config-section" id="section-data">
        <div class="config-section-header" onclick="toggleSection('section-data')">
          <h3><span class="step-number">3</span> Configuration des donn√©es</h3>
          <i class="ri-arrow-down-s-line collapse-icon"></i>
        </div>
        <div class="config-section-content">

        <div class="fr-select-group fr-select-group--sm">
          <label class="fr-label" for="label-field">
            Axe X / Cat√©gories
            <span class="fr-hint-text">Le champ utilis√© pour les labels</span>
          </label>
          <select class="fr-select" id="label-field">
            <option value="">‚Äî Charger les champs d'abord ‚Äî</option>
          </select>
        </div>

        <div class="fr-select-group fr-select-group--sm fr-mt-1w">
          <label class="fr-label" for="value-field">
            Axe Y / Valeurs (S√©rie 1)
            <span class="fr-hint-text">Le champ num√©rique √† mesurer</span>
          </label>
          <select class="fr-select" id="value-field">
            <option value="">‚Äî Charger les champs d'abord ‚Äî</option>
          </select>
        </div>

        <div class="fr-select-group fr-select-group--sm fr-mt-1w" id="value-field-2-group" style="display: none;">
          <label class="fr-label" for="value-field-2">
            S√©rie 2 (optionnel)
            <span class="fr-hint-text">Second champ pour comparaison</span>
          </label>
          <select class="fr-select" id="value-field-2">
            <option value="">‚Äî Aucune (s√©rie unique) ‚Äî</option>
          </select>
        </div>

        <div class="fr-select-group fr-select-group--sm fr-mt-1w">
          <label class="fr-label" for="aggregation">
            Agr√©gation
            <span class="fr-hint-text">Comment regrouper les valeurs</span>
          </label>
          <select class="fr-select" id="aggregation">
            <option value="avg">Moyenne (avg)</option>
            <option value="sum">Somme (sum)</option>
            <option value="count">Comptage (count)</option>
            <option value="min">Minimum (min)</option>
            <option value="max">Maximum (max)</option>
          </select>
        </div>

        <div class="fr-input-group fr-input-group--sm fr-mt-1w">
          <label class="fr-label" for="limit">Nombre de r√©sultats</label>
          <input class="fr-input" type="number" id="limit" value="10" min="1" max="100">
        </div>

        <div class="fr-select-group fr-select-group--sm fr-mt-1w">
          <label class="fr-label" for="sort-order">Tri</label>
          <select class="fr-select" id="sort-order">
            <option value="desc">D√©croissant (plus grand en premier)</option>
            <option value="asc">Croissant (plus petit en premier)</option>
          </select>
        </div>
        </div>
      </div>

      <!-- √âTAPE 4 : Apparence -->
      <div class="config-section" id="section-appearance">
        <div class="config-section-header" onclick="toggleSection('section-appearance')">
          <h3><span class="step-number">4</span> Apparence</h3>
          <i class="ri-arrow-down-s-line collapse-icon"></i>
        </div>
        <div class="config-section-content">

        <div class="fr-input-group fr-input-group--sm">
          <label class="fr-label" for="chart-title">Titre du graphique</label>
          <input class="fr-input" type="text" id="chart-title" value="Mon graphique" placeholder="Titre...">
        </div>

        <div class="fr-input-group fr-input-group--sm fr-mt-1w">
          <label class="fr-label" for="chart-subtitle">Sous-titre / Source</label>
          <input class="fr-input" type="text" id="chart-subtitle" value="" placeholder="Source : ...">
        </div>

        <div class="fr-select-group fr-select-group--sm fr-mt-1w" id="palette-config">
          <label class="fr-label" for="chart-palette">Palette de couleurs</label>
          <select class="fr-select" id="chart-palette">
            <option value="default">Par d√©faut (Bleu France)</option>
            <option value="categorical">Cat√©gorielle (comparaison de groupes)</option>
            <option value="sequentialAscending">S√©quentielle croissante</option>
            <option value="sequentialDescending">S√©quentielle d√©croissante</option>
            <option value="divergentAscending">Divergente croissante</option>
            <option value="divergentDescending">Divergente d√©croissante</option>
            <option value="neutral">Neutre</option>
          </select>
        </div>

        <!-- Options sp√©cifiques KPI -->
        <div class="kpi-config" id="kpi-config">
          <div class="fr-select-group fr-select-group--sm fr-mt-1w">
            <label class="fr-label" for="kpi-variant">Style du KPI</label>
            <select class="fr-select" id="kpi-variant">
              <option value="">Par d√©faut (gris)</option>
              <option value="info">Information (bleu)</option>
              <option value="success">Succ√®s (vert)</option>
              <option value="warning">Attention (orange)</option>
              <option value="error">Alerte (rouge)</option>
            </select>
          </div>
          <div class="fr-input-group fr-input-group--sm fr-mt-1w">
            <label class="fr-label" for="kpi-unit">Unit√© (optionnel)</label>
            <input class="fr-input" type="text" id="kpi-unit" placeholder="‚Ç¨, %, unit√©s...">
          </div>
        </div>
        </div>
      </div>

      <!-- BOUTON G√âN√âRER -->
      <div class="config-section">
        <button class="fr-btn fr-btn--icon-left" id="generate-btn" style="width: 100%;">
          <i class="ri-play-fill"></i> G√©n√©rer le graphique
        </button>
      </div>

    </aside>

    <!-- Resizer -->
    <div class="resizer" id="resizer"></div>

    <!-- ============================================ -->
    <!-- PANNEAU DE PR√âVISUALISATION -->
    <!-- ============================================ -->
    <main class="builder-preview">

      <div class="tabs">
        <button class="tab-btn active" data-tab="preview">Aper√ßu</button>
        <button class="tab-btn" data-tab="code">Code g√©n√©r√©</button>
        <button class="tab-btn" data-tab="data">Donn√©es brutes</button>
      </div>

      <!-- Onglet Aper√ßu -->
      <div class="tab-content active" id="tab-preview">
        <div class="preview-chart">
          <h2 id="preview-title">Mon graphique</h2>
          <p class="subtitle" id="preview-subtitle"></p>
          <div class="chart-container">
            <div class="empty-state" id="empty-state">
              <i class="ri-bar-chart-box-line"></i>
              <p>Configurez votre graphique et cliquez sur "G√©n√©rer"</p>
            </div>
            <canvas id="preview-canvas" style="display: none;"></canvas>
          </div>
        </div>

        <!-- Tableau accessible -->
        <details class="fr-accordion">
          <summary class="fr-accordion__btn">Donn√©es en tableau (accessibilit√© RGAA)</summary>
          <div class="fr-accordion__content">
            <table class="fr-table" id="accessible-table">
              <thead><tr><th>Cat√©gorie</th><th>Valeur</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </details>
      </div>

      <!-- Onglet Code -->
      <div class="tab-content" id="tab-code">
        <p class="fr-text--sm">Copiez ce code pour l'int√©grer dans votre page :</p>
        <button class="fr-btn fr-btn--sm fr-btn--secondary fr-mb-1w" id="copy-code-btn">
          <i class="ri-file-copy-line"></i> Copier le code
        </button>
        <pre class="code-output" id="generated-code">// Le code sera g√©n√©r√© ici...</pre>
      </div>

      <!-- Onglet Donn√©es -->
      <div class="tab-content" id="tab-data">
        <p class="fr-text--sm">Donn√©es brutes re√ßues de l'API :</p>
        <pre class="code-output" id="raw-data">// Chargez d'abord les donn√©es...</pre>
      </div>

    </main>
  </div>

  <script>
    // ============================================================
    // CONFIGURATION DES APIs PR√âD√âFINIES
    // ============================================================
    const API_PRESETS = {
      'controle-technique': {
        base: 'https://data.economie.gouv.fr/api/explore/v2.1/catalog/datasets/prix-controle-technique/records',
        name: 'Prix du contr√¥le technique',
        defaultTitle: 'Prix moyen du contr√¥le technique',
        defaultSubtitle: 'Source : data.economie.gouv.fr'
      },
      'resultats-elections': {
        base: 'https://www.data.gouv.fr/api/1/datasets/5c5c5c5c5c5c5c5c5c5c5c5c',
        name: 'R√©sultats √©lections',
        defaultTitle: 'R√©sultats √©lectoraux',
        defaultSubtitle: 'Source : data.gouv.fr'
      },
      'qualite-air': {
        base: 'https://services9.arcgis.com/7Sr9Ek9c1QTKmbwr/arcgis/rest/services',
        name: 'Qualit√© de l\'air',
        defaultTitle: 'Indice de qualit√© de l\'air',
        defaultSubtitle: 'Source : geodair'
      }
    };

    // Palettes DSFR Chart - correspondance avec les couleurs Chart.js
    const DSFR_COLORS = [
      '#000091', '#6A6AF4', '#009081', '#C9191E', '#FF9940',
      '#A558A0', '#417DC4', '#716043', '#18753C', '#3A3A3A'
    ];

    // Couleur principale par palette (pour graphiques mono-couleur)
    const PALETTE_PRIMARY_COLOR = {
      'default': '#000091',           // Bleu France
      'categorical': '#000091',       // Bleu France (couleurs multiples pour multi-valeurs)
      'sequentialAscending': '#000091',
      'sequentialDescending': '#6A6AF4',
      'divergentAscending': '#000091',
      'divergentDescending': '#C9191E',
      'neutral': '#3A3A3A'
    };

    // Couleurs multiples par palette (pour pie, doughnut, radar)
    const PALETTE_COLORS = {
      'default': ['#000091', '#6A6AF4', '#9A9AFF', '#CACAFB', '#E5E5F4'],
      'categorical': ['#000091', '#6A6AF4', '#009081', '#C9191E', '#FF9940', '#A558A0', '#417DC4', '#716043', '#18753C', '#3A3A3A'],
      'sequentialAscending': ['#E5E5F4', '#CACAFB', '#9A9AFF', '#6A6AF4', '#000091'],
      'sequentialDescending': ['#000091', '#6A6AF4', '#9A9AFF', '#CACAFB', '#E5E5F4'],
      'divergentAscending': ['#000091', '#6A6AF4', '#F5F5F5', '#FF9940', '#C9191E'],
      'divergentDescending': ['#C9191E', '#FF9940', '#F5F5F5', '#6A6AF4', '#000091'],
      'neutral': ['#161616', '#3A3A3A', '#666666', '#929292', '#CECECE']
    };

    // ============================================================
    // √âTAT DE L'APPLICATION
    // ============================================================
    let state = {
      sourceType: 'api',  // 'api' ou 'saved'
      apiUrl: '',
      savedSource: null,
      localData: null,
      fields: [],
      chartType: 'bar',
      labelField: '',
      valueField: '',
      valueField2: '',  // Pour les s√©ries multiples
      aggregation: 'avg',
      limit: 10,
      sortOrder: 'desc',
      title: 'Mon graphique',
      subtitle: '',
      palette: 'default',  // Palette DSFR Chart
      color2: '#E1000F',  // Couleur s√©rie 2
      data: [],
      data2: [],  // Donn√©es s√©rie 2
      chartInstance: null,
      // Mode de g√©n√©ration
      generationMode: 'embedded',  // 'embedded' ou 'dynamic'
      refreshInterval: 0
    };

    // ============================================================
    // INITIALISATION
    // ============================================================
    document.addEventListener('DOMContentLoaded', () => {
      // Tabs
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => switchTab(btn.dataset.tab));
      });

      // Source type tabs (API vs Saved sources)
      document.querySelectorAll('.source-type-tab').forEach(btn => {
        btn.addEventListener('click', () => switchSourceType(btn.dataset.sourceType));
      });

      // Preset API
      document.getElementById('preset-api').addEventListener('change', handlePresetChange);

      // Saved sources dropdown
      document.getElementById('saved-source').addEventListener('change', handleSavedSourceChange);

      // Chart type
      document.querySelectorAll('.chart-type-btn').forEach(btn => {
        btn.addEventListener('click', () => selectChartType(btn.dataset.type));
      });

      // Palette selector
      document.getElementById('chart-palette').addEventListener('change', (e) => {
        state.palette = e.target.value;
      });

      // Buttons
      document.getElementById('load-fields-btn').addEventListener('click', loadFields);
      document.getElementById('generate-btn').addEventListener('click', generateChart);
      document.getElementById('copy-code-btn').addEventListener('click', copyCode);

      // Input changes
      document.getElementById('chart-title').addEventListener('input', (e) => {
        state.title = e.target.value;
        document.getElementById('preview-title').textContent = e.target.value;
      });

      document.getElementById('chart-subtitle').addEventListener('input', (e) => {
        state.subtitle = e.target.value;
        document.getElementById('preview-subtitle').textContent = e.target.value;
      });

      // Generation mode radio buttons
      document.querySelectorAll('input[name="generation-mode"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          state.generationMode = e.target.value;
          document.getElementById('dynamic-options').style.display =
            e.target.value === 'dynamic' ? 'block' : 'none';
        });
      });

      document.getElementById('refresh-interval').addEventListener('input', (e) => {
        state.refreshInterval = parseInt(e.target.value) || 0;
      });

      // Load saved sources and check for selected source from sources.html
      loadSavedSources();
      checkSelectedSource();
    });

    // ============================================================
    // FONCTIONS UTILITAIRES
    // ============================================================
    function switchTab(tabId) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
      document.getElementById(`tab-${tabId}`).classList.add('active');
    }

    // ============================================================
    // GESTION DES SOURCES SAUVEGARD√âES
    // ============================================================
    function switchSourceType(type) {
      document.querySelectorAll('.source-type-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-source-type="${type}"]`).classList.add('active');

      document.getElementById('source-panel-api').style.display = type === 'api' ? 'block' : 'none';
      document.getElementById('source-panel-saved').style.display = type === 'saved' ? 'block' : 'none';

      state.sourceType = type;
    }

    function loadSavedSources() {
      const select = document.getElementById('saved-source');
      select.innerHTML = '<option value="">‚Äî Choisir une source ‚Äî</option>';

      // Load from localStorage
      const sources = JSON.parse(localStorage.getItem('gouv_widgets_sources') || '[]');
      const selectedSource = JSON.parse(localStorage.getItem('gouv_widgets_selected_source') || 'null');

      // Add saved sources
      sources.forEach(source => {
        const option = document.createElement('option');
        option.value = source.id;
        const badge = source.type === 'grist' ? 'üü¢ Grist' : source.type === 'manual' ? 'üü£ Manuel' : 'üîµ API';
        option.textContent = `${badge} ${source.name}`;
        option.dataset.source = JSON.stringify(source);
        select.appendChild(option);
      });

      // If we have a selected source from sources.html, add it too if not already there
      if (selectedSource && !sources.find(s => s.id === selectedSource.id)) {
        const option = document.createElement('option');
        option.value = selectedSource.id;
        const badge = selectedSource.type === 'grist' ? 'üü¢ Grist' : selectedSource.type === 'manual' ? 'üü£ Manuel' : 'üîµ API';
        option.textContent = `${badge} ${selectedSource.name} (r√©cent)`;
        option.dataset.source = JSON.stringify(selectedSource);
        option.selected = true;
        select.appendChild(option);
      }
    }

    function checkSelectedSource() {
      const selectedSource = JSON.parse(localStorage.getItem('gouv_widgets_selected_source') || 'null');

      if (selectedSource && selectedSource.data && selectedSource.data.length > 0) {
        // Switch to saved sources tab
        switchSourceType('saved');

        // Select the source
        const select = document.getElementById('saved-source');
        for (const option of select.options) {
          if (option.value === selectedSource.id) {
            option.selected = true;
            break;
          }
        }

        // Trigger the change
        handleSavedSourceChange();

        // Show notification
        document.getElementById('fields-status').innerHTML = `
          <div class="fr-badge fr-badge--success fr-badge--sm">
            Source "${selectedSource.name}" charg√©e automatiquement
          </div>
        `;
      }
    }

    function handleSavedSourceChange() {
      const select = document.getElementById('saved-source');
      const selectedOption = select.options[select.selectedIndex];
      const infoEl = document.getElementById('saved-source-info');

      if (!selectedOption || !selectedOption.dataset.source) {
        infoEl.innerHTML = '';
        return;
      }

      const source = JSON.parse(selectedOption.dataset.source);
      state.savedSource = source;

      // Show info
      const badge = source.type === 'grist' ? 'source-badge-grist' : source.type === 'manual' ? 'source-badge-manual' : 'source-badge-api';
      const badgeText = source.type === 'grist' ? 'Grist' : source.type === 'manual' ? 'Manuel' : 'API';

      infoEl.innerHTML = `
        <span class="source-badge ${badge}">${badgeText}</span>
        ${source.recordCount || '?'} enregistrements
      `;

      // If it has local data, load fields directly
      if (source.data && source.data.length > 0) {
        state.localData = source.data;
        loadFieldsFromLocalData();
      }
    }

    function loadFieldsFromLocalData() {
      if (!state.localData || state.localData.length === 0) return;

      const source = state.savedSource;
      const record = state.localData[0];

      // Check if this is Grist data with raw records
      if (source?.type === 'grist' && source.rawRecords && source.rawRecords.length > 0) {
        const rawRecord = source.rawRecords[0];
        if (rawRecord && rawRecord.fields) {
          // Use Grist field structure with "fields." prefix for dynamic mode
          state.fields = Object.keys(rawRecord.fields).map(key => ({
            name: key,
            fullPath: `fields.${key}`,
            displayName: key,
            type: typeof rawRecord.fields[key],
            sample: rawRecord.fields[key]
          }));
        }
      } else {
        // Flat data structure
        state.fields = Object.keys(record).map(key => ({
          name: key,
          fullPath: key,
          displayName: key,
          type: typeof record[key],
          sample: record[key]
        }));
      }

      populateFieldSelects();

      // Show/hide generation mode section based on source type
      const generationModeSection = document.getElementById('section-generation-mode');
      const dynamicWarning = document.getElementById('dynamic-warning');

      if (source?.type === 'grist') {
        generationModeSection.style.display = 'block';
        // Show warning if not public
        dynamicWarning.style.display = source.isPublic ? 'none' : 'block';
      } else {
        generationModeSection.style.display = 'none';
      }

      document.getElementById('fields-status').innerHTML = `
        <div class="fr-badge fr-badge--success fr-badge--sm">${state.fields.length} champs trouv√©s</div>
      `;
    }

    function handlePresetChange(e) {
      const preset = e.target.value;
      const customGroup = document.getElementById('custom-url-group');

      if (preset === 'custom') {
        customGroup.style.display = 'block';
        state.apiUrl = '';
      } else if (preset && API_PRESETS[preset]) {
        customGroup.style.display = 'none';
        state.apiUrl = API_PRESETS[preset].base;
        document.getElementById('chart-title').value = API_PRESETS[preset].defaultTitle;
        document.getElementById('chart-subtitle').value = API_PRESETS[preset].defaultSubtitle;
        state.title = API_PRESETS[preset].defaultTitle;
        state.subtitle = API_PRESETS[preset].defaultSubtitle;
        document.getElementById('preview-title').textContent = state.title;
        document.getElementById('preview-subtitle').textContent = state.subtitle;

        // Auto-load fields
        loadFields();
      } else {
        customGroup.style.display = 'none';
      }
    }

    function selectChartType(type) {
      document.querySelectorAll('.chart-type-btn').forEach(b => b.classList.remove('selected'));
      document.querySelector(`[data-type="${type}"]`).classList.add('selected');
      state.chartType = type;

      // Toggle KPI-specific options
      const isKPI = type === 'kpi';
      const isGauge = type === 'gauge';
      const isScatter = type === 'scatter';
      document.getElementById('kpi-config').classList.toggle('visible', isKPI);
      document.getElementById('color-config').style.display = (isKPI || isGauge) ? 'none' : 'block';

      // KPIs and gauges don't need label field or limit (they show a single value)
      const hideLabels = isKPI || isGauge;
      document.getElementById('label-field').closest('.fr-select-group').style.display = hideLabels ? 'none' : 'block';
      document.getElementById('limit').closest('.fr-input-group').style.display = hideLabels ? 'none' : 'block';
      document.getElementById('sort-order').closest('.fr-select-group').style.display = hideLabels ? 'none' : 'block';

      // Types that support multiple series: bar, horizontalBar, line, radar
      const supportsMultiSeries = ['bar', 'horizontalBar', 'line', 'radar'].includes(type);
      document.getElementById('value-field-2-group').style.display = supportsMultiSeries ? 'block' : 'none';
      if (!supportsMultiSeries) {
        state.valueField2 = '';
        document.getElementById('value-field-2').value = '';
      }

      // Scatter needs X and Y numeric fields (different labels)
      if (isScatter) {
        document.querySelector('label[for="label-field"]').innerHTML = 'Axe X (num√©rique)<span class="fr-hint-text">Valeurs horizontales</span>';
        document.querySelector('label[for="value-field"]').innerHTML = 'Axe Y (num√©rique)<span class="fr-hint-text">Valeurs verticales</span>';
      } else {
        document.querySelector('label[for="label-field"]').innerHTML = 'Axe X / Cat√©gories<span class="fr-hint-text">Le champ utilis√© pour les labels</span>';
        document.querySelector('label[for="value-field"]').innerHTML = 'Axe Y / Valeurs (S√©rie 1)<span class="fr-hint-text">Le champ num√©rique √† mesurer</span>';
      }
    }

    // ============================================================
    // CHARGEMENT DES CHAMPS DEPUIS L'API
    // ============================================================
    async function loadFields() {
      const statusEl = document.getElementById('fields-status');

      // Check if we're using saved source with local data
      if (state.sourceType === 'saved' && state.localData && state.localData.length > 0) {
        loadFieldsFromLocalData();
        return;
      }

      // Get URL for API mode
      if (document.getElementById('preset-api').value === 'custom') {
        state.apiUrl = document.getElementById('api-url').value;
      }

      if (!state.apiUrl) {
        statusEl.innerHTML = '<div class="error-message">Veuillez s√©lectionner une API ou une source</div>';
        return;
      }

      statusEl.innerHTML = '<div class="loading-indicator"><i class="ri-loader-4-line"></i> Chargement...</div>';

      try {
        // Fetch one record to get field names
        const url = state.apiUrl + '?limit=1';
        const response = await fetch(url);

        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const json = await response.json();

        if (!json.results || json.results.length === 0) {
          throw new Error('Aucune donn√©e trouv√©e');
        }

        // Extract fields from first record
        const record = json.results[0];
        state.fields = Object.keys(record).map(key => ({
          name: key,
          type: typeof record[key],
          sample: record[key]
        }));

        // Populate dropdowns
        populateFieldSelects();

        statusEl.innerHTML = `<div class="fr-badge fr-badge--success fr-badge--sm">${state.fields.length} champs trouv√©s</div>`;

      } catch (error) {
        console.error(error);
        statusEl.innerHTML = `<div class="error-message">Erreur : ${error.message}</div>`;
      }
    }

    function populateFieldSelects() {
      const labelSelect = document.getElementById('label-field');
      const valueSelect = document.getElementById('value-field');
      const valueSelect2 = document.getElementById('value-field-2');

      // Clear
      labelSelect.innerHTML = '<option value="">‚Äî S√©lectionner ‚Äî</option>';
      valueSelect.innerHTML = '<option value="">‚Äî S√©lectionner ‚Äî</option>';
      valueSelect2.innerHTML = '<option value="">‚Äî Aucune (s√©rie unique) ‚Äî</option>';

      state.fields.forEach(field => {
        const displayText = field.displayName
          ? `${field.displayName} (${field.type})`
          : `${field.name} (${field.type})`;

        const optionLabel = document.createElement('option');
        optionLabel.value = field.name;
        optionLabel.textContent = displayText;
        labelSelect.appendChild(optionLabel);

        const optionValue = document.createElement('option');
        optionValue.value = field.name;
        optionValue.textContent = displayText;
        valueSelect.appendChild(optionValue);

        // Only add numeric fields to serie 2
        if (field.type === 'number') {
          const optionValue2 = document.createElement('option');
          optionValue2.value = field.name;
          optionValue2.textContent = displayText;
          valueSelect2.appendChild(optionValue2);
        }
      });

      // Auto-select good candidates
      const fieldNameLower = f => (f.displayName || f.name).toLowerCase();
      const stringField = state.fields.find(f =>
        f.type === 'string' && (fieldNameLower(f).includes('nom') || fieldNameLower(f).includes('region') || fieldNameLower(f).includes('departement') || fieldNameLower(f).includes('label'))
      );
      const numberField = state.fields.find(f =>
        f.type === 'number' && (fieldNameLower(f).includes('prix') || fieldNameLower(f).includes('score') || fieldNameLower(f).includes('valeur') || fieldNameLower(f).includes('value'))
      );

      if (stringField) labelSelect.value = stringField.name;
      if (numberField) valueSelect.value = numberField.name;
    }

    // ============================================================
    // G√âN√âRATION DU GRAPHIQUE
    // ============================================================
    async function generateChart() {
      // Get current values
      state.labelField = document.getElementById('label-field').value;
      state.valueField = document.getElementById('value-field').value;
      state.valueField2 = document.getElementById('value-field-2').value || '';
      state.aggregation = document.getElementById('aggregation').value;
      state.limit = parseInt(document.getElementById('limit').value) || 10;
      state.sortOrder = document.getElementById('sort-order').value;

      const isKPI = state.chartType === 'kpi';
      const isGauge = state.chartType === 'gauge';
      const isSingleValue = isKPI || isGauge;

      // Validation: KPI/Gauge only need valueField, charts need both
      if (!isSingleValue && (!state.labelField || !state.valueField)) {
        alert('Veuillez s√©lectionner les champs pour les axes X et Y');
        return;
      }
      if (isSingleValue && !state.valueField && state.aggregation !== 'count') {
        alert('Veuillez s√©lectionner un champ pour la valeur');
        return;
      }

      // Check if using local data
      if (state.sourceType === 'saved' && state.localData && state.localData.length > 0) {
        generateChartFromLocalData();
        return;
      }

      // Build API URL with aggregation
      const valueExpression = state.aggregation === 'count'
        ? 'count(*) as value'
        : `${state.aggregation}(${state.valueField}) as value`;

      // Handle second series if defined
      const hasSecondSeries = state.valueField2 && ['bar', 'horizontalBar', 'line', 'radar'].includes(state.chartType);
      const valueExpression2 = hasSecondSeries
        ? `, ${state.aggregation}(${state.valueField2}) as value2`
        : '';

      let params;
      if (isSingleValue) {
        // KPI/Gauge: just get the single aggregated value, no group_by
        params = new URLSearchParams({
          select: valueExpression,
          limit: '1'
        });
      } else {
        // Chart: group by label field
        params = new URLSearchParams({
          select: `${state.labelField}, ${valueExpression}${valueExpression2}`,
          group_by: state.labelField,
          order_by: `value ${state.sortOrder}`,
          limit: state.limit.toString()
        });
      }

      const apiUrl = `${state.apiUrl}?${params}`;

      try {
        const response = await fetch(apiUrl);
        const json = await response.json();
        state.data = json.results || [];

        // Update raw data view
        document.getElementById('raw-data').textContent = JSON.stringify(state.data, null, 2);

        // Render chart or KPI
        renderChart();

        // Generate code
        generateCode(apiUrl);

        // Update accessible table (only for charts)
        if (!isKPI) {
          updateAccessibleTable();
        }

      } catch (error) {
        console.error(error);
        alert('Erreur lors du chargement des donn√©es : ' + error.message);
      }
    }

    function generateChartFromLocalData() {
      // Aggregate local data
      const aggregated = {};

      state.localData.forEach(record => {
        const label = record[state.labelField] || 'N/A';
        const value = parseFloat(record[state.valueField]) || 0;

        if (!aggregated[label]) {
          aggregated[label] = { values: [], count: 0 };
        }
        aggregated[label].values.push(value);
        aggregated[label].count++;
      });

      // Apply aggregation function
      let results = Object.entries(aggregated).map(([label, data]) => {
        let value;
        switch (state.aggregation) {
          case 'sum':
            value = data.values.reduce((a, b) => a + b, 0);
            break;
          case 'count':
            value = data.count;
            break;
          case 'min':
            value = Math.min(...data.values);
            break;
          case 'max':
            value = Math.max(...data.values);
            break;
          case 'avg':
          default:
            value = data.values.reduce((a, b) => a + b, 0) / data.values.length;
        }
        return { [state.labelField]: label, value };
      });

      // Sort
      results.sort((a, b) => {
        return state.sortOrder === 'desc' ? b.value - a.value : a.value - b.value;
      });

      // Limit
      results = results.slice(0, state.limit);

      state.data = results;

      // Update raw data view
      document.getElementById('raw-data').textContent = JSON.stringify(state.data, null, 2);

      // Render chart
      renderChart();

      // Generate code based on mode
      if (state.generationMode === 'dynamic' && state.savedSource?.type === 'grist') {
        generateDynamicCode();
      } else {
        generateCodeForLocalData();
      }

      // Update accessible table
      updateAccessibleTable();
    }

    function generateCodeForLocalData() {
      // Handle KPI type
      if (state.chartType === 'kpi') {
        const value = state.data[0]?.value || 0;
        const variant = document.getElementById('kpi-variant').value;
        const unit = document.getElementById('kpi-unit').value || '';

        const code = `<!-- KPI g√©n√©r√© avec gouv-widgets Builder -->
<!-- Source : ${state.savedSource?.name || 'Donn√©es locales'} -->

<!-- D√©pendances CSS (DSFR) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/utility/utility.min.css">

<style>
.kpi-card {
  background: var(--background-default-grey);
  border-left: 4px solid var(--border-default-grey);
  padding: 1.5rem 2rem;
  text-align: center;
  border-radius: 4px;
}
.kpi-card--info { border-left-color: #0063CB; }
.kpi-card--success { border-left-color: #18753C; }
.kpi-card--warning { border-left-color: #D64D00; }
.kpi-card--error { border-left-color: #C9191E; }
.kpi-value { display: block; font-size: 2.5rem; font-weight: 700; color: var(--text-title-grey); }
.kpi-label { display: block; font-size: 0.875rem; color: var(--text-mention-grey); margin-top: 0.5rem; }
</style>

<div class="fr-container fr-my-4w">
  <div class="kpi-card${variant ? ' kpi-card--' + variant : ''}">
    <span class="kpi-value">${formatKPIValue(value, unit)}</span>
    <span class="kpi-label">${escapeHtml(state.title)}</span>
  </div>
</div>`;
        document.getElementById('generated-code').textContent = code;
        return;
      }

      // Handle Gauge type (local data)
      if (state.chartType === 'gauge') {
        const value = Math.round(state.data[0]?.value || 0);
        const code = `<!-- Jauge g√©n√©r√©e avec gouv-widgets Builder -->
<!-- Source : ${state.savedSource?.name || 'Donn√©es locales'} -->

<!-- D√©pendances (DSFR Chart) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr-chart@2.0.4/dist/DSFRChart/DSFRChart.css">
<script type="module" src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr-chart@2.0.4/dist/DSFRChart/DSFRChart.js"><\/script>

<div class="fr-container fr-my-4w">
  <h2>${escapeHtml(state.title)}</h2>
  ${state.subtitle ? `<p class="fr-text--sm fr-text--light">${escapeHtml(state.subtitle)}</p>` : ''}
  <gauge-chart percent="${value}" init="0" target="100"></gauge-chart>
</div>`;
        document.getElementById('generated-code').textContent = code;
        return;
      }

      // Handle Scatter type (local data)
      if (state.chartType === 'scatter') {
        const scatterColor = PALETTE_PRIMARY_COLOR[state.palette] || '#000091';
        const scatterData = state.data.map(d => ({ x: d[state.labelField] || 0, y: d.value || 0 }));
        const code = `<!-- Nuage de points g√©n√©r√© avec gouv-widgets Builder -->
<!-- Source : ${state.savedSource?.name || 'Donn√©es locales'} -->
<!-- Palette: ${state.palette} -->

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"><\/script>

<div class="fr-container fr-my-4w">
  <h2>${escapeHtml(state.title)}</h2>
  <div style="height: 400px;"><canvas id="myChart"></canvas></div>
</div>

<script>
const data = ${JSON.stringify(scatterData, null, 2)};

new Chart(document.getElementById('myChart'), {
  type: 'scatter',
  data: {
    datasets: [{
      label: '${state.labelField} vs ${state.valueField}',
      data: data,
      backgroundColor: '${scatterColor}',
      pointRadius: 6
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      x: { title: { display: true, text: '${state.labelField}' } },
      y: { title: { display: true, text: '${state.valueField}' } }
    }
  }
});
<\/script>`;
        document.getElementById('generated-code').textContent = code;
        return;
      }

      // Get palette colors for code generation
      const primaryColor = PALETTE_PRIMARY_COLOR[state.palette] || '#000091';
      const paletteColors = PALETTE_COLORS[state.palette] || PALETTE_COLORS['categorical'];

      // Check for multi-series support
      const hasSecondSeries = state.valueField2 && ['bar', 'horizontalBar', 'line', 'radar'].includes(state.chartType);
      const isMultiColor = ['pie', 'doughnut', 'radar'].includes(state.chartType);

      // Build datasets code
      let datasetsCode;
      if (hasSecondSeries) {
        datasetsCode = `[{
      label: '${state.valueField}',
      data: values,
      backgroundColor: '${primaryColor}',
      borderColor: '${primaryColor}',
      borderWidth: ${state.chartType === 'line' ? 2 : 1}
    }, {
      label: '${state.valueField2}',
      data: values2,
      backgroundColor: '${state.color2}',
      borderColor: '${state.color2}',
      borderWidth: ${state.chartType === 'line' ? 2 : 1}
    }]`;
      } else {
        datasetsCode = `[{
      label: '${state.valueField}',
      data: values,
      backgroundColor: ${JSON.stringify(isMultiColor ? paletteColors.slice(0, state.limit) : primaryColor)},
      borderColor: '${primaryColor}',
      borderWidth: ${state.chartType === 'line' ? 2 : 1}
    }]`;
      }

      const code = `<!-- Graphique g√©n√©r√© avec gouv-widgets Builder -->
<!-- Source : ${state.savedSource?.name || 'Donn√©es locales'} -->

<!-- D√©pendances CSS (DSFR) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/utility/utility.min.css">

<!-- D√©pendances JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"><\/script>

<div class="fr-container fr-my-4w">
  <h2>${escapeHtml(state.title)}</h2>
  ${state.subtitle ? `<p class="fr-text--sm fr-text--light">${escapeHtml(state.subtitle)}</p>` : ''}

  <div id="chart-container" style="height: 400px; position: relative;">
    <canvas id="myChart"></canvas>
  </div>
</div>

<script>
// Donn√©es int√©gr√©es (depuis ${state.savedSource?.type === 'grist' ? 'Grist' : 'source manuelle'})
const data = ${JSON.stringify(state.data, null, 2)};

const labels = data.map(d => d['${state.labelField}'] || 'N/A');
const values = data.map(d => Math.round((d.value || 0) * 100) / 100);${hasSecondSeries ? `
const values2 = data.map(d => Math.round((d.value2 || 0) * 100) / 100);` : ''}

new Chart(document.getElementById('myChart'), {
  type: '${state.chartType === 'horizontalBar' ? 'bar' : state.chartType}',
  data: {
    labels: labels,
    datasets: ${datasetsCode}
  },
  options: {
    responsive: true,
    maintainAspectRatio: false${state.chartType === 'horizontalBar' ? ",\n    indexAxis: 'y'" : ''},
    plugins: { legend: { display: ${hasSecondSeries || isMultiColor} } }
  }
});
<\/script>`;

      document.getElementById('generated-code').textContent = code;
    }

    // URL du proxy centralis√© (chartsbuilder.matge.com fait proxy vers Grist)
    const PROXY_BASE_URL = 'https://chartsbuilder.matge.com';

    function generateDynamicCode() {
      const source = state.savedSource;
      if (!source || source.type !== 'grist') return;

      // Build full proxy URL via chartsbuilder.matge.com
      // Permet aux sites tiers d'acc√©der √† Grist sans configurer leur propre proxy
      let proxyUrl = '';
      let gristHost = '';

      if (source.apiUrl.includes('grist.numerique.gouv.fr')) {
        proxyUrl = `${PROXY_BASE_URL}/grist-gouv-proxy/api/docs/${source.documentId}/tables/${source.tableId}/records`;
      } else if (source.apiUrl.includes('docs.getgrist.com')) {
        proxyUrl = `${PROXY_BASE_URL}/grist-proxy/api/docs/${source.documentId}/tables/${source.tableId}/records`;
        gristHost = 'docs.getgrist.com';
      } else {
        // Self-hosted - use direct URL
        proxyUrl = source.apiUrl;
        gristHost = 'Grist';
      }

      // Get field info for labels
      const labelFieldInfo = state.fields.find(f => f.name === state.labelField);
      const valueFieldInfo = state.fields.find(f => f.name === state.valueField);

      // Use fullPath for dynamic mode (fields.X)
      const labelFieldPath = labelFieldInfo?.fullPath || `fields.${state.labelField}`;
      const valueFieldPath = valueFieldInfo?.fullPath || `fields.${state.valueField}`;

      const refreshAttr = state.refreshInterval > 0 ? `\n    refresh="${state.refreshInterval}"` : '';

      // Determine chart type for gouv-chart
      const chartType = state.chartType === 'horizontalBar' ? 'bar' : state.chartType;
      const indexAxisAttr = state.chartType === 'horizontalBar' ? '\n    index-axis="y"' : '';

      // Handle KPI type (not supported by gouv-chart yet, fallback to embedded)
      if (state.chartType === 'kpi') {
        generateCodeForLocalData();
        return;
      }

      const code = `<!-- Graphique dynamique g√©n√©r√© avec gouv-widgets Builder -->
<!-- Source : ${escapeHtml(source.name)} (chargement dynamique depuis ${gristHost}) -->
<!-- Les donn√©es sont charg√©es via le proxy ${PROXY_BASE_URL} -->

<!-- D√©pendances CSS (DSFR) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/utility/utility.min.css">

<!-- D√©pendances JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"><\/script>
<script src="https://cdn.jsdelivr.net/gh/bmatge/datasource-charts-webcomponents@v0.2.0/dist/gouv-widgets.umd.js"><\/script>

<div class="fr-container fr-my-4w">
  ${state.title ? `<h2>${escapeHtml(state.title)}</h2>` : ''}
  ${state.subtitle ? `<p class="fr-text--sm fr-text--light">${escapeHtml(state.subtitle)}</p>` : ''}

  <!-- Source de donn√©es (via proxy chartsbuilder.matge.com ‚Üí ${gristHost}) -->
  <gouv-source
    id="chart-data"
    url="${proxyUrl}"
    transform="records"${refreshAttr}>
  </gouv-source>

  <!-- Graphique (se met √† jour automatiquement) -->
  <gouv-chart
    source="chart-data"
    type="${chartType}"${indexAxisAttr}
    label-field="${labelFieldPath}"
    value-field="${valueFieldPath}"
    aggregation="${state.aggregation}"
    limit="${state.limit}"
    sort-order="${state.sortOrder}"
    ${state.title ? `title="${escapeHtml(state.title)}"` : ''}
    ${state.subtitle ? `subtitle="${escapeHtml(state.subtitle)}"` : ''}
    selected-palette="${state.palette}"
    height="400">
  </gouv-chart>
</div>`;

      document.getElementById('generated-code').textContent = code;
    }

    function renderChart() {
      const canvas = document.getElementById('preview-canvas');
      const emptyState = document.getElementById('empty-state');
      const chartContainer = document.querySelector('.chart-container');

      emptyState.style.display = 'none';

      // Destroy previous chart
      if (state.chartInstance) {
        state.chartInstance.destroy();
        state.chartInstance = null;
      }

      // Remove any existing KPI/Gauge card
      const existingCard = chartContainer.querySelector('.kpi-card, .gauge-card');
      if (existingCard) existingCard.remove();

      // Handle KPI type differently
      if (state.chartType === 'kpi') {
        canvas.style.display = 'none';

        // Get the single aggregated value
        const value = state.data[0]?.value || 0;
        const variant = document.getElementById('kpi-variant').value;
        const unit = document.getElementById('kpi-unit').value || '';

        // Format the value
        const formattedValue = formatKPIValue(value, unit);

        // Create KPI card
        const kpiCard = document.createElement('div');
        kpiCard.className = `kpi-card${variant ? ' kpi-card--' + variant : ''}`;
        kpiCard.innerHTML = `
          <span class="kpi-value">${formattedValue}</span>
          <span class="kpi-label">${state.title}</span>
        `;
        chartContainer.appendChild(kpiCard);
        return;
      }

      // Handle Gauge type (simple progress indicator)
      if (state.chartType === 'gauge') {
        canvas.style.display = 'none';

        const value = Math.min(100, Math.max(0, Math.round(state.data[0]?.value || 0)));
        const unit = document.getElementById('kpi-unit')?.value || '%';

        const gaugeColor = PALETTE_PRIMARY_COLOR[state.palette] || '#000091';
        const gaugeCard = document.createElement('div');
        gaugeCard.className = 'gauge-card';
        gaugeCard.innerHTML = `
          <div class="gauge-container">
            <svg viewBox="0 0 100 60" class="gauge-svg">
              <path d="M10 55 A40 40 0 0 1 90 55" fill="none" stroke="#e5e5e5" stroke-width="8" stroke-linecap="round"/>
              <path d="M10 55 A40 40 0 0 1 90 55" fill="none" stroke="${gaugeColor}" stroke-width="8" stroke-linecap="round"
                stroke-dasharray="${value * 1.26} 126" class="gauge-fill"/>
            </svg>
            <div class="gauge-value">${value}${unit}</div>
          </div>
          <div class="gauge-label">${state.title}</div>
        `;
        chartContainer.appendChild(gaugeCard);
        return;
      }

      canvas.style.display = 'block';

      const labels = state.data.map(d => d[state.labelField] || 'N/A');
      const values = state.data.map(d => Math.round((d.value || 0) * 100) / 100);
      const values2 = state.valueField2 ? state.data.map(d => Math.round((d.value2 || 0) * 100) / 100) : null;

      // Determine chart type for Chart.js
      let chartType = state.chartType;
      let indexAxis = 'x';

      if (state.chartType === 'horizontalBar') {
        chartType = 'bar';
        indexAxis = 'y';
      }

      // Get palette colors
      const primaryColor = PALETTE_PRIMARY_COLOR[state.palette] || '#000091';
      const paletteColors = PALETTE_COLORS[state.palette] || PALETTE_COLORS['categorical'];

      // Handle scatter chart (needs different data format)
      if (state.chartType === 'scatter') {
        const scatterData = state.data.map(d => ({
          x: d[state.labelField] || 0,
          y: d.value || 0
        }));

        state.chartInstance = new Chart(canvas, {
          type: 'scatter',
          data: {
            datasets: [{
              label: `${state.labelField} vs ${state.valueField}`,
              data: scatterData,
              backgroundColor: primaryColor,
              borderColor: primaryColor,
              pointRadius: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: true } },
            scales: {
              x: { title: { display: true, text: state.labelField } },
              y: { title: { display: true, text: state.valueField } }
            }
          }
        });
        return;
      }

      // Colors for pie/doughnut/radar (use palette colors)
      const isMultiColor = ['pie', 'doughnut', 'radar'].includes(state.chartType);
      const colors = isMultiColor ? paletteColors.slice(0, state.data.length) : primaryColor;

      // Build datasets array
      const datasets = [{
        label: state.valueField,
        data: values,
        backgroundColor: colors,
        borderColor: state.chartType === 'line' ? primaryColor : colors,
        borderWidth: state.chartType === 'line' ? 2 : 1,
        fill: state.chartType === 'line' ? false : true
      }];

      // Add second series if defined
      if (values2 && ['bar', 'horizontalBar', 'line', 'radar'].includes(state.chartType)) {
        datasets.push({
          label: state.valueField2,
          data: values2,
          backgroundColor: state.color2,
          borderColor: state.color2,
          borderWidth: state.chartType === 'line' ? 2 : 1,
          fill: false
        });
      }

      state.chartInstance = new Chart(canvas, {
        type: chartType,
        data: {
          labels: labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: indexAxis,
          plugins: {
            legend: {
              display: isMultiColor || datasets.length > 1
            }
          },
          scales: isMultiColor ? {} : {
            y: { beginAtZero: chartType !== 'bar' || indexAxis !== 'y' },
            x: { beginAtZero: indexAxis === 'y' }
          }
        }
      });
    }

    // Format KPI value with appropriate formatting
    function formatKPIValue(value, unit) {
      const num = Math.round(value * 100) / 100;
      if (unit === '‚Ç¨' || unit === 'EUR') {
        return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(num);
      } else if (unit === '%') {
        return new Intl.NumberFormat('fr-FR', { maximumFractionDigits: 1 }).format(num) + ' %';
      } else {
        const formatted = new Intl.NumberFormat('fr-FR', { maximumFractionDigits: 2 }).format(num);
        return unit ? `${formatted} ${unit}` : formatted;
      }
    }

    function updateAccessibleTable() {
      const tbody = document.querySelector('#accessible-table tbody');
      tbody.innerHTML = '';

      state.data.forEach(d => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${d[state.labelField] || 'N/A'}</td>
          <td>${(d.value || 0).toLocaleString('fr-FR', { maximumFractionDigits: 2 })}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // ============================================================
    // G√âN√âRATION DU CODE
    // ============================================================
    function generateCode(apiUrl) {
      // Handle KPI type
      if (state.chartType === 'kpi') {
        const variant = document.getElementById('kpi-variant').value;
        const unit = document.getElementById('kpi-unit').value || '';

        const code = `<!-- KPI g√©n√©r√© avec gouv-widgets Builder -->

<!-- D√©pendances CSS (DSFR) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/utility/utility.min.css">

<style>
.kpi-card {
  background: var(--background-default-grey);
  border-left: 4px solid var(--border-default-grey);
  padding: 1.5rem 2rem;
  text-align: center;
  border-radius: 4px;
}
.kpi-card--info { border-left-color: #0063CB; }
.kpi-card--success { border-left-color: #18753C; }
.kpi-card--warning { border-left-color: #D64D00; }
.kpi-card--error { border-left-color: #C9191E; }
.kpi-value { display: block; font-size: 2.5rem; font-weight: 700; color: var(--text-title-grey); }
.kpi-label { display: block; font-size: 0.875rem; color: var(--text-mention-grey); margin-top: 0.5rem; }
</style>

<div class="fr-container fr-my-4w">
  <div class="kpi-card${variant ? ' kpi-card--' + variant : ''}" id="kpi-container">
    <span class="kpi-value" id="kpi-value">‚Äî</span>
    <span class="kpi-label">${escapeHtml(state.title)}</span>
  </div>
</div>

<script>
// URL de l'API avec agr√©gation
const API_URL = '${apiUrl}';

function formatKPIValue(value, unit) {
  const num = Math.round(value * 100) / 100;
  if (unit === '‚Ç¨' || unit === 'EUR') {
    return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' }).format(num);
  } else if (unit === '%') {
    return new Intl.NumberFormat('fr-FR', { maximumFractionDigits: 1 }).format(num) + ' %';
  } else {
    const formatted = new Intl.NumberFormat('fr-FR', { maximumFractionDigits: 2 }).format(num);
    return unit ? formatted + ' ' + unit : formatted;
  }
}

async function loadKPI() {
  const response = await fetch(API_URL);
  const json = await response.json();
  const data = json.results || [];
  const value = data[0]?.value || 0;
  document.getElementById('kpi-value').textContent = formatKPIValue(value, '${unit}');
}

loadKPI();
<\/script>`;
        document.getElementById('generated-code').textContent = code;
        return;
      }

      // Handle Gauge type
      if (state.chartType === 'gauge') {
        const code = `<!-- Jauge g√©n√©r√©e avec gouv-widgets Builder -->

<!-- D√©pendances CSS (DSFR) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/utility/utility.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr-chart@2.0.4/dist/DSFRChart/DSFRChart.css">
<script type="module" src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr-chart@2.0.4/dist/DSFRChart/DSFRChart.js"><\/script>

<div class="fr-container fr-my-4w">
  <h2>${escapeHtml(state.title)}</h2>
  ${state.subtitle ? `<p class="fr-text--sm fr-text--light">${escapeHtml(state.subtitle)}</p>` : ''}
  <div id="gauge-container"></div>
</div>

<script type="module">
const API_URL = '${apiUrl}';

async function loadGauge() {
  const response = await fetch(API_URL);
  const json = await response.json();
  const value = Math.round(json.results?.[0]?.value || 0);

  document.getElementById('gauge-container').innerHTML = \`
    <gauge-chart percent="\${value}" init="0" target="100"></gauge-chart>
  \`;
}

loadGauge();
<\/script>`;
        document.getElementById('generated-code').textContent = code;
        return;
      }

      // Handle Scatter type
      if (state.chartType === 'scatter') {
        const scatterColor = PALETTE_PRIMARY_COLOR[state.palette] || '#000091';
        const code = `<!-- Nuage de points g√©n√©r√© avec gouv-widgets Builder -->
<!-- Palette: ${state.palette} -->

<!-- D√©pendances CSS (DSFR) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/utility/utility.min.css">

<!-- D√©pendances JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"><\/script>

<div class="fr-container fr-my-4w">
  <h2>${escapeHtml(state.title)}</h2>
  ${state.subtitle ? `<p class="fr-text--sm fr-text--light">${escapeHtml(state.subtitle)}</p>` : ''}
  <div style="height: 400px;"><canvas id="myChart"></canvas></div>
</div>

<script>
const API_URL = '${apiUrl}';

async function loadChart() {
  const response = await fetch(API_URL);
  const json = await response.json();
  const data = (json.results || []).map(d => ({
    x: d['${state.labelField}'] || 0,
    y: d.value || 0
  }));

  new Chart(document.getElementById('myChart'), {
    type: 'scatter',
    data: {
      datasets: [{
        label: '${state.labelField} vs ${state.valueField}',
        data: data,
        backgroundColor: '${scatterColor}',
        pointRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { title: { display: true, text: '${state.labelField}' } },
        y: { title: { display: true, text: '${state.valueField}' } }
      }
    }
  });
}

loadChart();
<\/script>`;
        document.getElementById('generated-code').textContent = code;
        return;
      }

      // Get palette colors for code generation
      const primaryColor = PALETTE_PRIMARY_COLOR[state.palette] || '#000091';
      const paletteColors = PALETTE_COLORS[state.palette] || PALETTE_COLORS['categorical'];

      // Check if we have multiple series
      const hasSecondSeries = state.valueField2 && ['bar', 'horizontalBar', 'line', 'radar'].includes(state.chartType);
      const isMultiColor = ['pie', 'doughnut', 'radar'].includes(state.chartType);

      // Build datasets code
      let datasetsCode;
      if (hasSecondSeries) {
        datasetsCode = `[{
        label: '${state.valueField}',
        data: values,
        backgroundColor: '${primaryColor}',
        borderColor: '${primaryColor}',
        borderWidth: ${state.chartType === 'line' ? 2 : 1}
      }, {
        label: '${state.valueField2}',
        data: values2,
        backgroundColor: '${state.color2}',
        borderColor: '${state.color2}',
        borderWidth: ${state.chartType === 'line' ? 2 : 1}
      }]`;
      } else {
        datasetsCode = `[{
        label: '${state.valueField}',
        data: values,
        backgroundColor: ${JSON.stringify(isMultiColor ? paletteColors.slice(0, state.limit) : primaryColor)},
        borderColor: '${primaryColor}',
        borderWidth: ${state.chartType === 'line' ? 2 : 1}
      }]`;

      const code = `<!-- Graphique g√©n√©r√© avec gouv-widgets Builder -->

<!-- D√©pendances CSS (DSFR) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/utility/utility.min.css">

<!-- D√©pendances JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"><\/script>

<div class="fr-container fr-my-4w">
  <h2>${escapeHtml(state.title)}</h2>
  ${state.subtitle ? `<p class="fr-text--sm fr-text--light">${escapeHtml(state.subtitle)}</p>` : ''}

  <div id="chart-container" style="height: 400px; position: relative;">
    <canvas id="myChart"></canvas>
  </div>

  <!-- Alternative accessible (RGAA) -->
  <details class="fr-accordion fr-mt-2w">
    <summary class="fr-accordion__btn">Voir les donn√©es en tableau</summary>
    <div class="fr-accordion__content">
      <table class="fr-table" id="data-table">
        <thead><tr><th>${escapeHtml(state.labelField)}</th><th>${state.valueField}${hasSecondSeries ? `</th><th>${state.valueField2}` : ''}</th></tr></thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>
  </details>
</div>

<script>
// URL de l'API avec agr√©gation
const API_URL = '${apiUrl}';

async function loadChart() {
  const response = await fetch(API_URL);
  const json = await response.json();
  const data = json.results || [];

  const labels = data.map(d => d['${state.labelField}'] || 'N/A');
  const values = data.map(d => Math.round((d.value || 0) * 100) / 100);${hasSecondSeries ? `
  const values2 = data.map(d => Math.round((d.value2 || 0) * 100) / 100);` : ''}

  new Chart(document.getElementById('myChart'), {
    type: '${state.chartType === 'horizontalBar' ? 'bar' : state.chartType}',
    data: {
      labels: labels,
      datasets: ${datasetsCode}
    },
    options: {
      responsive: true,
      maintainAspectRatio: false${state.chartType === 'horizontalBar' ? ",\n      indexAxis: 'y'" : ''},
      plugins: { legend: { display: ${hasSecondSeries || isMultiColor} } }
    }
  });

  // Remplir le tableau accessible
  const tbody = document.getElementById('table-body');
  data.forEach(d => {
    const tr = document.createElement('tr');
    tr.innerHTML = '<td>' + (d['${state.labelField}'] || 'N/A') + '</td><td>' + (d.value?.toFixed(2) || '‚Äî') + '</td>${hasSecondSeries ? `<td>' + (d.value2?.toFixed(2) || '‚Äî') + '</td>` : ''}';
    tbody.appendChild(tr);
  });
}

loadChart();
<\/script>`;

      document.getElementById('generated-code').textContent = code;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function copyCode() {
      const code = document.getElementById('generated-code').textContent;
      navigator.clipboard.writeText(code).then(() => {
        const btn = document.getElementById('copy-code-btn');
        btn.innerHTML = '<i class="ri-check-line"></i> Copi√© !';
        setTimeout(() => {
          btn.innerHTML = '<i class="ri-file-copy-line"></i> Copier le code';
        }, 2000);
      });
    }

    // ============================================================
    // RESIZER
    // ============================================================
    (function initResizer() {
      const resizer = document.getElementById('resizer');
      const leftPanel = document.querySelector('.builder-config');
      const container = document.querySelector('.builder-container');
      let isResizing = false;

      resizer.addEventListener('mousedown', (e) => {
        isResizing = true;
        resizer.classList.add('dragging');
        document.body.style.cursor = 'col-resize';
        document.body.style.userSelect = 'none';
      });

      document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        const containerRect = container.getBoundingClientRect();
        let newWidth = e.clientX - containerRect.left;
        newWidth = Math.max(280, Math.min(newWidth, containerRect.width - 300));
        leftPanel.style.width = newWidth + 'px';
      });

      document.addEventListener('mouseup', () => {
        if (isResizing) {
          isResizing = false;
          resizer.classList.remove('dragging');
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        }
      });
    })();

    // ============================================================
    // SECTIONS COLLAPSIBLES
    // ============================================================
    function toggleSection(sectionId) {
      const section = document.getElementById(sectionId);
      section.classList.toggle('collapsed');
    }
  </script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.module.min.js"></script>
</body>
</html>
