<!DOCTYPE html>
<html lang="fr" data-fr-theme>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>gouv-widgets — Gestion des sources de données</title>

  <!-- DSFR -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/utility/utility.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css">

  <!-- Composants gouv-widgets -->
  <script type="module" src="dist/gouv-widgets.esm.js"></script>

  <style>
    body { min-height: 100vh; background: var(--background-alt-grey); }

    .page-header {
      background: var(--background-default-grey);
      border-bottom: 1px solid var(--border-default-grey);
      padding: 1.5rem 0;
    }

    .page-header h1 {
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .page-header p { margin: 0.5rem 0 0; color: var(--text-mention-grey); }

    .content-grid {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 1.5rem;
      margin-top: 1.5rem;
    }

    .sidebar {
      background: var(--background-default-grey);
      border-radius: 8px;
      padding: 1rem;
    }

    .sidebar h2 {
      font-size: 1rem;
      margin: 0 0 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-default-grey);
    }

    .main-content {
      background: var(--background-default-grey);
      border-radius: 8px;
      padding: 1.5rem;
    }

    .connection-card {
      background: var(--background-alt-grey);
      border-radius: 4px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.15s;
    }

    .connection-card:hover { border-color: var(--border-default-grey); }
    .connection-card.selected { border-color: var(--border-action-high-blue-france); background: var(--background-contrast-info); }

    .connection-card .name { font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
    .connection-card .url { font-size: 0.75rem; color: var(--text-mention-grey); word-break: break-all; }
    .connection-card .status { font-size: 0.7rem; margin-top: 0.25rem; }
    .connection-card .status.connected { color: var(--text-default-success); }
    .connection-card .status.error { color: var(--text-default-error); }

    .add-btn {
      width: 100%;
      margin-top: 0.5rem;
    }

    .explorer-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      border-bottom: 1px solid var(--border-default-grey);
      padding-bottom: 0.5rem;
    }

    .explorer-tab {
      padding: 0.5rem 1rem;
      border: none;
      background: none;
      cursor: pointer;
      font-weight: 500;
      color: var(--text-mention-grey);
      border-radius: 4px 4px 0 0;
    }

    .explorer-tab.active {
      background: var(--background-contrast-info);
      color: var(--text-action-high-blue-france);
    }

    .tree-view { font-size: 0.875rem; }

    .tree-item {
      padding: 0.5rem;
      margin: 0.25rem 0;
      background: var(--background-alt-grey);
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .tree-item:hover { background: var(--background-contrast-grey); }
    .tree-item i { color: var(--text-mention-grey); }
    .tree-item .count { margin-left: auto; font-size: 0.75rem; color: var(--text-mention-grey); }

    .tree-children { margin-left: 1.5rem; }

    .table-preview {
      margin-top: 1rem;
      max-height: 300px;
      overflow: auto;
    }

    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--text-mention-grey);
    }

    .empty-state i { font-size: 3rem; margin-bottom: 1rem; display: block; }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
    }

    .modal-overlay.active { opacity: 1; visibility: visible; }

    .modal {
      background: var(--background-default-grey);
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow: auto;
    }

    .modal-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border-default-grey);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-header h3 { margin: 0; }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-mention-grey);
    }

    .modal-body { padding: 1.5rem; }
    .modal-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--border-default-grey);
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
    }

    .action-bar {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .badge-source-type {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.125rem 0.5rem;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 600;
    }

    .badge-grist { background: #16a34a; color: white; }
    .badge-api { background: #2563eb; color: white; }
    .badge-manual { background: #9333ea; color: white; }

    .field-row {
      display: flex;
      gap: 0.5rem;
      align-items: flex-end;
      margin-bottom: 0.5rem;
    }

    .field-row .fr-input-group { flex: 1; margin: 0; }

    .columns-editor { margin-top: 1rem; }
    .column-item {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      padding: 0.5rem;
      background: var(--background-alt-grey);
      border-radius: 4px;
      margin-bottom: 0.5rem;
    }

    .column-item input { flex: 1; }

    /* Table editor for manual source */
    .table-editor-wrapper {
      border: 1px solid var(--border-default-grey);
      border-radius: 4px;
      overflow: auto;
      max-height: 400px;
    }

    .table-editor {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    .table-editor th,
    .table-editor td {
      border: 1px solid var(--border-default-grey);
      padding: 0;
      position: relative;
      min-width: 120px;
    }

    .table-editor th {
      background: var(--background-alt-grey);
      font-weight: 600;
    }

    .table-editor th .col-header {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem;
    }

    .table-editor th .col-header input {
      flex: 1;
      border: 1px solid transparent;
      background: transparent;
      font-weight: 600;
      font-size: 0.8rem;
      padding: 0.25rem 0.4rem;
      border-radius: 3px;
      min-width: 60px;
    }

    .table-editor th .col-header input:focus {
      border-color: var(--border-action-high-blue-france);
      outline: none;
      background: var(--background-default-grey);
    }

    .table-editor th .col-remove-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-mention-grey);
      padding: 0.125rem;
      font-size: 0.75rem;
      line-height: 1;
      border-radius: 3px;
      flex-shrink: 0;
    }

    .table-editor th .col-remove-btn:hover {
      color: var(--text-default-error);
      background: var(--background-alt-grey);
    }

    .table-editor td input {
      width: 100%;
      border: none;
      padding: 0.4rem 0.5rem;
      font-size: 0.8rem;
      background: transparent;
      box-sizing: border-box;
    }

    .table-editor td input:focus {
      outline: 2px solid var(--border-action-high-blue-france);
      outline-offset: -2px;
      background: var(--background-contrast-info);
    }

    .table-editor .row-number {
      min-width: 40px;
      width: 40px;
      text-align: center;
      color: var(--text-mention-grey);
      font-size: 0.75rem;
      background: var(--background-alt-grey);
      padding: 0.4rem 0.25rem;
      user-select: none;
    }

    .table-editor .row-actions {
      min-width: 36px;
      width: 36px;
      text-align: center;
      padding: 0;
    }

    .table-editor .row-actions button {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-mention-grey);
      padding: 0.25rem;
      font-size: 0.75rem;
      line-height: 1;
      border-radius: 3px;
    }

    .table-editor .row-actions button:hover {
      color: var(--text-default-error);
      background: var(--background-alt-grey);
    }

    .table-editor-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .modal.modal--wide {
      max-width: 800px;
    }

    @media (max-width: 900px) {
      .content-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Edit/Delete button hover */
    .edit-conn-btn:hover,
    .edit-source-btn:hover {
      color: var(--text-action-high-blue-france) !important;
      background: var(--background-alt-grey);
    }
    .delete-conn-btn:hover,
    .delete-source-btn:hover {
      color: var(--text-default-error) !important;
      background: var(--background-alt-grey);
    }

    /* Source mode panels */
    .source-mode-panel {
      margin-top: 1rem;
    }

    /* JSON textarea */
    #json-input {
      font-family: monospace;
      font-size: 0.875rem;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <app-header current-page="sources" base-path=""></app-header>

  <div class="fr-container fr-py-4w">
    <h1><i class="ri-database-2-line"></i> Sources de données</h1>
    <p class="fr-text--lead">Connectez vos sources Grist, API ou créez des jeux de données manuels</p>
  </div>

  <!-- ============================================ -->
  <!-- CONTENU PRINCIPAL -->
  <!-- ============================================ -->
  <div class="fr-container">
    <div class="content-grid">

      <!-- SIDEBAR : Liste des connexions -->
      <aside class="sidebar">
        <h2><i class="ri-link"></i> Connexions</h2>

        <div id="connections-list">
          <!-- Connexions chargées dynamiquement -->
        </div>

        <button class="fr-btn fr-btn--sm fr-btn--secondary add-btn" id="add-connection-btn">
          <i class="ri-add-line"></i> Nouvelle connexion
        </button>

        <hr class="fr-mt-2w fr-mb-2w">

        <h2><i class="ri-folder-chart-line"></i> Mes sources</h2>

        <div id="sources-list">
          <!-- Sources sauvegardées -->
        </div>

        <button class="fr-btn fr-btn--sm fr-btn--secondary add-btn" id="add-source-btn">
          <i class="ri-add-line"></i> Créer une source manuelle
        </button>
      </aside>

      <!-- MAIN : Explorateur -->
      <main class="main-content">
        <div id="explorer-empty" class="empty-state">
          <i class="ri-database-2-line"></i>
          <p>Sélectionnez une connexion pour explorer ses données,<br>ou créez une nouvelle source manuelle.</p>
        </div>

        <div id="explorer-content" style="display: none;">
          <div class="action-bar">
            <h2 id="explorer-title" style="margin: 0; flex: 1;">Explorer</h2>
            <button class="fr-btn fr-btn--sm" id="use-in-builder-btn">
              <i class="ri-bar-chart-box-line"></i> Utiliser dans le Builder
            </button>
            <button class="fr-btn fr-btn--sm fr-btn--secondary" id="save-favorite-btn" style="display: none;">
              <i class="ri-star-line"></i> Garder en favori
            </button>
            <button class="fr-btn fr-btn--sm fr-btn--secondary" id="export-grist-btn" style="display: none;">
              <i class="ri-upload-cloud-line"></i> Exporter vers Grist
            </button>
            <button class="fr-btn fr-btn--sm fr-btn--secondary" id="refresh-btn">
              <i class="ri-refresh-line"></i> Rafraîchir
            </button>
          </div>

          <div id="explorer-tabs" class="explorer-tabs">
            <button class="explorer-tab active" data-tab="documents">Documents</button>
            <button class="explorer-tab" data-tab="tables">Tables</button>
            <button class="explorer-tab" data-tab="preview">Aperçu</button>
          </div>

          <div id="tab-documents" class="tab-panel">
            <div id="documents-tree" class="tree-view">
              <!-- Documents Grist -->
            </div>
          </div>

          <div id="tab-tables" class="tab-panel" style="display: none;">
            <div class="action-bar">
              <button class="fr-btn fr-btn--sm fr-btn--secondary" id="create-table-btn">
                <i class="ri-add-line"></i> Créer une table dans Grist
              </button>
            </div>
            <div id="tables-tree" class="tree-view">
              <!-- Tables -->
            </div>
          </div>

          <div id="tab-preview" class="tab-panel" style="display: none;">
            <p class="fr-text--sm" id="preview-info">Sélectionnez une table pour voir un aperçu des données.</p>
            <div class="table-preview">
              <table class="fr-table" id="preview-table">
                <thead><tr></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </main>

    </div>
  </div>

  <!-- ============================================ -->
  <!-- MODAL : Ajouter une connexion -->
  <!-- ============================================ -->
  <div class="modal-overlay" id="connection-modal">
    <div class="modal">
      <div class="modal-header">
        <h3><i class="ri-link"></i> Nouvelle connexion</h3>
        <button class="modal-close" onclick="closeModal('connection-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <!-- Type de connexion -->
        <fieldset class="fr-fieldset">
          <legend class="fr-fieldset__legend">Type de connexion</legend>
          <div class="fr-fieldset__content" style="display: flex; gap: 1rem;">
            <div class="fr-radio-group">
              <input type="radio" id="conn-type-grist" name="conn-type" value="grist" checked>
              <label class="fr-label" for="conn-type-grist">
                <span class="badge-source-type badge-grist" style="margin-right: 0.25rem;">Grist</span>
                Base de données Grist
              </label>
            </div>
            <div class="fr-radio-group">
              <input type="radio" id="conn-type-api" name="conn-type" value="api">
              <label class="fr-label" for="conn-type-api">
                <span class="badge-source-type badge-api" style="margin-right: 0.25rem;">API</span>
                API REST/JSON
              </label>
            </div>
          </div>
        </fieldset>

        <div class="fr-input-group fr-mt-2w">
          <label class="fr-label" for="conn-name">
            Nom de la connexion
            <span class="fr-hint-text">Un nom pour identifier cette connexion</span>
          </label>
          <input class="fr-input" type="text" id="conn-name" placeholder="Ex: Grist Production">
        </div>

        <!-- Champs Grist -->
        <div id="grist-fields">
          <div class="fr-input-group fr-mt-2w">
            <label class="fr-label" for="conn-url">
              URL du serveur Grist
              <span class="fr-hint-text">Ex: https://grist.numerique.gouv.fr ou https://docs.getgrist.com</span>
            </label>
            <input class="fr-input" type="url" id="conn-url" placeholder="https://grist.numerique.gouv.fr" value="https://grist.numerique.gouv.fr">
          </div>

          <div class="fr-checkbox-group fr-mt-2w">
            <input type="checkbox" id="conn-public" name="conn-public">
            <label class="fr-label" for="conn-public">
              Document public (sans clé API)
              <span class="fr-hint-text">Pour les documents Grist partagés publiquement</span>
            </label>
          </div>

          <div class="fr-input-group fr-mt-2w" id="api-key-group">
            <label class="fr-label" for="conn-api-key">
              Clé API
              <span class="fr-hint-text">Trouvable dans Grist &gt; Paramètres du compte &gt; API</span>
            </label>
            <input class="fr-input" type="password" id="conn-api-key" placeholder="Votre clé API Grist" autocomplete="off" data-1p-ignore data-lpignore="true">
          </div>

          <div class="fr-alert fr-alert--info fr-alert--sm fr-mt-2w" id="api-key-info">
            <p>La clé API est stockée uniquement dans votre navigateur (localStorage).</p>
          </div>
        </div>

        <!-- Champs API REST -->
        <div id="api-fields" style="display: none;">
          <div class="fr-input-group fr-mt-2w">
            <label class="fr-label" for="api-url">
              URL de l'API
              <span class="fr-hint-text">URL complète de l'endpoint JSON (ex: https://api.example.com/data)</span>
            </label>
            <input class="fr-input" type="url" id="api-url" placeholder="https://api.example.com/data.json">
          </div>

          <div class="fr-input-group fr-mt-2w">
            <label class="fr-label" for="api-method">
              Méthode HTTP
            </label>
            <select class="fr-select" id="api-method">
              <option value="GET" selected>GET</option>
              <option value="POST">POST</option>
            </select>
          </div>

          <div class="fr-input-group fr-mt-2w">
            <label class="fr-label" for="api-headers">
              En-têtes (optionnel)
              <span class="fr-hint-text">Format JSON. Ex: {"Authorization": "Bearer xxx"}</span>
            </label>
            <textarea class="fr-input" id="api-headers" rows="2" placeholder='{"Authorization": "Bearer votre_token"}'></textarea>
          </div>

          <div class="fr-input-group fr-mt-2w">
            <label class="fr-label" for="api-data-path">
              Chemin vers les données (optionnel)
              <span class="fr-hint-text">Chemin JSON vers le tableau de données (ex: data.items, results)</span>
            </label>
            <input class="fr-input" type="text" id="api-data-path" placeholder="data.items">
          </div>

          <div class="fr-alert fr-alert--info fr-alert--sm fr-mt-2w">
            <p>Les identifiants sont stockés uniquement dans votre navigateur (localStorage).</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="fr-btn fr-btn--secondary" onclick="closeModal('connection-modal')">Annuler</button>
        <button class="fr-btn" id="save-connection-btn">Tester et sauvegarder</button>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- MODAL : Créer une table Grist -->
  <!-- ============================================ -->
  <div class="modal-overlay" id="create-table-modal">
    <div class="modal">
      <div class="modal-header">
        <h3><i class="ri-table-line"></i> Créer une table dans Grist</h3>
        <button class="modal-close" onclick="closeModal('create-table-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="fr-input-group">
          <label class="fr-label" for="table-name">Nom de la table</label>
          <input class="fr-input" type="text" id="table-name" placeholder="Ex: MesDonnees">
        </div>

        <div class="columns-editor fr-mt-2w">
          <label class="fr-label">Colonnes</label>
          <div id="columns-list">
            <div class="column-item">
              <input class="fr-input fr-input--sm" type="text" placeholder="Nom de colonne" value="Label">
              <select class="fr-select fr-select--sm" style="width: 120px;">
                <option value="Text">Texte</option>
                <option value="Numeric">Nombre</option>
                <option value="Date">Date</option>
                <option value="Bool">Booléen</option>
              </select>
              <button class="fr-btn fr-btn--sm fr-btn--tertiary" onclick="this.parentElement.remove()">
                <i class="ri-delete-bin-line"></i>
              </button>
            </div>
            <div class="column-item">
              <input class="fr-input fr-input--sm" type="text" placeholder="Nom de colonne" value="Valeur">
              <select class="fr-select fr-select--sm" style="width: 120px;">
                <option value="Text">Texte</option>
                <option value="Numeric" selected>Nombre</option>
                <option value="Date">Date</option>
                <option value="Bool">Booléen</option>
              </select>
              <button class="fr-btn fr-btn--sm fr-btn--tertiary" onclick="this.parentElement.remove()">
                <i class="ri-delete-bin-line"></i>
              </button>
            </div>
          </div>
          <button class="fr-btn fr-btn--sm fr-btn--tertiary fr-mt-1w" id="add-column-btn">
            <i class="ri-add-line"></i> Ajouter une colonne
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="fr-btn fr-btn--secondary" onclick="closeModal('create-table-modal')">Annuler</button>
        <button class="fr-btn" id="create-table-confirm-btn">Créer la table</button>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- MODAL : Exporter vers Grist -->
  <!-- ============================================ -->
  <div class="modal-overlay" id="export-grist-modal">
    <div class="modal">
      <div class="modal-header">
        <h3><i class="ri-upload-cloud-line"></i> Exporter vers Grist</h3>
        <button class="modal-close" onclick="closeModal('export-grist-modal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="fr-alert fr-alert--info fr-alert--sm fr-mb-2w">
          <p>Cette fonction va créer une nouvelle table dans votre document Grist avec les données de la source sélectionnée.</p>
        </div>

        <div class="fr-input-group">
          <label class="fr-label" for="export-connection">
            Connexion Grist
            <span class="fr-hint-text">Sélectionnez une connexion avec clé API</span>
          </label>
          <select class="fr-select" id="export-connection">
            <option value="">-- Sélectionner --</option>
          </select>
        </div>

        <div class="fr-input-group fr-mt-2w" id="export-document-group" style="display: none;">
          <label class="fr-label" for="export-document">
            Document Grist
          </label>
          <select class="fr-select" id="export-document">
            <option value="">-- Sélectionner --</option>
          </select>
        </div>

        <div class="fr-input-group fr-mt-2w">
          <label class="fr-label" for="export-table-name">
            Nom de la nouvelle table
          </label>
          <input class="fr-input" type="text" id="export-table-name" placeholder="MaNouvelleTable">
        </div>

        <div id="export-preview" class="fr-mt-2w" style="display: none;">
          <p class="fr-text--sm" style="color: var(--text-mention-grey);">
            <i class="ri-database-2-line"></i> <span id="export-record-count">0</span> enregistrements,
            <span id="export-column-count">0</span> colonnes
          </p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="fr-btn fr-btn--secondary" onclick="closeModal('export-grist-modal')">Annuler</button>
        <button class="fr-btn" id="export-grist-confirm-btn" disabled>
          <i class="ri-upload-cloud-line"></i> Créer la table
        </button>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- MODAL : Créer une source manuelle -->
  <!-- ============================================ -->
  <div class="modal-overlay" id="manual-source-modal">
    <div class="modal modal--wide">
      <div class="modal-header">
        <h3><i class="ri-edit-line"></i> Nouvelle source manuelle</h3>
        <button class="modal-close" onclick="closeManualSourceModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="fr-input-group">
          <label class="fr-label" for="source-name">Nom de la source</label>
          <input class="fr-input" type="text" id="source-name" placeholder="Ex: Statistiques mensuelles">
        </div>

        <!-- Tabs pour les 3 modes -->
        <div class="explorer-tabs fr-mt-2w" id="source-mode-tabs">
          <button class="explorer-tab active" data-source-mode="table">
            <i class="ri-table-line"></i> Tableau
          </button>
          <button class="explorer-tab" data-source-mode="json">
            <i class="ri-code-s-slash-line"></i> Coller JSON
          </button>
          <button class="explorer-tab" data-source-mode="csv">
            <i class="ri-file-text-line"></i> Importer CSV
          </button>
        </div>

        <!-- Mode Tableau -->
        <div id="source-mode-table" class="source-mode-panel">
          <label class="fr-label">
            Données
            <span class="fr-hint-text">Renseignez les noms de colonnes puis remplissez les lignes du tableau</span>
          </label>
          <div class="table-editor-wrapper">
            <table class="table-editor" id="source-table-editor">
              <thead>
                <tr>
                  <th class="row-number">#</th>
                  <th>
                    <div class="col-header">
                      <input type="text" value="label" placeholder="Colonne">
                      <button class="col-remove-btn" title="Supprimer la colonne" onclick="removeTableColumn(this)"><i class="ri-close-line"></i></button>
                    </div>
                  </th>
                  <th>
                    <div class="col-header">
                      <input type="text" value="valeur" placeholder="Colonne">
                      <button class="col-remove-btn" title="Supprimer la colonne" onclick="removeTableColumn(this)"><i class="ri-close-line"></i></button>
                    </div>
                  </th>
                  <th class="row-actions"></th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="row-number">1</td>
                  <td><input type="text" placeholder="..."></td>
                  <td><input type="text" placeholder="..."></td>
                  <td class="row-actions"><button title="Supprimer la ligne" onclick="removeTableRow(this)"><i class="ri-close-line"></i></button></td>
                </tr>
                <tr>
                  <td class="row-number">2</td>
                  <td><input type="text" placeholder="..."></td>
                  <td><input type="text" placeholder="..."></td>
                  <td class="row-actions"><button title="Supprimer la ligne" onclick="removeTableRow(this)"><i class="ri-close-line"></i></button></td>
                </tr>
                <tr>
                  <td class="row-number">3</td>
                  <td><input type="text" placeholder="..."></td>
                  <td><input type="text" placeholder="..."></td>
                  <td class="row-actions"><button title="Supprimer la ligne" onclick="removeTableRow(this)"><i class="ri-close-line"></i></button></td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="table-editor-actions">
            <button class="fr-btn fr-btn--sm fr-btn--tertiary" type="button" onclick="addTableRow()">
              <i class="ri-add-line"></i> Ajouter une ligne
            </button>
            <button class="fr-btn fr-btn--sm fr-btn--tertiary" type="button" onclick="addTableColumn()">
              <i class="ri-add-line"></i> Ajouter une colonne
            </button>
          </div>
        </div>

        <!-- Mode JSON -->
        <div id="source-mode-json" class="source-mode-panel" style="display: none;">
          <div class="fr-input-group">
            <label class="fr-label" for="json-input">
              Contenu JSON
              <span class="fr-hint-text">Collez un tableau JSON ou un objet contenant un tableau</span>
            </label>
            <textarea class="fr-input" id="json-input" rows="10" placeholder='[
  {"label": "Janvier", "valeur": 100},
  {"label": "Février", "valeur": 150}
]'></textarea>
          </div>
          <div class="fr-input-group fr-mt-1w">
            <label class="fr-label" for="json-data-path">
              Chemin vers les données (optionnel)
              <span class="fr-hint-text">Si le tableau est imbriqué, indiquez le chemin (ex: data.items)</span>
            </label>
            <input class="fr-input" type="text" id="json-data-path" placeholder="data.items">
          </div>
          <div id="json-preview" class="fr-mt-2w" style="display: none;">
            <p class="fr-text--sm" style="color: var(--text-mention-grey);">Aperçu : <span id="json-preview-count">0</span> éléments détectés</p>
          </div>
        </div>

        <!-- Mode CSV -->
        <div id="source-mode-csv" class="source-mode-panel" style="display: none;">
          <div class="fr-upload-group">
            <label class="fr-label" for="csv-file">
              Fichier CSV
              <span class="fr-hint-text">Sélectionnez un fichier CSV (séparateur : virgule ou point-virgule)</span>
            </label>
            <input class="fr-upload" type="file" id="csv-file" accept=".csv,text/csv">
          </div>
          <div class="fr-input-group fr-mt-2w">
            <label class="fr-label" for="csv-separator">
              Séparateur
            </label>
            <select class="fr-select" id="csv-separator">
              <option value="auto">Automatique</option>
              <option value=";">Point-virgule (;)</option>
              <option value=",">Virgule (,)</option>
              <option value="\t">Tabulation</option>
            </select>
          </div>
          <div id="csv-preview" class="fr-mt-2w" style="display: none;">
            <p class="fr-text--sm" style="color: var(--text-mention-grey);">Aperçu : <span id="csv-preview-count">0</span> lignes détectées</p>
            <div class="table-preview" style="max-height: 200px;">
              <table class="fr-table" id="csv-preview-table">
                <thead><tr></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="fr-btn fr-btn--secondary" onclick="closeManualSourceModal()">Annuler</button>
        <button class="fr-btn" id="save-source-btn">Sauvegarder</button>
      </div>
    </div>
  </div>

  <script>
    // ============================================================
    // STOCKAGE LOCAL
    // ============================================================
    const STORAGE_KEYS = {
      CONNECTIONS: 'gouv_widgets_connections',
      SOURCES: 'gouv_widgets_sources',
      SELECTED_SOURCE: 'gouv_widgets_selected_source'
    };

    function loadFromStorage(key) {
      try {
        return JSON.parse(localStorage.getItem(key)) || [];
      } catch {
        return [];
      }
    }

    function saveToStorage(key, data) {
      localStorage.setItem(key, JSON.stringify(data));
    }

    // ============================================================
    // ÉTAT DE L'APPLICATION
    // ============================================================
    let state = {
      connections: loadFromStorage(STORAGE_KEYS.CONNECTIONS),
      sources: loadFromStorage(STORAGE_KEYS.SOURCES),
      selectedConnection: null,
      selectedDocument: null,
      selectedTable: null,
      documents: [],
      tables: [],
      tableData: [],
      editingConnectionIndex: null,  // Index de la connexion en cours d'édition (null = création)
      previewedSource: null  // Source actuellement prévisualisée (pour export)
    };

    // ============================================================
    // INITIALISATION
    // ============================================================
    document.addEventListener('DOMContentLoaded', () => {
      renderConnections();
      renderSources();

      // Event listeners
      document.getElementById('add-connection-btn').addEventListener('click', () => openModal('connection-modal'));
      document.getElementById('add-source-btn').addEventListener('click', () => openModal('manual-source-modal'));
      document.getElementById('save-connection-btn').addEventListener('click', saveConnection);
      document.getElementById('save-source-btn').addEventListener('click', saveManualSource);
      document.getElementById('create-table-btn').addEventListener('click', () => openModal('create-table-modal'));
      document.getElementById('add-column-btn').addEventListener('click', addColumnRow);
      document.getElementById('create-table-confirm-btn').addEventListener('click', createGristTable);
      document.getElementById('refresh-btn').addEventListener('click', refreshCurrentView);
      document.getElementById('use-in-builder-btn').addEventListener('click', openInBuilder);
      document.getElementById('save-favorite-btn').addEventListener('click', saveAsFavorite);
      document.getElementById('export-grist-btn').addEventListener('click', openExportGristModal);
      document.getElementById('export-connection').addEventListener('change', loadExportDocuments);
      document.getElementById('export-document').addEventListener('change', updateExportButton);
      document.getElementById('export-table-name').addEventListener('input', updateExportButton);
      document.getElementById('export-grist-confirm-btn').addEventListener('click', exportToGrist);

      // Tabs (only explorer tabs, not modal tabs)
      document.querySelectorAll('.explorer-tabs:not(#source-mode-tabs) .explorer-tab').forEach(tab => {
        tab.addEventListener('click', () => switchExplorerTab(tab.dataset.tab));
      });

      // Public document toggle
      document.getElementById('conn-public').addEventListener('change', (e) => {
        const apiKeyGroup = document.getElementById('api-key-group');
        const apiKeyInfo = document.getElementById('api-key-info');
        if (e.target.checked) {
          apiKeyGroup.style.display = 'none';
          apiKeyInfo.style.display = 'none';
        } else {
          apiKeyGroup.style.display = 'block';
          apiKeyInfo.style.display = 'block';
        }
      });

      // Connection type toggle (Grist vs API)
      document.querySelectorAll('input[name="conn-type"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          const gristFields = document.getElementById('grist-fields');
          const apiFields = document.getElementById('api-fields');
          if (e.target.value === 'grist') {
            gristFields.style.display = 'block';
            apiFields.style.display = 'none';
          } else {
            gristFields.style.display = 'none';
            apiFields.style.display = 'block';
          }
        });
      });

      // Source mode tabs (Table / JSON / CSV)
      document.querySelectorAll('[data-source-mode]').forEach(tab => {
        tab.addEventListener('click', () => switchSourceMode(tab.dataset.sourceMode));
      });

      // JSON input parsing
      document.getElementById('json-input').addEventListener('input', parseJsonInput);
      document.getElementById('json-data-path').addEventListener('input', parseJsonInput);

      // CSV file handling
      document.getElementById('csv-file').addEventListener('change', handleCsvFile);
      document.getElementById('csv-separator').addEventListener('change', () => {
        const file = document.getElementById('csv-file').files[0];
        if (file) handleCsvFile({ target: { files: [file] } });
      });
    });

    // ============================================================
    // MODALS
    // ============================================================
    function openModal(id) {
      document.getElementById(id).classList.add('active');
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    // ============================================================
    // CONNEXIONS
    // ============================================================
    function renderConnections() {
      const container = document.getElementById('connections-list');
      container.innerHTML = '';

      if (state.connections.length === 0) {
        container.innerHTML = '<p class="fr-text--sm" style="color: var(--text-mention-grey);">Aucune connexion</p>';
        return;
      }

      state.connections.forEach((conn, index) => {
        const card = document.createElement('div');
        card.className = `connection-card ${state.selectedConnection === index ? 'selected' : ''}`;

        // Badge selon le type
        const typeBadge = conn.type === 'api'
          ? '<span class="badge-source-type badge-api">API</span>'
          : '<span class="badge-source-type badge-grist">Grist</span>';
        const publicBadge = conn.isPublic ? '<span class="badge-source-type" style="background: #f59e0b; color: white; margin-left: 0.25rem;">Public</span>' : '';

        card.innerHTML = `
          <div class="name" style="display: flex; align-items: center; gap: 0.5rem;">
            ${typeBadge}${publicBadge}
            <span style="flex: 1;">${escapeHtml(conn.name)}</span>
            <button class="edit-conn-btn" title="Modifier cette connexion" style="background: none; border: none; cursor: pointer; color: var(--text-mention-grey); padding: 0.25rem; font-size: 0.875rem; line-height: 1; border-radius: 3px;">
              <i class="ri-pencil-line"></i>
            </button>
            <button class="delete-conn-btn" title="Supprimer cette connexion" style="background: none; border: none; cursor: pointer; color: var(--text-mention-grey); padding: 0.25rem; font-size: 0.875rem; line-height: 1; border-radius: 3px;">
              <i class="ri-delete-bin-line"></i>
            </button>
          </div>
          <div class="url">${escapeHtml(conn.url || conn.apiUrl || '')}</div>
          <div class="status ${conn.status || ''}">${conn.statusText || 'Non testé'}</div>
        `;

        // Click on card to select
        card.addEventListener('click', (e) => {
          if (!e.target.closest('.delete-conn-btn') && !e.target.closest('.edit-conn-btn')) {
            selectConnection(index);
          }
        });

        // Edit button
        card.querySelector('.edit-conn-btn').addEventListener('click', (e) => {
          e.stopPropagation();
          editConnection(index);
        });

        // Delete button
        card.querySelector('.delete-conn-btn').addEventListener('click', (e) => {
          e.stopPropagation();
          if (confirm(`Supprimer la connexion "${conn.name}" ?`)) {
            deleteConnection(index);
          }
        });

        // Context menu (right-click to delete) - keep as alternative
        card.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          if (confirm(`Supprimer la connexion "${conn.name}" ?`)) {
            deleteConnection(index);
          }
        });

        container.appendChild(card);
      });
    }

    async function saveConnection() {
      const connType = document.querySelector('input[name="conn-type"]:checked').value;
      const name = document.getElementById('conn-name').value.trim();

      if (!name) {
        alert('Veuillez entrer un nom pour la connexion');
        return;
      }

      const btn = document.getElementById('save-connection-btn');
      btn.disabled = true;
      btn.textContent = 'Test en cours...';

      try {
        if (connType === 'grist') {
          await saveGristConnection(name);
        } else {
          await saveApiConnection(name);
        }
      } finally {
        btn.disabled = false;
        btn.textContent = 'Tester et sauvegarder';
      }
    }

    async function saveGristConnection(name) {
      const url = document.getElementById('conn-url').value.trim().replace(/\/$/, '');
      const apiKey = document.getElementById('conn-api-key').value.trim();
      const isPublic = document.getElementById('conn-public').checked;

      if (!url) {
        alert('Veuillez remplir l\'URL du serveur Grist');
        return;
      }

      if (!isPublic && !apiKey) {
        alert('Clé API requise (sauf pour les documents publics)');
        return;
      }

      // Utilise le proxy pour éviter les erreurs CORS
      const useLocalProxy = isViteDevMode();
      let testUrl;
      if (url.includes('docs.getgrist.com')) {
        testUrl = useLocalProxy
          ? '/grist-proxy/api/orgs'
          : `${EXTERNAL_PROXY}/grist-proxy/api/orgs`;
      } else if (url.includes('grist.numerique.gouv.fr')) {
        testUrl = useLocalProxy
          ? '/grist-gouv-proxy/api/orgs'
          : `${EXTERNAL_PROXY}/grist-gouv-proxy/api/orgs`;
      } else {
        testUrl = `${url}/api/orgs`;
      }

      const headers = {};
      if (!isPublic && apiKey) {
        headers['Authorization'] = `Bearer ${apiKey}`;
      }

      const response = await fetch(testUrl, { headers });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      const orgs = await response.json();

      // Save or update connection
      const connection = {
        id: state.editingConnectionIndex !== null ? state.connections[state.editingConnectionIndex].id : Date.now().toString(),
        type: 'grist',
        name,
        url,
        apiKey: isPublic ? null : apiKey,
        isPublic,
        status: 'connected',
        statusText: isPublic ? 'Mode public' : `Connecté (${orgs.length} org${orgs.length > 1 ? 's' : ''})`
      };

      if (state.editingConnectionIndex !== null) {
        // Mode édition : mettre à jour la connexion existante
        state.connections[state.editingConnectionIndex] = connection;
      } else {
        // Mode création : ajouter une nouvelle connexion
        state.connections.push(connection);
      }

      const wasEditing = state.editingConnectionIndex;
      saveToStorage(STORAGE_KEYS.CONNECTIONS, state.connections);
      renderConnections();
      closeModal('connection-modal');
      resetConnectionForm();

      // Auto-select the connection (edited or new)
      if (wasEditing !== null) {
        selectConnection(wasEditing);
      } else {
        selectConnection(state.connections.length - 1);
      }
    }

    async function saveApiConnection(name) {
      const apiUrl = document.getElementById('api-url').value.trim();
      const method = document.getElementById('api-method').value;
      const headersText = document.getElementById('api-headers').value.trim();
      const dataPath = document.getElementById('api-data-path').value.trim();

      if (!apiUrl) {
        alert('Veuillez remplir l\'URL de l\'API');
        return;
      }

      // Parse headers
      let headers = {};
      if (headersText) {
        try {
          headers = JSON.parse(headersText);
        } catch (e) {
          alert('Les en-têtes doivent être au format JSON valide');
          return;
        }
      }

      // Test the API
      const response = await fetch(apiUrl, {
        method,
        headers
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      let data = await response.json();

      // Navigate to data path if specified
      if (dataPath) {
        const parts = dataPath.split('.');
        for (const part of parts) {
          if (data && typeof data === 'object') {
            data = data[part];
          }
        }
      }

      // Check if data is an array
      const isArray = Array.isArray(data);
      const count = isArray ? data.length : (data ? 1 : 0);

      // Save or update connection
      const connection = {
        id: state.editingConnectionIndex !== null ? state.connections[state.editingConnectionIndex].id : Date.now().toString(),
        type: 'api',
        name,
        apiUrl,
        method,
        headers: headersText || null,
        dataPath: dataPath || null,
        status: 'connected',
        statusText: `Connecté (${count} ${isArray ? 'éléments' : 'objet'})`
      };

      const wasEditing = state.editingConnectionIndex;

      if (state.editingConnectionIndex !== null) {
        // Mode édition : mettre à jour la connexion existante
        state.connections[state.editingConnectionIndex] = connection;
      } else {
        // Mode création : ajouter une nouvelle connexion
        state.connections.push(connection);
      }

      saveToStorage(STORAGE_KEYS.CONNECTIONS, state.connections);
      renderConnections();
      closeModal('connection-modal');
      resetConnectionForm();

      // Auto-select the connection (edited or new)
      if (wasEditing !== null) {
        selectConnection(wasEditing);
      } else {
        selectConnection(state.connections.length - 1);
      }
    }

    function resetConnectionForm() {
      state.editingConnectionIndex = null;
      document.getElementById('conn-name').value = '';
      document.getElementById('conn-url').value = 'https://grist.numerique.gouv.fr';
      document.getElementById('conn-api-key').value = '';
      document.getElementById('conn-public').checked = false;
      document.getElementById('api-key-group').style.display = 'block';
      document.getElementById('api-key-info').style.display = 'block';
      document.getElementById('api-url').value = '';
      document.getElementById('api-method').value = 'GET';
      document.getElementById('api-headers').value = '';
      document.getElementById('api-data-path').value = '';
      document.getElementById('conn-type-grist').checked = true;
      document.getElementById('grist-fields').style.display = 'block';
      document.getElementById('api-fields').style.display = 'none';
      // Réinitialiser le titre de la modale
      document.querySelector('#connection-modal .modal-header h3').innerHTML = '<i class="ri-link"></i> Nouvelle connexion';
      document.getElementById('save-connection-btn').textContent = 'Tester et sauvegarder';
    }

    function editConnection(index) {
      const conn = state.connections[index];
      if (!conn) return;

      state.editingConnectionIndex = index;

      // Mettre à jour le titre de la modale
      document.querySelector('#connection-modal .modal-header h3').innerHTML = '<i class="ri-pencil-line"></i> Modifier la connexion';
      document.getElementById('save-connection-btn').textContent = 'Enregistrer les modifications';

      // Pré-remplir les champs communs
      document.getElementById('conn-name').value = conn.name || '';

      if (conn.type === 'api') {
        // Connexion API
        document.getElementById('conn-type-api').checked = true;
        document.getElementById('grist-fields').style.display = 'none';
        document.getElementById('api-fields').style.display = 'block';
        document.getElementById('api-url').value = conn.apiUrl || '';
        document.getElementById('api-method').value = conn.method || 'GET';
        document.getElementById('api-headers').value = conn.headers || '';
        document.getElementById('api-data-path').value = conn.dataPath || '';
      } else {
        // Connexion Grist
        document.getElementById('conn-type-grist').checked = true;
        document.getElementById('grist-fields').style.display = 'block';
        document.getElementById('api-fields').style.display = 'none';
        document.getElementById('conn-url').value = conn.url || 'https://grist.numerique.gouv.fr';
        document.getElementById('conn-public').checked = conn.isPublic || false;
        document.getElementById('conn-api-key').value = conn.apiKey || '';

        // Afficher/masquer le champ API key selon le mode public
        const apiKeyGroup = document.getElementById('api-key-group');
        const apiKeyInfo = document.getElementById('api-key-info');
        if (conn.isPublic) {
          apiKeyGroup.style.display = 'none';
          apiKeyInfo.style.display = 'none';
        } else {
          apiKeyGroup.style.display = 'block';
          apiKeyInfo.style.display = 'block';
        }
      }

      // Ouvrir la modale
      openModal('connection-modal');
    }

    function deleteConnection(index) {
      state.connections.splice(index, 1);
      saveToStorage(STORAGE_KEYS.CONNECTIONS, state.connections);
      if (state.selectedConnection === index) {
        state.selectedConnection = null;
        showExplorerEmpty();
      }
      renderConnections();
    }

    async function selectConnection(index) {
      state.selectedConnection = index;
      state.selectedDocument = null;
      state.selectedTable = null;
      state.previewedSource = null;  // Reset previewed source
      renderConnections();

      const conn = state.connections[index];
      document.getElementById('explorer-title').textContent = conn.name;
      document.getElementById('explorer-empty').style.display = 'none';
      document.getElementById('explorer-content').style.display = 'block';

      // Hide export button (only for local sources)
      document.getElementById('export-grist-btn').style.display = 'none';

      // Show explorer tabs (hidden when previewing local sources)
      document.getElementById('explorer-tabs').style.display = '';

      // Hide/show appropriate tabs based on connection type
      const docTab = document.querySelector('[data-tab="documents"]');
      const tablesTab = document.querySelector('[data-tab="tables"]');
      const createTableBtn = document.getElementById('create-table-btn');

      if (conn.type === 'api') {
        // API connections: hide docs/tables tabs, show preview directly
        docTab.style.display = 'none';
        tablesTab.style.display = 'none';
        createTableBtn.style.display = 'none';
        switchExplorerTab('preview');
        await loadApiData();
      } else {
        // Grist connections: show all tabs
        docTab.style.display = '';
        tablesTab.style.display = '';
        createTableBtn.style.display = '';
        switchExplorerTab('documents');
        await loadDocuments();
      }
    }

    // Helper to use local proxy for CORS-restricted APIs
    function getProxiedUrl(url) {
      const isLocalDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
      if (!isLocalDev) return url;

      // Proxy for tabular-api.data.gouv.fr
      if (url.includes('tabular-api.data.gouv.fr')) {
        return url.replace('https://tabular-api.data.gouv.fr', '/tabular-proxy');
      }
      // Proxy for other data.gouv.fr APIs
      if (url.includes('data.gouv.fr')) {
        return url.replace(/https:\/\/([^/]+\.)?data\.gouv\.fr/, '/tabular-proxy');
      }
      return url;
    }

    async function loadApiData() {
      const conn = state.connections[state.selectedConnection];
      if (!conn || conn.type !== 'api') return;

      const info = document.getElementById('preview-info');
      const table = document.getElementById('preview-table');

      info.textContent = 'Chargement...';
      table.querySelector('thead tr').innerHTML = '';
      table.querySelector('tbody').innerHTML = '';

      try {
        const headers = conn.headers ? JSON.parse(conn.headers) : {};

        // Fetch all pages if pagination is detected
        let allData = [];
        let currentUrl = getProxiedUrl(conn.apiUrl);
        let pageCount = 0;
        const maxPages = 100; // Safety limit

        while (currentUrl && pageCount < maxPages) {
          pageCount++;
          info.textContent = pageCount > 1
            ? `Chargement... (page ${pageCount})`
            : 'Chargement...';

          const response = await fetch(currentUrl, {
            method: conn.method || 'GET',
            headers
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const jsonResponse = await response.json();

          // Extract data using dataPath
          let pageData = jsonResponse;
          if (conn.dataPath) {
            const parts = conn.dataPath.split('.');
            for (const part of parts) {
              if (pageData && typeof pageData === 'object') {
                pageData = pageData[part];
              }
            }
          }

          // Normalize to array and add to allData
          if (Array.isArray(pageData)) {
            allData = allData.concat(pageData);
          } else if (pageData) {
            allData.push(pageData);
          }

          // Check for pagination - look for links.next or meta info
          let nextUrl = null;

          // Pattern 1: links.next (common in REST APIs like tabular-api.data.gouv.fr)
          if (jsonResponse.links && jsonResponse.links.next) {
            nextUrl = jsonResponse.links.next;
            // Handle relative URLs
            if (nextUrl && !nextUrl.startsWith('http')) {
              const baseUrl = new URL(conn.apiUrl);
              nextUrl = new URL(nextUrl, baseUrl.origin).href;
            }
          }

          // Pattern 2: meta with page info (calculate next page URL)
          else if (jsonResponse.meta && jsonResponse.meta.total && jsonResponse.meta.page_size) {
            const { page, page_size, total } = jsonResponse.meta;
            const currentPage = page || 1;
            const totalPages = Math.ceil(total / page_size);

            if (currentPage < totalPages) {
              // Build next page URL
              const url = new URL(currentUrl);
              url.searchParams.set('page', String(currentPage + 1));
              nextUrl = url.href;
            }
          }

          // Pattern 3: next_page or nextPage field at root level
          else if (jsonResponse.next_page || jsonResponse.nextPage) {
            nextUrl = jsonResponse.next_page || jsonResponse.nextPage;
          }

          // Apply proxy to next URL if needed
          currentUrl = nextUrl ? getProxiedUrl(nextUrl) : null;
        }

        // Normalize to array
        let data = allData;
        if (!Array.isArray(data)) {
          data = data ? [data] : [];
        }

        state.tableData = data;

        if (data.length === 0) {
          info.textContent = 'Aucune donnée';
          return;
        }

        // Get columns from first record
        const columns = Object.keys(data[0]);

        // Header
        let headerHtml = '';
        columns.forEach(col => {
          headerHtml += `<th>${escapeHtml(col)}</th>`;
        });
        table.querySelector('thead tr').innerHTML = headerHtml;

        // Body (show first 20 for preview)
        let bodyHtml = '';
        data.slice(0, 20).forEach(record => {
          bodyHtml += '<tr>';
          columns.forEach(col => {
            const val = record[col];
            bodyHtml += `<td>${escapeHtml(String(val ?? ''))}</td>`;
          });
          bodyHtml += '</tr>';
        });
        table.querySelector('tbody').innerHTML = bodyHtml;

        const paginationInfo = pageCount > 1 ? ` (${pageCount} pages)` : '';
        info.textContent = `${data.length} enregistrements${paginationInfo}`;

        // Save as current source for builder
        saveApiAsSource();

        // Show favorite button
        document.getElementById('save-favorite-btn').style.display = '';

      } catch (error) {
        info.textContent = `Erreur : ${error.message}`;
      }
    }

    function saveApiAsSource() {
      const conn = state.connections[state.selectedConnection];
      if (!conn) return;

      const source = {
        id: `api_${conn.id}`,
        name: conn.name,
        type: 'api',
        connectionId: conn.id,
        apiUrl: conn.apiUrl,
        method: conn.method,
        headers: conn.headers,
        dataPath: conn.dataPath,
        data: state.tableData,
        recordCount: state.tableData.length
      };

      localStorage.setItem(STORAGE_KEYS.SELECTED_SOURCE, JSON.stringify(source));
    }

    function saveAsFavorite() {
      // Get the current source from localStorage
      const currentSource = JSON.parse(localStorage.getItem(STORAGE_KEYS.SELECTED_SOURCE) || 'null');
      if (!currentSource) {
        alert('Aucune source sélectionnée');
        return;
      }

      // Check if already in favorites
      const existingIndex = state.sources.findIndex(s => s.id === currentSource.id);
      if (existingIndex >= 0) {
        if (confirm('Cette source est déjà dans vos favoris. Voulez-vous la mettre à jour avec les données actuelles ?')) {
          state.sources[existingIndex] = currentSource;
          saveToStorage(STORAGE_KEYS.SOURCES, state.sources);
          renderSources();
          alert('Source mise à jour !');
        }
        return;
      }

      // Add to favorites
      state.sources.push(currentSource);
      saveToStorage(STORAGE_KEYS.SOURCES, state.sources);
      renderSources();

      // Change button to indicate success
      const btn = document.getElementById('save-favorite-btn');
      const originalHtml = btn.innerHTML;
      btn.innerHTML = '<i class="ri-star-fill"></i> Ajouté aux favoris';
      btn.disabled = true;
      setTimeout(() => {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
      }, 2000);
    }

    // ============================================================
    // GRIST API
    // ============================================================
    // Détecte si on est en mode Vite dev (localhost) ou en production/Tauri
    function isViteDevMode() {
      return window.location.hostname === 'localhost' && window.location.port === '5173';
    }

    // Préfixe du proxy externe pour le mode production/Tauri
    const EXTERNAL_PROXY = 'https://chartsbuilder.matge.com';

    // Convertit une URL Grist en URL proxy pour éviter les erreurs CORS
    function getProxyUrl(gristUrl, endpoint) {
      const url = new URL(gristUrl);
      const useLocalProxy = isViteDevMode();

      // Si c'est docs.getgrist.com, utiliser le proxy dédié
      if (url.hostname === 'docs.getgrist.com') {
        return useLocalProxy
          ? `/grist-proxy/api${endpoint}`
          : `${EXTERNAL_PROXY}/grist-proxy/api${endpoint}`;
      }

      // Si c'est grist.numerique.gouv.fr, utiliser le proxy gouv
      if (url.hostname === 'grist.numerique.gouv.fr') {
        return useLocalProxy
          ? `/grist-gouv-proxy/api${endpoint}`
          : `${EXTERNAL_PROXY}/grist-gouv-proxy/api${endpoint}`;
      }

      // Sinon, utiliser l'URL directe (instances self-hosted avec CORS configuré)
      return `${gristUrl}/api${endpoint}`;
    }

    async function gristFetch(endpoint) {
      const conn = state.connections[state.selectedConnection];
      if (!conn) throw new Error('Aucune connexion sélectionnée');

      const proxyUrl = getProxyUrl(conn.url, endpoint);

      const headers = {};
      if (!conn.isPublic && conn.apiKey) {
        headers['Authorization'] = `Bearer ${conn.apiKey}`;
      }

      const response = await fetch(proxyUrl, { headers });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      return response.json();
    }

    async function loadDocuments() {
      const tree = document.getElementById('documents-tree');
      tree.innerHTML = '<p>Chargement...</p>';

      try {
        // Get all orgs
        const orgs = await gristFetch('/orgs');
        state.documents = [];

        let html = '';

        for (const org of orgs) {
          // Get workspaces for each org
          const workspaces = await gristFetch(`/orgs/${org.id}/workspaces`);

          html += `<div class="tree-item" style="font-weight: 600; background: var(--background-contrast-grey);">
            <i class="ri-building-line"></i> ${escapeHtml(org.name)}
          </div>`;

          for (const ws of workspaces) {
            html += `<div class="tree-children">
              <div class="tree-item" style="background: var(--background-default-grey);">
                <i class="ri-folder-line"></i> ${escapeHtml(ws.name)}
                <span class="count">${ws.docs?.length || 0} docs</span>
              </div>`;

            if (ws.docs) {
              for (const doc of ws.docs) {
                state.documents.push({ ...doc, orgId: org.id, workspaceId: ws.id });
                html += `<div class="tree-children">
                  <div class="tree-item" data-doc-id="${doc.id}" onclick="selectDocument('${doc.id}')">
                    <i class="ri-file-text-line"></i> ${escapeHtml(doc.name)}
                  </div>
                </div>`;
              }
            }

            html += '</div>';
          }
        }

        tree.innerHTML = html || '<p>Aucun document trouvé</p>';

      } catch (error) {
        tree.innerHTML = `<p class="error-message">Erreur : ${error.message}</p>`;
      }
    }

    async function selectDocument(docId) {
      state.selectedDocument = docId;
      state.selectedTable = null;

      // Highlight selected
      document.querySelectorAll('[data-doc-id]').forEach(el => el.classList.remove('selected'));
      document.querySelector(`[data-doc-id="${docId}"]`)?.classList.add('selected');

      // Switch to tables tab and load
      switchExplorerTab('tables');
      await loadTables();
    }

    async function loadTables() {
      if (!state.selectedDocument) {
        document.getElementById('tables-tree').innerHTML = '<p>Sélectionnez d\'abord un document</p>';
        return;
      }

      const tree = document.getElementById('tables-tree');
      tree.innerHTML = '<p>Chargement des tables...</p>';

      try {
        const result = await gristFetch(`/docs/${state.selectedDocument}/tables`);
        state.tables = result.tables || [];

        let html = '';
        for (const table of state.tables) {
          html += `<div class="tree-item" data-table-id="${table.id}" onclick="selectTable('${table.id}')">
            <i class="ri-table-line"></i> ${escapeHtml(table.id)}
          </div>`;
        }

        tree.innerHTML = html || '<p>Aucune table</p>';

      } catch (error) {
        tree.innerHTML = `<p class="error-message">Erreur : ${error.message}</p>`;
      }
    }

    async function selectTable(tableId) {
      state.selectedTable = tableId;

      // Highlight
      document.querySelectorAll('[data-table-id]').forEach(el => el.classList.remove('selected'));
      document.querySelector(`[data-table-id="${tableId}"]`)?.classList.add('selected');

      // Load preview
      switchExplorerTab('preview');
      await loadTablePreview();
    }

    async function loadTablePreview() {
      if (!state.selectedDocument || !state.selectedTable) return;

      const info = document.getElementById('preview-info');
      const table = document.getElementById('preview-table');

      info.textContent = 'Chargement...';
      table.querySelector('thead tr').innerHTML = '';
      table.querySelector('tbody').innerHTML = '';

      try {
        const result = await gristFetch(`/docs/${state.selectedDocument}/tables/${state.selectedTable}/records?limit=20`);
        state.tableData = result.records || [];

        if (state.tableData.length === 0) {
          info.textContent = 'Table vide';
          return;
        }

        // Get columns from first record
        const columns = Object.keys(state.tableData[0].fields || {});

        // Header
        let headerHtml = '<th>#</th>';
        columns.forEach(col => {
          headerHtml += `<th>${escapeHtml(col)}</th>`;
        });
        table.querySelector('thead tr').innerHTML = headerHtml;

        // Body
        let bodyHtml = '';
        state.tableData.forEach(record => {
          bodyHtml += '<tr>';
          bodyHtml += `<td>${record.id}</td>`;
          columns.forEach(col => {
            const val = record.fields[col];
            bodyHtml += `<td>${escapeHtml(String(val ?? ''))}</td>`;
          });
          bodyHtml += '</tr>';
        });
        table.querySelector('tbody').innerHTML = bodyHtml;

        info.textContent = `Table "${state.selectedTable}" — ${state.tableData.length} lignes affichées`;

        // Save as current source for builder
        saveCurrentAsSource();

        // Show favorite button
        document.getElementById('save-favorite-btn').style.display = '';

      } catch (error) {
        info.textContent = `Erreur : ${error.message}`;
      }
    }

    async function createGristTable() {
      if (!state.selectedDocument) {
        alert('Sélectionnez d\'abord un document Grist');
        return;
      }

      const tableName = document.getElementById('table-name').value.trim();
      if (!tableName) {
        alert('Veuillez entrer un nom de table');
        return;
      }

      // Collect columns
      const columnItems = document.querySelectorAll('#columns-list .column-item');
      const columns = [];

      columnItems.forEach(item => {
        const name = item.querySelector('input').value.trim();
        const type = item.querySelector('select').value;
        if (name) {
          columns.push({ id: name, fields: { type } });
        }
      });

      if (columns.length === 0) {
        alert('Ajoutez au moins une colonne');
        return;
      }

      try {
        const conn = state.connections[state.selectedConnection];

        // Utilise le proxy pour éviter CORS
        const createUrl = getProxyUrl(conn.url, `/docs/${state.selectedDocument}/tables`);

        const response = await fetch(createUrl, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${conn.apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            tables: [{
              id: tableName,
              columns: columns
            }]
          })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || `HTTP ${response.status}`);
        }

        alert(`Table "${tableName}" créée avec succès !`);
        closeModal('create-table-modal');

        // Refresh tables list
        await loadTables();

      } catch (error) {
        alert(`Erreur : ${error.message}`);
      }
    }

    function addColumnRow() {
      const container = document.getElementById('columns-list');
      const row = document.createElement('div');
      row.className = 'column-item';
      row.innerHTML = `
        <input class="fr-input fr-input--sm" type="text" placeholder="Nom de colonne">
        <select class="fr-select fr-select--sm" style="width: 120px;">
          <option value="Text">Texte</option>
          <option value="Numeric">Nombre</option>
          <option value="Date">Date</option>
          <option value="Bool">Booléen</option>
        </select>
        <button class="fr-btn fr-btn--sm fr-btn--tertiary" onclick="this.parentElement.remove()">
          <i class="ri-delete-bin-line"></i>
        </button>
      `;
      container.appendChild(row);
    }

    // ============================================================
    // SOURCES MANUELLES
    // ============================================================
    function renderSources() {
      const container = document.getElementById('sources-list');
      container.innerHTML = '';

      if (state.sources.length === 0) {
        container.innerHTML = '<p class="fr-text--sm" style="color: var(--text-mention-grey);">Aucune source</p>';
        return;
      }

      state.sources.forEach((source, index) => {
        const badge = source.type === 'grist' ? 'badge-grist' : source.type === 'manual' ? 'badge-manual' : 'badge-api';
        const badgeText = source.type === 'grist' ? 'Grist' : source.type === 'manual' ? 'Manuel' : 'API';

        const card = document.createElement('div');
        card.className = 'connection-card';
        card.innerHTML = `
          <div class="name" style="display: flex; align-items: center; gap: 0.5rem;">
            <span class="badge-source-type ${badge}">${badgeText}</span>
            <span style="flex: 1;">${escapeHtml(source.name)}</span>
            <button class="delete-source-btn" title="Supprimer cette source" style="background: none; border: none; cursor: pointer; color: var(--text-mention-grey); padding: 0.25rem; font-size: 0.875rem; line-height: 1; border-radius: 3px;">
              <i class="ri-delete-bin-line"></i>
            </button>
          </div>
          <div class="url">${source.recordCount || '?'} enregistrements</div>
        `;

        // Click on card to preview
        card.addEventListener('click', (e) => {
          if (!e.target.closest('.delete-source-btn')) {
            previewSource(index);
          }
        });

        // Delete button
        card.querySelector('.delete-source-btn').addEventListener('click', (e) => {
          e.stopPropagation();
          if (confirm(`Supprimer la source "${source.name}" ?`)) {
            deleteSource(index);
          }
        });

        // Context menu (right-click to delete) - keep as alternative
        card.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          if (confirm(`Supprimer la source "${source.name}" ?`)) {
            deleteSource(index);
          }
        });

        container.appendChild(card);
      });
    }

    // Variable to store current source mode
    let currentSourceMode = 'table';
    let parsedJsonData = null;
    let parsedCsvData = null;

    function switchSourceMode(mode) {
      currentSourceMode = mode;

      // Update tabs
      document.querySelectorAll('[data-source-mode]').forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-source-mode="${mode}"]`).classList.add('active');

      // Show/hide panels
      document.querySelectorAll('.source-mode-panel').forEach(p => p.style.display = 'none');
      document.getElementById(`source-mode-${mode}`).style.display = 'block';
    }

    function parseJsonInput() {
      const input = document.getElementById('json-input').value.trim();
      const dataPath = document.getElementById('json-data-path').value.trim();
      const preview = document.getElementById('json-preview');
      const countSpan = document.getElementById('json-preview-count');

      if (!input) {
        preview.style.display = 'none';
        parsedJsonData = null;
        return;
      }

      try {
        let data = JSON.parse(input);

        // Navigate to data path if specified
        if (dataPath) {
          const parts = dataPath.split('.');
          for (const part of parts) {
            if (data && typeof data === 'object') {
              data = data[part];
            }
          }
        }

        // Normalize to array
        if (!Array.isArray(data)) {
          data = data ? [data] : [];
        }

        parsedJsonData = data;
        countSpan.textContent = data.length;
        preview.style.display = 'block';
        preview.querySelector('p').style.color = 'var(--text-default-success)';

      } catch (e) {
        parsedJsonData = null;
        countSpan.textContent = 'Erreur JSON';
        preview.style.display = 'block';
        preview.querySelector('p').style.color = 'var(--text-default-error)';
      }
    }

    function handleCsvFile(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        parseCsvText(text);
      };
      reader.readAsText(file);
    }

    function parseCsvText(text) {
      const separatorSelect = document.getElementById('csv-separator').value;
      let separator = separatorSelect;

      // Auto-detect separator
      if (separator === 'auto') {
        const firstLine = text.split('\n')[0];
        if (firstLine.includes(';')) separator = ';';
        else if (firstLine.includes('\t')) separator = '\t';
        else separator = ',';
      }

      const lines = text.trim().split('\n');
      if (lines.length === 0) {
        parsedCsvData = null;
        return;
      }

      // Parse header
      const headers = parseCSVLine(lines[0], separator);

      // Parse data rows
      const data = [];
      for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i], separator);
        if (values.length === 0 || (values.length === 1 && values[0] === '')) continue;

        const row = {};
        headers.forEach((header, index) => {
          let val = values[index] || '';
          // Auto-detect numbers (gère formats FR et EN)
          if (looksLikeNumber(val)) {
            const num = toNumber(val);
            if (num !== null) {
              val = num;
            }
          }
          row[header] = val;
        });
        data.push(row);
      }

      parsedCsvData = data;

      // Show preview
      const preview = document.getElementById('csv-preview');
      const countSpan = document.getElementById('csv-preview-count');
      const table = document.getElementById('csv-preview-table');

      countSpan.textContent = data.length;
      preview.style.display = 'block';

      // Header
      let headerHtml = '';
      headers.forEach(h => {
        headerHtml += `<th>${escapeHtml(h)}</th>`;
      });
      table.querySelector('thead tr').innerHTML = headerHtml;

      // Body (first 5 rows)
      let bodyHtml = '';
      data.slice(0, 5).forEach(row => {
        bodyHtml += '<tr>';
        headers.forEach(h => {
          bodyHtml += `<td>${escapeHtml(String(row[h] ?? ''))}</td>`;
        });
        bodyHtml += '</tr>';
      });
      if (data.length > 5) {
        bodyHtml += `<tr><td colspan="${headers.length}" style="text-align: center; color: var(--text-mention-grey);">... et ${data.length - 5} autres lignes</td></tr>`;
      }
      table.querySelector('tbody').innerHTML = bodyHtml;
    }

    function parseCSVLine(line, separator) {
      const result = [];
      let current = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];

        if (char === '"') {
          if (inQuotes && line[i + 1] === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (char === separator && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());

      return result;
    }

    function saveManualSource() {
      const name = document.getElementById('source-name').value.trim();

      if (!name) {
        alert('Veuillez entrer un nom');
        return;
      }

      let data;

      if (currentSourceMode === 'table') {
        data = collectTableData();
        if (data.length === 0) {
          alert('Le tableau est vide. Ajoutez au moins une ligne avec des données.');
          return;
        }
      } else if (currentSourceMode === 'json') {
        if (!parsedJsonData || parsedJsonData.length === 0) {
          alert('Aucune donnée JSON valide. Vérifiez le format.');
          return;
        }
        data = parsedJsonData;
      } else if (currentSourceMode === 'csv') {
        if (!parsedCsvData || parsedCsvData.length === 0) {
          alert('Aucun fichier CSV chargé ou fichier vide.');
          return;
        }
        data = parsedCsvData;
      }

      const source = {
        id: Date.now().toString(),
        name,
        type: 'manual',
        data,
        recordCount: data.length
      };

      state.sources.push(source);
      saveToStorage(STORAGE_KEYS.SOURCES, state.sources);
      renderSources();
      closeModal('manual-source-modal');

      // Reset form
      resetManualSourceModal();
    }

    function resetManualSourceModal() {
      document.getElementById('source-name').value = '';
      resetTableEditor();

      // Reset JSON mode
      document.getElementById('json-input').value = '';
      document.getElementById('json-data-path').value = '';
      document.getElementById('json-preview').style.display = 'none';
      parsedJsonData = null;

      // Reset CSV mode
      document.getElementById('csv-file').value = '';
      document.getElementById('csv-separator').value = 'auto';
      document.getElementById('csv-preview').style.display = 'none';
      parsedCsvData = null;

      // Reset to table mode
      switchSourceMode('table');
    }

    function closeManualSourceModal() {
      closeModal('manual-source-modal');
      resetManualSourceModal();
    }

    // ============================================================
    // ÉDITEUR DE TABLEAU (source manuelle)
    // ============================================================
    function getTableEditor() {
      return document.getElementById('source-table-editor');
    }

    function getColumnCount() {
      // Subtract 2 for row-number and row-actions columns
      return getTableEditor().querySelector('thead tr').children.length - 2;
    }

    function addTableColumn() {
      const table = getTableEditor();
      const headerRow = table.querySelector('thead tr');
      const actionsHeader = headerRow.querySelector('th:last-child');

      const th = document.createElement('th');
      th.innerHTML = `<div class="col-header">
        <input type="text" value="" placeholder="Colonne">
        <button class="col-remove-btn" title="Supprimer la colonne" onclick="removeTableColumn(this)"><i class="ri-close-line"></i></button>
      </div>`;
      headerRow.insertBefore(th, actionsHeader);

      // Focus the new column name input
      th.querySelector('input').focus();

      // Add a cell to every body row
      table.querySelectorAll('tbody tr').forEach(row => {
        const actionsCell = row.querySelector('td:last-child');
        const td = document.createElement('td');
        td.innerHTML = '<input type="text" placeholder="...">';
        row.insertBefore(td, actionsCell);
      });
    }

    function removeTableColumn(btn) {
      if (getColumnCount() <= 1) {
        alert('Le tableau doit contenir au moins une colonne.');
        return;
      }
      const th = btn.closest('th');
      const headerRow = th.parentElement;
      const colIndex = Array.from(headerRow.children).indexOf(th);

      // Remove header
      th.remove();

      // Remove matching cell in each body row
      getTableEditor().querySelectorAll('tbody tr').forEach(row => {
        const cell = row.children[colIndex];
        if (cell) cell.remove();
      });
    }

    function addTableRow() {
      const table = getTableEditor();
      const tbody = table.querySelector('tbody');
      const colCount = getColumnCount();
      const rowNum = tbody.rows.length + 1;

      const tr = document.createElement('tr');
      tr.innerHTML = `<td class="row-number">${rowNum}</td>`
        + '<td><input type="text" placeholder="..."></td>'.repeat(colCount)
        + '<td class="row-actions"><button title="Supprimer la ligne" onclick="removeTableRow(this)"><i class="ri-close-line"></i></button></td>';
      tbody.appendChild(tr);

      // Focus the first input of the new row
      tr.querySelector('td:nth-child(2) input').focus();
    }

    function removeTableRow(btn) {
      const tbody = getTableEditor().querySelector('tbody');
      if (tbody.rows.length <= 1) {
        alert('Le tableau doit contenir au moins une ligne.');
        return;
      }
      btn.closest('tr').remove();
      renumberRows();
    }

    function renumberRows() {
      getTableEditor().querySelectorAll('tbody tr').forEach((row, i) => {
        row.querySelector('.row-number').textContent = i + 1;
      });
    }

    function collectTableData() {
      const table = getTableEditor();
      const headers = [];
      table.querySelectorAll('thead th .col-header input').forEach(input => {
        headers.push(input.value.trim() || `col_${headers.length + 1}`);
      });

      const data = [];
      table.querySelectorAll('tbody tr').forEach(row => {
        const cells = row.querySelectorAll('td:not(.row-number):not(.row-actions) input');
        const rowData = {};
        let hasValue = false;
        cells.forEach((input, i) => {
          let val = input.value.trim();
          // Auto-detect numbers (gère formats FR et EN)
          if (looksLikeNumber(val)) {
            const num = toNumber(val);
            if (num !== null) {
              val = num;
            }
          }
          rowData[headers[i]] = val;
          if (val !== '') hasValue = true;
        });
        if (hasValue) data.push(rowData);
      });

      return data;
    }

    function resetTableEditor() {
      const table = getTableEditor();
      // Reset header to 2 default columns
      table.querySelector('thead tr').innerHTML = `
        <th class="row-number">#</th>
        <th><div class="col-header"><input type="text" value="label" placeholder="Colonne"><button class="col-remove-btn" title="Supprimer la colonne" onclick="removeTableColumn(this)"><i class="ri-close-line"></i></button></div></th>
        <th><div class="col-header"><input type="text" value="valeur" placeholder="Colonne"><button class="col-remove-btn" title="Supprimer la colonne" onclick="removeTableColumn(this)"><i class="ri-close-line"></i></button></div></th>
        <th class="row-actions"></th>`;

      // Reset body to 3 empty rows
      let rows = '';
      for (let i = 1; i <= 3; i++) {
        rows += `<tr>
          <td class="row-number">${i}</td>
          <td><input type="text" placeholder="..."></td>
          <td><input type="text" placeholder="..."></td>
          <td class="row-actions"><button title="Supprimer la ligne" onclick="removeTableRow(this)"><i class="ri-close-line"></i></button></td>
        </tr>`;
      }
      table.querySelector('tbody').innerHTML = rows;
    }

    function deleteSource(index) {
      state.sources.splice(index, 1);
      saveToStorage(STORAGE_KEYS.SOURCES, state.sources);
      renderSources();
    }

    function previewSource(index) {
      const source = state.sources[index];
      console.log('previewSource called:', { index, source, hasData: !!source.data, dataLength: source.data?.length });

      document.getElementById('explorer-empty').style.display = 'none';
      document.getElementById('explorer-content').style.display = 'block';
      document.getElementById('explorer-title').textContent = source.name;

      // Hide connection explorer tabs for local sources
      document.getElementById('explorer-tabs').style.display = 'none';

      // Show preview tab
      switchExplorerTab('preview');

      const info = document.getElementById('preview-info');
      const table = document.getElementById('preview-table');

      if (!source.data || source.data.length === 0) {
        info.textContent = 'Source vide';
        // Still try to show export button for sources with recordCount but no loaded data
        state.previewedSource = source;
        // Legacy connections may not have type field - detect Grist by presence of 'url' (not 'apiUrl')
        const hasGristWithApiKey = state.connections.some(c => (c.type === 'grist' || (!c.type && c.url)) && !c.isPublic && c.apiKey);
        const exportBtn = document.getElementById('export-grist-btn');
        if (source.type === 'manual' && hasGristWithApiKey) {
          exportBtn.style.display = '';
        } else {
          exportBtn.style.display = 'none';
        }
        return;
      }

      const columns = Object.keys(source.data[0]);

      let headerHtml = '';
      columns.forEach(col => {
        headerHtml += `<th>${escapeHtml(col)}</th>`;
      });
      table.querySelector('thead tr').innerHTML = headerHtml;

      let bodyHtml = '';
      source.data.slice(0, 20).forEach(record => {
        bodyHtml += '<tr>';
        columns.forEach(col => {
          bodyHtml += `<td>${escapeHtml(String(record[col] ?? ''))}</td>`;
        });
        bodyHtml += '</tr>';
      });
      table.querySelector('tbody').innerHTML = bodyHtml;

      info.textContent = `${source.data.length} enregistrements`;

      // Save as selected for builder
      localStorage.setItem(STORAGE_KEYS.SELECTED_SOURCE, JSON.stringify(source));

      // Store previewed source for export
      state.previewedSource = source;

      // Show export button for local sources (manual) if we have Grist connections with API key
      // Note: Legacy connections may not have type field - detect Grist by presence of 'url' (not 'apiUrl')
      const gristConnections = state.connections.filter(c => c.type === 'grist' || (!c.type && c.url));
      const hasGristWithApiKey = gristConnections.some(c => !c.isPublic && c.apiKey);
      const exportBtn = document.getElementById('export-grist-btn');
      if (source.type === 'manual' && hasGristWithApiKey) {
        exportBtn.style.display = '';
      } else {
        exportBtn.style.display = 'none';
      }
    }

    function saveCurrentAsSource() {
      if (!state.selectedDocument || !state.selectedTable || state.tableData.length === 0) return;

      const conn = state.connections[state.selectedConnection];
      const doc = state.documents.find(d => d.id === state.selectedDocument);

      const source = {
        id: `grist_${state.selectedDocument}_${state.selectedTable}`,
        name: `${doc?.name || 'Doc'} / ${state.selectedTable}`,
        type: 'grist',
        connectionId: conn.id,
        documentId: state.selectedDocument,
        tableId: state.selectedTable,
        apiUrl: `${conn.url}/api/docs/${state.selectedDocument}/tables/${state.selectedTable}/records`,
        apiKey: conn.isPublic ? null : conn.apiKey,
        isPublic: conn.isPublic || false,
        data: state.tableData.map(r => r.fields),
        rawRecords: state.tableData,
        recordCount: state.tableData.length
      };

      localStorage.setItem(STORAGE_KEYS.SELECTED_SOURCE, JSON.stringify(source));
    }

    // ============================================================
    // EXPORT VERS GRIST
    // ============================================================
    function openExportGristModal() {
      if (!state.previewedSource) {
        alert('Aucune source sélectionnée');
        return;
      }

      // Populate connections dropdown (only Grist with API key)
      const select = document.getElementById('export-connection');
      select.innerHTML = '<option value="">-- Sélectionner --</option>';

      state.connections.forEach((conn, index) => {
        // Legacy connections may not have type field - detect Grist by presence of 'url' (not 'apiUrl')
        const isGrist = conn.type === 'grist' || (!conn.type && conn.url);
        if (isGrist && !conn.isPublic && conn.apiKey) {
          select.innerHTML += `<option value="${index}">${escapeHtml(conn.name)}</option>`;
        }
      });

      // Reset other fields
      document.getElementById('export-document').innerHTML = '<option value="">-- Sélectionner --</option>';
      document.getElementById('export-document-group').style.display = 'none';
      document.getElementById('export-table-name').value = state.previewedSource.name.replace(/[^a-zA-Z0-9_]/g, '_');
      document.getElementById('export-grist-confirm-btn').disabled = true;

      // Show preview info
      const source = state.previewedSource;
      if (source.data && source.data.length > 0) {
        document.getElementById('export-record-count').textContent = source.data.length;
        document.getElementById('export-column-count').textContent = Object.keys(source.data[0]).length;
        document.getElementById('export-preview').style.display = 'block';
      } else {
        document.getElementById('export-preview').style.display = 'none';
      }

      openModal('export-grist-modal');
    }

    async function loadExportDocuments() {
      const connIndex = document.getElementById('export-connection').value;
      const docSelect = document.getElementById('export-document');
      const docGroup = document.getElementById('export-document-group');

      if (!connIndex) {
        docGroup.style.display = 'none';
        docSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
        updateExportButton();
        return;
      }

      const conn = state.connections[parseInt(connIndex)];

      try {
        docSelect.innerHTML = '<option value="">Chargement...</option>';
        docGroup.style.display = 'block';

        // Grist API: First get orgs, then workspaces with their documents
        const orgsUrl = getProxyUrl(conn.url, '/orgs');
        const orgsResponse = await fetch(orgsUrl, {
          headers: { 'Authorization': `Bearer ${conn.apiKey}` }
        });

        if (!orgsResponse.ok) throw new Error(`HTTP ${orgsResponse.status}`);

        const orgs = await orgsResponse.json();

        // Collect all documents from all workspaces
        const allDocs = [];

        for (const org of orgs) {
          try {
            const wsUrl = getProxyUrl(conn.url, `/orgs/${org.id}/workspaces`);
            const wsResponse = await fetch(wsUrl, {
              headers: { 'Authorization': `Bearer ${conn.apiKey}` }
            });

            if (wsResponse.ok) {
              const workspaces = await wsResponse.json();
              for (const ws of workspaces) {
                if (ws.docs && ws.docs.length > 0) {
                  for (const doc of ws.docs) {
                    allDocs.push({
                      id: doc.id,
                      name: doc.name,
                      workspace: ws.name,
                      org: org.name
                    });
                  }
                }
              }
            }
          } catch (e) {
            console.warn(`Erreur workspace org ${org.id}:`, e);
          }
        }

        docSelect.innerHTML = '<option value="">-- Sélectionner --</option>';
        if (allDocs.length === 0) {
          docSelect.innerHTML = '<option value="">Aucun document trouvé</option>';
        } else {
          allDocs.forEach(doc => {
            const label = `${doc.name} (${doc.workspace})`;
            docSelect.innerHTML += `<option value="${doc.id}">${escapeHtml(label)}</option>`;
          });
        }

      } catch (error) {
        docSelect.innerHTML = '<option value="">Erreur de chargement</option>';
        console.error('Erreur chargement documents:', error);
      }

      updateExportButton();
    }

    function updateExportButton() {
      const connIndex = document.getElementById('export-connection').value;
      const docId = document.getElementById('export-document').value;
      const tableName = document.getElementById('export-table-name').value.trim();

      const btn = document.getElementById('export-grist-confirm-btn');
      btn.disabled = !connIndex || !docId || !tableName;
    }

    async function exportToGrist() {
      const source = state.previewedSource;
      if (!source || !source.data || source.data.length === 0) {
        alert('Aucune donnée à exporter');
        return;
      }

      const connIndex = parseInt(document.getElementById('export-connection').value);
      const docId = document.getElementById('export-document').value;
      const tableName = document.getElementById('export-table-name').value.trim();

      if (!connIndex && connIndex !== 0 || !docId || !tableName) {
        alert('Veuillez remplir tous les champs');
        return;
      }

      const conn = state.connections[connIndex];
      const btn = document.getElementById('export-grist-confirm-btn');

      btn.disabled = true;
      btn.innerHTML = '<i class="ri-loader-4-line"></i> Création...';

      try {
        // Helper to sanitize column names for Grist (only alphanumeric and underscore)
        function sanitizeColumnId(name) {
          return name
            .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Remove accents
            .replace(/[^a-zA-Z0-9_]/g, '_') // Replace invalid chars with underscore
            .replace(/^(\d)/, '_$1') // Prefix with _ if starts with digit
            .replace(/_+/g, '_') // Collapse multiple underscores
            .replace(/^_|_$/g, ''); // Trim underscores
        }

        // 1. Build columns from data with sanitized IDs
        const firstRecord = source.data[0];
        const columnMapping = {}; // originalKey -> sanitizedKey
        const columns = Object.keys(firstRecord).map(key => {
          const sanitizedId = sanitizeColumnId(key);
          columnMapping[key] = sanitizedId;
          const value = firstRecord[key];
          let type = 'Text';
          if (typeof value === 'number') type = 'Numeric';
          else if (typeof value === 'boolean') type = 'Bool';
          return { id: sanitizedId, fields: { type, label: key } }; // Use original as label
        });

        // 2. Create table
        const createTableUrl = getProxyUrl(conn.url, `/docs/${docId}/tables`);
        const createResponse = await fetch(createTableUrl, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${conn.apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            tables: [{ id: tableName, columns }]
          })
        });

        if (!createResponse.ok) {
          const error = await createResponse.json();
          throw new Error(error.error || `Erreur création table: HTTP ${createResponse.status}`);
        }

        // 3. Insert records (with sanitized column keys)
        btn.innerHTML = '<i class="ri-loader-4-line"></i> Insertion des données...';

        const records = source.data.map(record => {
          const sanitizedFields = {};
          for (const [key, value] of Object.entries(record)) {
            sanitizedFields[columnMapping[key] || key] = value;
          }
          return { fields: sanitizedFields };
        });

        const insertUrl = getProxyUrl(conn.url, `/docs/${docId}/tables/${tableName}/records`);
        const insertResponse = await fetch(insertUrl, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${conn.apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ records })
        });

        if (!insertResponse.ok) {
          const error = await insertResponse.json();
          throw new Error(error.error || `Erreur insertion: HTTP ${insertResponse.status}`);
        }

        alert(`Table "${tableName}" créée avec ${source.data.length} enregistrements !`);
        closeModal('export-grist-modal');

        // If we're viewing this connection, refresh
        if (state.selectedConnection === connIndex && state.selectedDocument === docId) {
          await loadTables();
        }

      } catch (error) {
        alert(`Erreur : ${error.message}`);
        console.error('Erreur export Grist:', error);
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="ri-upload-cloud-line"></i> Créer la table';
      }
    }

    // ============================================================
    // UI HELPERS
    // ============================================================
    function switchExplorerTab(tabId) {
      if (!tabId) return;

      // Only affect explorer tabs, not modal tabs
      document.querySelectorAll('.explorer-tabs:not(#source-mode-tabs) .explorer-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(p => p.style.display = 'none');

      const tabBtn = document.querySelector(`.explorer-tabs:not(#source-mode-tabs) [data-tab="${tabId}"]`);
      const tabPanel = document.getElementById(`tab-${tabId}`);

      if (tabBtn) tabBtn.classList.add('active');
      if (tabPanel) tabPanel.style.display = 'block';
    }

    function showExplorerEmpty() {
      document.getElementById('explorer-empty').style.display = 'block';
      document.getElementById('explorer-content').style.display = 'none';
    }

    function refreshCurrentView() {
      if (state.selectedConnection !== null) {
        loadDocuments();
      }
    }

    function openInBuilder() {
      // Source is already saved in localStorage
      window.location.href = 'builder.html';
    }

    // Convertit une valeur en nombre (gère les formats FR et EN)
    function toNumber(val) {
      if (typeof val === 'number') return isNaN(val) ? null : val;
      if (typeof val !== 'string') return null;

      let cleaned = val.trim();
      if (cleaned === '') return null;

      // Supprimer les espaces (séparateurs de milliers)
      cleaned = cleaned.replace(/\s/g, '');

      const hasComma = cleaned.includes(',');
      const hasDot = cleaned.includes('.');

      if (hasComma && hasDot) {
        // Format mixte : déterminer quel est le séparateur décimal
        const lastComma = cleaned.lastIndexOf(',');
        const lastDot = cleaned.lastIndexOf('.');
        if (lastComma > lastDot) {
          // Virgule après point : format FR (1.234,56)
          cleaned = cleaned.replace(/\./g, '').replace(',', '.');
        } else {
          // Point après virgule : format EN (1,234.56)
          cleaned = cleaned.replace(/,/g, '');
        }
      } else if (hasComma) {
        // Seulement virgule : format FR (1234,56)
        cleaned = cleaned.replace(',', '.');
      }

      const num = parseFloat(cleaned);
      return isNaN(num) ? null : num;
    }

    // Détecte si une valeur ressemble à un nombre
    function looksLikeNumber(val) {
      if (typeof val !== 'string') return false;
      const cleaned = val.trim();
      if (cleaned === '') return false;
      // Accepte : 123, 123.45, 123,45, 1 234, 1 234,56, -123, etc.
      return /^-?[\d\s]+([.,]\d+)?$/.test(cleaned);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>

  <!-- Footer -->
  <app-footer base-path=""></app-footer>

  <script type="module" src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.module.min.js"></script>
</body>
</html>
