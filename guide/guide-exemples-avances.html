<!DOCTYPE html>
<html lang="fr" data-fr-theme>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recherche et facettes multizone — Exemples avances - Guide - gouv-widgets</title>
  <style>@view-transition{navigation:auto}app-header:not(:defined){display:block;min-height:56px}app-footer:not(:defined){display:block;min-height:48px}</style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/utility/utility.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr-chart@2.0.4/dist/DSFRChart/DSFRChart.css">
  <script type="module" src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr-chart@2.0.4/dist/DSFRChart/DSFRChart.js"></script>
  <script type="module" src="/dist/gouv-widgets.esm.js"></script>
  <style>
    .guide-layout { display: flex; gap: 2rem; }
    .guide-sidemenu { flex: 0 0 280px; position: sticky; top: 1rem; height: fit-content; max-height: calc(100vh - 2rem); overflow-y: auto; }
    .guide-content { flex: 1; min-width: 0; }
    @media (max-width: 992px) {
      .guide-layout { flex-direction: column; }
      .guide-sidemenu { position: static; flex: none; max-height: none; }
    }
    .guide-content h2 { padding-top: 2rem; border-top: 1px solid var(--border-default-grey); margin-top: 3rem; }
    .guide-content h2:first-of-type { border-top: none; margin-top: 0; padding-top: 0; }
    .guide-content h3 { margin-top: 2rem; }
    .guide-content h4 { margin-top: 1.5rem; }
    .guide-content pre { background: #1e1e1e; color: #d4d4d4; padding: 1rem; border-radius: 4px; font-family: monospace; font-size: 0.85rem; overflow-x: auto; white-space: pre-wrap; margin: 0; }
    .guide-content ol, .guide-content ul { margin: 0.5rem 0 1rem 1.5rem; }
    .guide-content li { margin-bottom: 0.25rem; }
    .fr-sidemenu__link[aria-current="true"] { font-weight: 700; color: var(--text-action-high-blue-france); }
    .example-container { border: 1px solid var(--border-default-grey); border-radius: 4px; padding: 1rem; background: white; min-height: 100px; }
    .pipeline-diagram { background: var(--background-alt-grey); padding: 1rem 1.5rem; border-radius: 4px; font-family: monospace; font-size: 0.85rem; line-height: 1.6; white-space: pre; overflow-x: auto; }
    .rappel-card .fr-card__img img { width: 100%; height: 180px; object-fit: contain; background: #f6f6f6; }
  </style>
</head>
<body>
  <app-header current-page="guide" base-path="../"></app-header>

  <main class="fr-container fr-py-4w" id="main-content">
    <div class="guide-layout">

      <nav class="fr-sidemenu guide-sidemenu" role="navigation" aria-labelledby="guide-sidemenu-title">
        <div class="fr-sidemenu__inner">
          <button class="fr-sidemenu__btn" hidden aria-controls="guide-sidemenu-wrapper" aria-expanded="true">Menu</button>
          <div class="fr-collapse" id="guide-sidemenu-wrapper">
            <div class="fr-sidemenu__title" id="guide-sidemenu-title">Guide utilisateur</div>
            <ul class="fr-sidemenu__list">
              <li class="fr-sidemenu__item">
                <a class="fr-sidemenu__link" href="guide.html">Vue d'ensemble</a>
              </li>
              <li class="fr-sidemenu__item">
                <a class="fr-sidemenu__link" href="guide-parcours.html">Parcours utilisateur</a>
              </li>
              <li class="fr-sidemenu__item">
                <a class="fr-sidemenu__link" href="guide-exemples-source.html">gouv-source</a>
              </li>
              <li class="fr-sidemenu__item">
                <a class="fr-sidemenu__link" href="guide-exemples-normalize.html">gouv-normalize</a>
              </li>
              <li class="fr-sidemenu__item">
                <a class="fr-sidemenu__link" href="guide-exemples-query.html">gouv-query</a>
              </li>
              <li class="fr-sidemenu__item">
                <a class="fr-sidemenu__link" href="guide-exemples-search.html">gouv-search</a>
              </li>
              <li class="fr-sidemenu__item">
                <a class="fr-sidemenu__link" href="guide-exemples-facets.html">gouv-facets</a>
              </li>
              <li class="fr-sidemenu__item">
                <a class="fr-sidemenu__link" href="guide-exemples-display.html">gouv-display</a>
              </li>
              <li class="fr-sidemenu__item">
                <a class="fr-sidemenu__link" href="guide-exemples-raw-data.html">gouv-raw-data</a>
              </li>
            </ul>
            <div class="fr-sidemenu__title fr-mt-1w" id="guide-sidemenu-title-advanced">Exemples avances</div>
            <ul class="fr-sidemenu__list">
              <li class="fr-sidemenu__item fr-sidemenu__item--active">
                <a class="fr-sidemenu__link" href="guide-exemples-avances.html" aria-current="true">Recherche et facettes multizone</a>
              </li>
            </ul>
          </div>
        </div>
      </nav>

      <div class="guide-content">

        <h1><i class="ri-rocket-line fr-mr-1w"></i>Recherche et facettes multizone</h1>
        <p class="fr-text--lead">
          Pipeline avance combinant recherche serveur, facettes serveur et split client-side en plusieurs zones d'affichage.
        </p>

        <h4>Architecture du pipeline</h4>
        <div class="pipeline-diagram">gouv-query "q" (server-side, ODS, 100 resultats)
  |-- gouv-search (server-search) --> envoie search() a q
  |-- gouv-facets "filtered" (server-facets) --> envoie where a q, re-emet les donnees
        |-- gouv-query "alim" (client, filtre Aliment, limit 3)
        |     \-- gouv-display (cartes, 3 cols)
        |-- gouv-query "autres" (client, filtre non-Aliment, limit 3)
        |     \-- gouv-display (cartes, 3 cols)
        \-- gouv-display (liste complete, pagination 20)</div>

        <p class="fr-mt-2w">
          La source <code>gouv-source</code> server-side charge 100 resultats depuis l'API ODS RappelConso.
          La recherche et les facettes envoient chacune un <code>where</code> a la source (merge via <code>whereKey</code>).
          Les donnees filtrees sont re-emises par <code>gouv-facets</code> sous l'id <code>"filtered"</code>,
          puis splitees par deux <code>gouv-query</code> client-side (alimentation / autres) avant affichage en trois zones.
        </p>

        <h4 class="fr-mt-3w">Exemple live</h4>

        <!-- ============================================================= -->
        <!-- LIVE EXAMPLE                                                    -->
        <!-- ============================================================= -->

        <gouv-source id="q"
          api-type="opendatasoft"
          dataset-id="rappelconso-v2-gtin-trie"
          base-url="https://data.economie.gouv.fr"
          order-by="date_publication:desc"
          server-side
          page-size="100">
        </gouv-source>

        <gouv-search source="q" server-search
          placeholder="Rechercher un produit, une marque, un numero de fiche..."
          count>
        </gouv-search>

        <gouv-facets id="filtered" source="q" server-facets
          fields="categorie_produit, sous_categorie_produit"
          labels="categorie_produit:Categorie de produit | sous_categorie_produit:Sous-categorie de produit"
          display="categorie_produit:multiselect | sous_categorie_produit:multiselect"
          max-values="8">
        </gouv-facets>

        <gouv-query id="alim" source="filtered"
          where="categorie_produit:contains:Aliment"
          order-by="date_publication:desc"
          limit="3">
        </gouv-query>

        <gouv-query id="autres" source="filtered"
          where="categorie_produit:notcontains:Aliment"
          order-by="date_publication:desc"
          limit="3">
        </gouv-query>

        <div class="fr-my-4w">

          <h2 class="fr-h3" style="border-top: none; margin-top: 0; padding-top: 0;">Rappels de produits</h2>

          <h3 class="fr-h5 fr-mt-4w fr-mb-2w">Alimentation — derniers rappels</h3>

          <gouv-display source="alim" cols="3"
            empty="Aucun rappel alimentaire recent.">
            <template>
              <div class="fr-card fr-card--shadow rappel-card">
                <div class="fr-card__body">
                  <div class="fr-card__content">
                    <h3 class="fr-card__title">
                      <a href="{{lien_vers_la_fiche_rappel}}" target="_blank" rel="noopener noreferrer">{{libelle}}</a>
                    </h3>
                    <p class="fr-card__desc">{{motif_rappel}}</p>
                    <div class="fr-card__start">
                      <ul class="fr-badges-group">
                        <li><p class="fr-badge fr-badge--sm fr-badge--green-emeraude">{{categorie_produit}}</p></li>
                        <li><p class="fr-badge fr-badge--sm">{{sous_categorie_produit}}</p></li>
                      </ul>
                    </div>
                  </div>
                </div>
                <div class="fr-card__header">
                  <div class="fr-card__img">
                    <img class="fr-responsive-img"
                         src="{{liens_vers_les_images}}"
                         alt="{{libelle}}"
                         onerror="this.parentElement.parentElement.style.display='none'">
                  </div>
                </div>
              </div>
            </template>
          </gouv-display>

          <hr class="fr-hr fr-mt-4w fr-mb-4w">

          <h3 class="fr-h5 fr-mb-2w">Autres categories — derniers rappels</h3>

          <gouv-display source="autres" cols="3"
            empty="Aucun rappel recent hors alimentation.">
            <template>
              <div class="fr-card fr-card--shadow rappel-card">
                <div class="fr-card__body">
                  <div class="fr-card__content">
                    <h3 class="fr-card__title">
                      <a href="{{lien_vers_la_fiche_rappel}}" target="_blank" rel="noopener noreferrer">{{libelle}}</a>
                    </h3>
                    <p class="fr-card__desc">{{motif_rappel}}</p>
                    <div class="fr-card__start">
                      <ul class="fr-badges-group">
                        <li><p class="fr-badge fr-badge--sm fr-badge--green-emeraude">{{categorie_produit}}</p></li>
                        <li><p class="fr-badge fr-badge--sm">{{sous_categorie_produit}}</p></li>
                      </ul>
                    </div>
                  </div>
                </div>
                <div class="fr-card__header">
                  <div class="fr-card__img">
                    <img class="fr-responsive-img"
                         src="{{liens_vers_les_images}}"
                         alt="{{libelle}}"
                         onerror="this.parentElement.parentElement.style.display='none'">
                  </div>
                </div>
              </div>
            </template>
          </gouv-display>

          <hr class="fr-hr fr-mt-4w fr-mb-4w">

          <h3 class="fr-h5 fr-mb-2w">Tous les rappels</h3>

          <gouv-display source="filtered" cols="1" pagination="20"
            empty="Aucun rappel trouve pour ces criteres.">
            <template>
              <div class="fr-card fr-card--horizontal fr-card--shadow rappel-card">
                <div class="fr-card__body">
                  <div class="fr-card__content">
                    <h3 class="fr-card__title">
                      <a href="{{lien_vers_la_fiche_rappel}}" target="_blank" rel="noopener noreferrer">{{libelle}}</a>
                    </h3>
                    <p class="fr-card__desc">{{motif_rappel}}</p>
                    <div class="fr-card__start">
                      <ul class="fr-badges-group">
                        <li><p class="fr-badge fr-badge--sm fr-badge--green-emeraude">{{categorie_produit}}</p></li>
                        <li><p class="fr-badge fr-badge--sm">{{sous_categorie_produit}}</p></li>
                      </ul>
                    </div>
                  </div>
                </div>
                <div class="fr-card__header">
                  <div class="fr-card__img">
                    <img class="fr-responsive-img"
                         src="{{liens_vers_les_images}}"
                         alt="{{libelle}}"
                         onerror="this.parentElement.parentElement.style.display='none'">
                  </div>
                </div>
              </div>
            </template>
          </gouv-display>

        </div>

        <!-- Code source -->
        <section class="fr-accordion fr-mt-2w">
          <h3 class="fr-accordion__title"><button class="fr-accordion__btn" aria-expanded="false" aria-controls="code-avance">Code source complet</button></h3>
          <div class="fr-collapse" id="code-avance">
<pre class="example-code">&lt;style&gt;
  .rappel-card .fr-card__img img {
    width: 100%; height: 180px; object-fit: contain; background: #f6f6f6;
  }
&lt;/style&gt;

&lt;!-- Source commune --&gt;
&lt;gouv-source id="q"
  api-type="opendatasoft"
  dataset-id="rappelconso-v2-gtin-trie"
  base-url="https://data.economie.gouv.fr"
  order-by="date_publication:desc"
  server-side
  page-size="100"&gt;
&lt;/gouv-source&gt;

&lt;!-- Recherche server-side --&gt;
&lt;gouv-search source="q" server-search
  placeholder="Rechercher un produit, une marque, un numero de fiche..."
  count&gt;
&lt;/gouv-search&gt;

&lt;!-- Facettes server-side (mode dropdown DSFR) --&gt;
&lt;gouv-facets id="filtered" source="q" server-facets
  fields="categorie_produit, sous_categorie_produit"
  labels="categorie_produit:Categorie de produit | sous_categorie_produit:Sous-categorie de produit"
  display="categorie_produit:multiselect | sous_categorie_produit:multiselect"
  max-values="8"&gt;
&lt;/gouv-facets&gt;

&lt;!-- Split client-side : alimentation (3 plus recents) --&gt;
&lt;gouv-query id="alim" source="filtered"
  where="categorie_produit:contains:Aliment"
  order-by="date_publication:desc"
  limit="3"&gt;
&lt;/gouv-query&gt;

&lt;!-- Split client-side : autres (3 plus recents) --&gt;
&lt;gouv-query id="autres" source="filtered"
  where="categorie_produit:notcontains:Aliment"
  order-by="date_publication:desc"
  limit="3"&gt;
&lt;/gouv-query&gt;

&lt;div class="fr-container fr-my-4w"&gt;
  &lt;h1 class="fr-h2"&gt;Rappels de produits&lt;/h1&gt;

  &lt;h2 class="fr-h4 fr-mt-4w fr-mb-2w"&gt;Alimentation — derniers rappels&lt;/h2&gt;
  &lt;gouv-display source="alim" cols="3"
    empty="Aucun rappel alimentaire recent."&gt;
    &lt;template&gt;
      &lt;div class="fr-card fr-card--shadow rappel-card"&gt;
        &lt;div class="fr-card__body"&gt;
          &lt;div class="fr-card__content"&gt;
            &lt;h3 class="fr-card__title"&gt;
              &lt;a href="{{lien_vers_la_fiche_rappel}}" target="_blank" rel="noopener noreferrer"&gt;{{libelle}}&lt;/a&gt;
            &lt;/h3&gt;
            &lt;p class="fr-card__desc"&gt;{{motif_rappel}}&lt;/p&gt;
            &lt;div class="fr-card__start"&gt;
              &lt;ul class="fr-badges-group"&gt;
                &lt;li&gt;&lt;p class="fr-badge fr-badge--sm fr-badge--green-emeraude"&gt;{{categorie_produit}}&lt;/p&gt;&lt;/li&gt;
                &lt;li&gt;&lt;p class="fr-badge fr-badge--sm"&gt;{{sous_categorie_produit}}&lt;/p&gt;&lt;/li&gt;
              &lt;/ul&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class="fr-card__header"&gt;
          &lt;div class="fr-card__img"&gt;
            &lt;img class="fr-responsive-img"
                 src="{{liens_vers_les_images}}"
                 alt="{{libelle}}"
                 onerror="this.parentElement.parentElement.style.display='none'"&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/template&gt;
  &lt;/gouv-display&gt;

  &lt;hr class="fr-hr fr-mt-4w fr-mb-4w"&gt;

  &lt;h2 class="fr-h4 fr-mb-2w"&gt;Autres categories — derniers rappels&lt;/h2&gt;
  &lt;gouv-display source="autres" cols="3"
    empty="Aucun rappel recent hors alimentation."&gt;
    &lt;template&gt;
      &lt;div class="fr-card fr-card--shadow rappel-card"&gt;
        &lt;!-- meme template que ci-dessus --&gt;
        &lt;div class="fr-card__body"&gt;
          &lt;div class="fr-card__content"&gt;
            &lt;h3 class="fr-card__title"&gt;
              &lt;a href="{{lien_vers_la_fiche_rappel}}" target="_blank" rel="noopener noreferrer"&gt;{{libelle}}&lt;/a&gt;
            &lt;/h3&gt;
            &lt;p class="fr-card__desc"&gt;{{motif_rappel}}&lt;/p&gt;
            &lt;div class="fr-card__start"&gt;
              &lt;ul class="fr-badges-group"&gt;
                &lt;li&gt;&lt;p class="fr-badge fr-badge--sm fr-badge--green-emeraude"&gt;{{categorie_produit}}&lt;/p&gt;&lt;/li&gt;
                &lt;li&gt;&lt;p class="fr-badge fr-badge--sm"&gt;{{sous_categorie_produit}}&lt;/p&gt;&lt;/li&gt;
              &lt;/ul&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class="fr-card__header"&gt;
          &lt;div class="fr-card__img"&gt;
            &lt;img class="fr-responsive-img"
                 src="{{liens_vers_les_images}}"
                 alt="{{libelle}}"
                 onerror="this.parentElement.parentElement.style.display='none'"&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/template&gt;
  &lt;/gouv-display&gt;

  &lt;hr class="fr-hr fr-mt-4w fr-mb-4w"&gt;

  &lt;h2 class="fr-h4 fr-mb-2w"&gt;Tous les rappels&lt;/h2&gt;
  &lt;gouv-display source="filtered" cols="1" pagination="20"
    empty="Aucun rappel trouve pour ces criteres."&gt;
    &lt;template&gt;
      &lt;div class="fr-card fr-card--horizontal fr-card--shadow rappel-card"&gt;
        &lt;div class="fr-card__body"&gt;
          &lt;div class="fr-card__content"&gt;
            &lt;h3 class="fr-card__title"&gt;
              &lt;a href="{{lien_vers_la_fiche_rappel}}" target="_blank" rel="noopener noreferrer"&gt;{{libelle}}&lt;/a&gt;
            &lt;/h3&gt;
            &lt;p class="fr-card__desc"&gt;{{motif_rappel}}&lt;/p&gt;
            &lt;div class="fr-card__start"&gt;
              &lt;ul class="fr-badges-group"&gt;
                &lt;li&gt;&lt;p class="fr-badge fr-badge--sm fr-badge--green-emeraude"&gt;{{categorie_produit}}&lt;/p&gt;&lt;/li&gt;
                &lt;li&gt;&lt;p class="fr-badge fr-badge--sm"&gt;{{sous_categorie_produit}}&lt;/p&gt;&lt;/li&gt;
              &lt;/ul&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/div&gt;
        &lt;div class="fr-card__header"&gt;
          &lt;div class="fr-card__img"&gt;
            &lt;img class="fr-responsive-img"
                 src="{{liens_vers_les_images}}"
                 alt="{{libelle}}"
                 onerror="this.parentElement.parentElement.style.display='none'"&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/template&gt;
  &lt;/gouv-display&gt;
&lt;/div&gt;</pre>
          </div>
        </section>

        <!-- Points cles -->
        <h4 class="fr-mt-3w">Points cles de cet exemple</h4>
        <ul>
          <li><strong>1 seule source serveur</strong> : <code>gouv-query server-side</code> charge 100 resultats depuis l'API ODS.</li>
          <li><strong>Recherche + facettes</strong> : <code>gouv-search server-search</code> et <code>gouv-facets server-facets</code> envoient chacun un <code>where</code> au query, merges via <code>whereKey</code>.</li>
          <li><strong>Split client-side</strong> : deux <code>gouv-query</code> filtrent localement les donnees re-emises par les facettes (alimentation vs autres).</li>
          <li><strong>3 zones d'affichage</strong> : les 3 derniers rappels alimentaires, les 3 derniers autres, et la liste complete paginee.</li>
          <li><strong>Cross-facet</strong> : les compteurs de chaque facette tiennent compte des selections des autres facettes.</li>
        </ul>

      </div>
    </div>
  </main>

  <app-footer base-path="../"></app-footer>

  <script type="module" src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.module.min.js"></script>
</body>
</html>
