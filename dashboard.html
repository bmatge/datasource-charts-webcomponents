<!DOCTYPE html>
<html lang="fr" data-fr-theme>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Visual Dashboard Editor - gouv-widgets</title>

  <!-- DSFR -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/utility/utility.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css">

  <!-- DSFR Chart -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr-chart@2.0.4/dist/DSFRChart/DSFRChart.css">
  <script type="module" src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr-chart@2.0.4/dist/DSFRChart/DSFRChart.js"></script>

  <!-- gouv-widgets -->
  <script type="module" src="/dist/gouv-widgets.esm.js"></script>

  <style>
    :root {
      --vde-sidebar-width: 320px;
      --vde-header-height: 60px;
    }

    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      margin: 0;
    }

    /* Layout principal */
    .vde-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Sidebar gauche */
    .vde-sidebar {
      width: var(--vde-sidebar-width);
      background: var(--background-alt-grey);
      border-right: 1px solid var(--border-default-grey);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }

    .vde-sidebar-section {
      padding: 1rem;
      border-bottom: 1px solid var(--border-default-grey);
    }

    .vde-sidebar-section h3 {
      margin: 0 0 0.75rem 0;
      font-size: 0.875rem;
      font-weight: 700;
      text-transform: uppercase;
      color: var(--text-mention-grey);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Widgets library */
    .widget-library {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
    }

    .widget-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 0.75rem;
      background: var(--background-default-grey);
      border: 2px dashed var(--border-default-grey);
      border-radius: 8px;
      cursor: grab;
      transition: all 0.2s ease;
      text-align: center;
    }

    .widget-item:hover {
      border-color: var(--border-action-high-blue-france);
      background: var(--background-alt-blue-france);
    }

    .widget-item.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }

    .widget-item i {
      font-size: 1.5rem;
      margin-bottom: 0.25rem;
      color: var(--text-action-high-blue-france);
    }

    .widget-item span {
      font-size: 0.75rem;
      font-weight: 500;
    }

    /* Favoris list */
    .favorites-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-height: 200px;
      overflow-y: auto;
    }

    .favorite-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      background: var(--background-default-grey);
      border: 1px solid var(--border-default-grey);
      border-radius: 4px;
      cursor: grab;
      font-size: 0.875rem;
    }

    .favorite-item:hover {
      border-color: var(--border-action-high-blue-france);
    }

    .favorite-item i {
      color: var(--text-label-yellow-tournesol);
    }

    .favorites-empty {
      color: var(--text-mention-grey);
      font-size: 0.875rem;
      font-style: italic;
    }

    /* Grid settings */
    .grid-settings {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .grid-settings label {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      font-size: 0.875rem;
    }

    .grid-settings select,
    .grid-settings input[type="text"] {
      padding: 0.5rem;
      border: 1px solid var(--border-default-grey);
      border-radius: 4px;
      font-size: 0.875rem;
    }

    /* Zone principale */
    .vde-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .vde-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 1rem;
      background: var(--background-default-grey);
      border-bottom: 1px solid var(--border-default-grey);
    }

    .vde-toolbar-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .vde-toolbar-right {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .dashboard-title-input {
      font-size: 1.25rem;
      font-weight: 700;
      border: none;
      background: transparent;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      min-width: 200px;
    }

    .dashboard-title-input:hover,
    .dashboard-title-input:focus {
      background: var(--background-alt-grey);
      outline: none;
    }

    /* Zone de prévisualisation */
    .vde-preview {
      flex: 1;
      overflow: auto;
      padding: 1.5rem;
      background: var(--background-contrast-grey);
    }

    .vde-canvas {
      background: var(--background-default-grey);
      border-radius: 8px;
      padding: 1.5rem;
      min-height: 400px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* Grille du dashboard */
    .dashboard-grid {
      min-height: 200px;
    }

    .dashboard-row {
      min-height: 120px;
      margin-bottom: 1rem;
    }

    .dashboard-row:last-child {
      margin-bottom: 0;
    }

    /* Cellule de dépôt */
    .drop-cell {
      min-height: 100px;
      border: 2px dashed var(--border-default-grey);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      background: var(--background-alt-grey);
      position: relative;
    }

    .drop-cell.empty {
      cursor: pointer;
    }

    .drop-cell.empty:hover {
      border-color: var(--border-action-high-blue-france);
      background: var(--background-alt-blue-france);
    }

    .drop-cell.drag-over {
      border-color: var(--border-action-high-blue-france);
      background: var(--background-alt-blue-france);
      border-style: solid;
    }

    .drop-cell-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-mention-grey);
    }

    .drop-cell-placeholder i {
      font-size: 1.5rem;
    }

    .drop-cell-placeholder span {
      font-size: 0.875rem;
    }

    /* Widget dans la grille */
    .dashboard-widget {
      position: relative;
      background: var(--background-default-grey);
      border: 1px solid var(--border-default-grey);
      border-radius: 8px;
      padding: 1rem;
      min-height: 100px;
    }

    .dashboard-widget:hover {
      border-color: var(--border-action-high-blue-france);
    }

    .dashboard-widget.selected {
      border-color: var(--border-action-high-blue-france);
      box-shadow: 0 0 0 2px var(--background-alt-blue-france);
    }

    .widget-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-default-grey);
    }

    .widget-title {
      font-size: 0.875rem;
      font-weight: 600;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .widget-title i {
      color: var(--text-action-high-blue-france);
    }

    .widget-actions {
      display: flex;
      gap: 0.25rem;
    }

    .widget-action-btn {
      padding: 0.25rem;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-mention-grey);
      border-radius: 4px;
    }

    .widget-action-btn:hover {
      background: var(--background-alt-grey);
      color: var(--text-action-high-blue-france);
    }

    .widget-content {
      min-height: 60px;
    }

    /* Bouton ajouter ligne */
    .add-row-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      width: 100%;
      padding: 0.75rem;
      margin-top: 1rem;
      background: transparent;
      border: 2px dashed var(--border-default-grey);
      border-radius: 8px;
      color: var(--text-mention-grey);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .add-row-btn:hover {
      border-color: var(--border-action-high-blue-france);
      color: var(--text-action-high-blue-france);
      background: var(--background-alt-blue-france);
    }

    /* Modal de configuration */
    .config-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .config-modal.active {
      display: flex;
    }

    .config-modal-content {
      background: var(--background-default-grey);
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    .config-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border-default-grey);
    }

    .config-modal-header h3 {
      margin: 0;
      font-size: 1.125rem;
    }

    .config-modal-body {
      padding: 1.5rem;
    }

    .config-modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--border-default-grey);
    }

    .config-group {
      margin-bottom: 1rem;
    }

    .config-group label {
      display: block;
      margin-bottom: 0.25rem;
      font-weight: 500;
      font-size: 0.875rem;
    }

    .config-group input,
    .config-group select,
    .config-group textarea {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--border-default-grey);
      border-radius: 4px;
      font-size: 0.875rem;
    }

    .config-group textarea {
      min-height: 100px;
      font-family: monospace;
    }

    /* Onglets du bas */
    .vde-tabs {
      display: flex;
      border-top: 1px solid var(--border-default-grey);
      background: var(--background-default-grey);
    }

    .vde-tab {
      flex: 1;
      padding: 0.75rem;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      color: var(--text-mention-grey);
    }

    .vde-tab:hover {
      background: var(--background-alt-grey);
    }

    .vde-tab.active {
      border-bottom-color: var(--border-action-high-blue-france);
      color: var(--text-action-high-blue-france);
      font-weight: 600;
    }

    .vde-tab-content {
      display: none;
      padding: 1rem;
      background: var(--background-alt-grey);
      border-top: 1px solid var(--border-default-grey);
      max-height: 300px;
      overflow-y: auto;
    }

    .vde-tab-content.active {
      display: block;
    }

    .code-preview {
      background: var(--background-contrast-grey);
      padding: 1rem;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.8125rem;
      white-space: pre-wrap;
      overflow-x: auto;
    }

    /* Responsive */
    @media (max-width: 992px) {
      .vde-container {
        flex-direction: column;
      }

      .vde-sidebar {
        width: 100%;
        max-height: 250px;
        border-right: none;
        border-bottom: 1px solid var(--border-default-grey);
      }

      .widget-library {
        grid-template-columns: repeat(4, 1fr);
      }
    }

    @media (max-width: 576px) {
      .widget-library {
        grid-template-columns: repeat(2, 1fr);
      }

      .vde-toolbar {
        flex-direction: column;
        gap: 0.5rem;
      }

      .vde-toolbar-left,
      .vde-toolbar-right {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <app-header current-page="dashboard" base-path="./"></app-header>

  <div class="vde-container">
    <!-- Sidebar gauche -->
    <aside class="vde-sidebar">
      <!-- Bibliothèque de widgets -->
      <div class="vde-sidebar-section">
        <h3><i class="ri-dashboard-line"></i> Widgets</h3>
        <div class="widget-library" id="widget-library">
          <div class="widget-item" draggable="true" data-widget-type="kpi">
            <i class="ri-number-1"></i>
            <span>KPI</span>
          </div>
          <div class="widget-item" draggable="true" data-widget-type="chart">
            <i class="ri-bar-chart-box-line"></i>
            <span>Graphique</span>
          </div>
          <div class="widget-item" draggable="true" data-widget-type="table">
            <i class="ri-table-line"></i>
            <span>Tableau</span>
          </div>
          <div class="widget-item" draggable="true" data-widget-type="text">
            <i class="ri-text"></i>
            <span>Texte</span>
          </div>
        </div>
      </div>

      <!-- Favoris -->
      <div class="vde-sidebar-section">
        <h3><i class="ri-star-line"></i> Mes favoris</h3>
        <div class="favorites-list" id="favorites-list">
          <p class="favorites-empty">Chargement...</p>
        </div>
      </div>

      <!-- Paramètres de grille -->
      <div class="vde-sidebar-section">
        <h3><i class="ri-settings-3-line"></i> Grille</h3>
        <div class="grid-settings">
          <label>
            Colonnes par défaut
            <select id="grid-columns">
              <option value="1">1 colonne</option>
              <option value="2" selected>2 colonnes</option>
              <option value="3">3 colonnes</option>
              <option value="4">4 colonnes</option>
            </select>
          </label>
          <label>
            Espacement
            <select id="grid-gap">
              <option value="fr-grid-row--gutters">Normal</option>
              <option value="">Sans espacement</option>
            </select>
          </label>
        </div>
      </div>

      <!-- Sources -->
      <div class="vde-sidebar-section">
        <h3><i class="ri-database-2-line"></i> Sources</h3>
        <div id="sources-list">
          <p class="favorites-empty">Aucune source</p>
        </div>
        <button class="fr-btn fr-btn--sm fr-btn--secondary fr-mt-1w" id="add-source-btn">
          <i class="ri-add-line"></i> Ajouter une source
        </button>
      </div>
    </aside>

    <!-- Zone principale -->
    <main class="vde-main">
      <!-- Toolbar -->
      <div class="vde-toolbar">
        <div class="vde-toolbar-left">
          <input type="text" class="dashboard-title-input" id="dashboard-title" value="Mon tableau de bord" placeholder="Titre du dashboard">
        </div>
        <div class="vde-toolbar-right">
          <button class="fr-btn fr-btn--sm fr-btn--secondary" id="btn-new">
            <i class="ri-file-add-line"></i> Nouveau
          </button>
          <button class="fr-btn fr-btn--sm fr-btn--secondary" id="btn-load">
            <i class="ri-folder-open-line"></i> Ouvrir
          </button>
          <button class="fr-btn fr-btn--sm" id="btn-save">
            <i class="ri-save-line"></i> Sauvegarder
          </button>
          <button class="fr-btn fr-btn--sm fr-btn--tertiary" id="btn-export">
            <i class="ri-download-line"></i> Exporter HTML
          </button>
        </div>
      </div>

      <!-- Preview -->
      <div class="vde-preview">
        <div class="vde-canvas">
          <div class="dashboard-grid" id="dashboard-grid">
            <!-- Ligne 1 -->
            <div class="fr-grid-row fr-grid-row--gutters dashboard-row" data-row="0">
              <div class="fr-col-12 fr-col-md-6">
                <div class="drop-cell empty" data-row="0" data-col="0" data-colspan="6">
                  <div class="drop-cell-placeholder">
                    <i class="ri-add-circle-line"></i>
                    <span>Glisser un widget ici</span>
                  </div>
                </div>
              </div>
              <div class="fr-col-12 fr-col-md-6">
                <div class="drop-cell empty" data-row="0" data-col="1" data-colspan="6">
                  <div class="drop-cell-placeholder">
                    <i class="ri-add-circle-line"></i>
                    <span>Glisser un widget ici</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <button class="add-row-btn" id="add-row-btn">
            <i class="ri-add-line"></i> Ajouter une ligne
          </button>
        </div>
      </div>

      <!-- Onglets bas -->
      <div class="vde-tabs">
        <button class="vde-tab active" data-tab="preview">
          <i class="ri-eye-line"></i> Aperçu
        </button>
        <button class="vde-tab" data-tab="code">
          <i class="ri-code-line"></i> Code généré
        </button>
        <button class="vde-tab" data-tab="json">
          <i class="ri-braces-line"></i> JSON
        </button>
      </div>

      <div class="vde-tab-content" id="tab-preview"></div>
      <div class="vde-tab-content" id="tab-code">
        <pre class="code-preview" id="generated-code"><!-- Le code sera généré ici --></pre>
      </div>
      <div class="vde-tab-content" id="tab-json">
        <pre class="code-preview" id="generated-json">{}</pre>
      </div>
    </div>
  </div>

  <!-- Modal de configuration -->
  <div class="config-modal" id="config-modal">
    <div class="config-modal-content">
      <div class="config-modal-header">
        <h3 id="config-modal-title">Configurer le widget</h3>
        <button class="widget-action-btn" id="close-modal">
          <i class="ri-close-line" style="font-size: 1.5rem;"></i>
        </button>
      </div>
      <div class="config-modal-body" id="config-modal-body">
        <!-- Contenu dynamique -->
      </div>
      <div class="config-modal-footer">
        <button class="fr-btn fr-btn--secondary" id="cancel-config">Annuler</button>
        <button class="fr-btn" id="apply-config">Appliquer</button>
      </div>
    </div>
  </div>

  <!-- Modal liste des dashboards -->
  <div class="config-modal" id="dashboards-modal">
    <div class="config-modal-content">
      <div class="config-modal-header">
        <h3>Mes tableaux de bord</h3>
        <button class="widget-action-btn" id="close-dashboards-modal">
          <i class="ri-close-line" style="font-size: 1.5rem;"></i>
        </button>
      </div>
      <div class="config-modal-body" id="dashboards-list">
        <!-- Liste dynamique -->
      </div>
    </div>
  </div>

  <script type="module">
    // ============================================================
    // ÉTAT DE L'APPLICATION
    // ============================================================
    const state = {
      dashboard: {
        id: null,
        name: 'Mon tableau de bord',
        createdAt: null,
        updatedAt: null,
        layout: {
          columns: 2,
          gap: 'fr-grid-row--gutters'
        },
        widgets: [],
        sources: []
      },
      selectedWidget: null,
      favorites: [],
      savedDashboards: []
    };

    // Clés localStorage
    const STORAGE_KEYS = {
      DASHBOARDS: 'gouv-widgets-dashboards',
      FAVORITES: 'gouv-widgets-favorites',
      SOURCES: 'gouv_widgets_sources'
    };

    // ============================================================
    // INITIALISATION
    // ============================================================
    document.addEventListener('DOMContentLoaded', () => {
      loadFavorites();
      loadSavedDashboards();
      loadSources();
      initDragAndDrop();
      initEventListeners();
      updateGeneratedCode();
    });

    function loadFavorites() {
      try {
        const stored = localStorage.getItem(STORAGE_KEYS.FAVORITES);
        state.favorites = stored ? JSON.parse(stored) : [];
        renderFavorites();
      } catch (e) {
        console.error('Erreur chargement favoris:', e);
        state.favorites = [];
      }
    }

    function loadSavedDashboards() {
      try {
        const stored = localStorage.getItem(STORAGE_KEYS.DASHBOARDS);
        state.savedDashboards = stored ? JSON.parse(stored) : [];
      } catch (e) {
        console.error('Erreur chargement dashboards:', e);
        state.savedDashboards = [];
      }
    }

    function loadSources() {
      try {
        const stored = localStorage.getItem(STORAGE_KEYS.SOURCES);
        const sources = stored ? JSON.parse(stored) : [];
        renderSources(sources);
      } catch (e) {
        console.error('Erreur chargement sources:', e);
      }
    }

    function renderFavorites() {
      const container = document.getElementById('favorites-list');

      if (state.favorites.length === 0) {
        container.innerHTML = '<p class="favorites-empty">Aucun favori. Créez des graphiques dans le Builder.</p>';
        return;
      }

      container.innerHTML = state.favorites.map(fav => `
        <div class="favorite-item" draggable="true" data-favorite-id="${fav.id}">
          <i class="ri-star-fill"></i>
          <span>${escapeHtml(fav.name)}</span>
        </div>
      `).join('');

      // Ajouter drag events aux favoris
      container.querySelectorAll('.favorite-item').forEach(item => {
        item.addEventListener('dragstart', handleFavoriteDragStart);
        item.addEventListener('dragend', handleDragEnd);
      });
    }

    function renderSources(sources) {
      const container = document.getElementById('sources-list');

      if (!sources || sources.length === 0) {
        container.innerHTML = '<p class="favorites-empty">Aucune source disponible</p>';
        return;
      }

      container.innerHTML = sources.slice(0, 5).map(src => `
        <div class="favorite-item" style="cursor: default;">
          <i class="ri-database-2-line"></i>
          <span>${escapeHtml(src.name)}</span>
        </div>
      `).join('');
    }

    // ============================================================
    // DRAG AND DROP
    // ============================================================
    function initDragAndDrop() {
      // Widgets de la bibliothèque
      document.querySelectorAll('.widget-item').forEach(item => {
        item.addEventListener('dragstart', handleWidgetDragStart);
        item.addEventListener('dragend', handleDragEnd);
      });

      // Initialiser les zones de dépôt
      initDropZones();
    }

    function initDropZones() {
      document.querySelectorAll('.drop-cell').forEach(cell => {
        cell.addEventListener('dragover', handleDragOver);
        cell.addEventListener('dragleave', handleDragLeave);
        cell.addEventListener('drop', handleDrop);
        cell.addEventListener('click', handleCellClick);
      });
    }

    let draggedData = null;

    function handleWidgetDragStart(e) {
      const type = e.target.dataset.widgetType;
      draggedData = { type: 'new', widgetType: type };
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'copy';
      e.dataTransfer.setData('text/plain', JSON.stringify(draggedData));
    }

    function handleFavoriteDragStart(e) {
      const id = e.target.dataset.favoriteId;
      const favorite = state.favorites.find(f => f.id === id);
      draggedData = { type: 'favorite', favorite };
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'copy';
      e.dataTransfer.setData('text/plain', JSON.stringify(draggedData));
    }

    function handleDragEnd(e) {
      e.target.classList.remove('dragging');
      draggedData = null;
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'copy';
      e.currentTarget.classList.add('drag-over');
    }

    function handleDragLeave(e) {
      e.currentTarget.classList.remove('drag-over');
    }

    function handleDrop(e) {
      e.preventDefault();
      e.currentTarget.classList.remove('drag-over');

      if (!draggedData) {
        try {
          draggedData = JSON.parse(e.dataTransfer.getData('text/plain'));
        } catch (err) {
          return;
        }
      }

      const cell = e.currentTarget;
      const row = parseInt(cell.dataset.row);
      const col = parseInt(cell.dataset.col);

      if (draggedData.type === 'new') {
        addWidget(draggedData.widgetType, row, col, cell);
      } else if (draggedData.type === 'favorite') {
        addWidgetFromFavorite(draggedData.favorite, row, col, cell);
      }

      draggedData = null;
    }

    function handleCellClick(e) {
      const cell = e.currentTarget;
      if (!cell.classList.contains('empty')) return;

      // Ouvrir un menu pour choisir le type de widget
      const type = prompt('Type de widget (kpi, chart, table, text):');
      if (type && ['kpi', 'chart', 'table', 'text'].includes(type)) {
        const row = parseInt(cell.dataset.row);
        const col = parseInt(cell.dataset.col);
        addWidget(type, row, col, cell);
      }
    }

    // ============================================================
    // GESTION DES WIDGETS
    // ============================================================
    function addWidget(type, row, col, cell) {
      const widget = {
        id: `widget-${Date.now()}`,
        type: type,
        title: getDefaultTitle(type),
        position: { row, col },
        config: getDefaultConfig(type)
      };

      state.dashboard.widgets.push(widget);
      renderWidget(widget, cell);
      openConfigModal(widget);
      updateGeneratedCode();
    }

    function addWidgetFromFavorite(favorite, row, col, cell) {
      const widget = {
        id: `widget-${Date.now()}`,
        type: 'chart',
        title: favorite.name,
        position: { row, col },
        config: {
          fromFavorite: true,
          favoriteId: favorite.id,
          code: favorite.code,
          builderState: favorite.builderState
        }
      };

      state.dashboard.widgets.push(widget);
      renderWidget(widget, cell);
      updateGeneratedCode();
    }

    function getDefaultTitle(type) {
      const titles = {
        kpi: 'Indicateur',
        chart: 'Graphique',
        table: 'Tableau de données',
        text: 'Texte'
      };
      return titles[type] || 'Widget';
    }

    function getDefaultConfig(type) {
      switch (type) {
        case 'kpi':
          return {
            valeur: '',
            format: 'nombre',
            icone: '',
            label: 'Mon KPI'
          };
        case 'chart':
          return {
            chartType: 'bar',
            labelField: '',
            valueField: '',
            palette: 'categorical'
          };
        case 'table':
          return {
            columns: [],
            searchable: true,
            sortable: true
          };
        case 'text':
          return {
            content: '<p>Votre texte ici...</p>',
            style: 'paragraph'
          };
        default:
          return {};
      }
    }

    function renderWidget(widget, cell) {
      cell.classList.remove('empty');
      cell.innerHTML = `
        <div class="dashboard-widget" data-widget-id="${widget.id}">
          <div class="widget-header">
            <h4 class="widget-title">
              <i class="${getWidgetIcon(widget.type)}"></i>
              ${escapeHtml(widget.title)}
            </h4>
            <div class="widget-actions">
              <button class="widget-action-btn" onclick="editWidget('${widget.id}')" title="Configurer">
                <i class="ri-settings-3-line"></i>
              </button>
              <button class="widget-action-btn" onclick="deleteWidget('${widget.id}')" title="Supprimer">
                <i class="ri-delete-bin-line"></i>
              </button>
            </div>
          </div>
          <div class="widget-content">
            ${renderWidgetContent(widget)}
          </div>
        </div>
      `;
    }

    function getWidgetIcon(type) {
      const icons = {
        kpi: 'ri-number-1',
        chart: 'ri-bar-chart-box-line',
        table: 'ri-table-line',
        text: 'ri-text'
      };
      return icons[type] || 'ri-question-line';
    }

    function renderWidgetContent(widget) {
      switch (widget.type) {
        case 'kpi':
          return `
            <div style="text-align: center; padding: 1rem;">
              <div style="font-size: 2rem; font-weight: 700; color: var(--text-action-high-blue-france);">
                ${widget.config.valeur || '—'}
              </div>
              <div style="font-size: 0.875rem; color: var(--text-mention-grey);">
                ${escapeHtml(widget.config.label || '')}
              </div>
            </div>
          `;
        case 'chart':
          if (widget.config.fromFavorite) {
            return `<div style="padding: 1rem; text-align: center; color: var(--text-mention-grey);">
              <i class="ri-bar-chart-box-line" style="font-size: 2rem;"></i>
              <p style="margin: 0.5rem 0 0;">Graphique depuis favoris</p>
            </div>`;
          }
          return `<div style="padding: 1rem; text-align: center; color: var(--text-mention-grey);">
            <i class="ri-bar-chart-box-line" style="font-size: 2rem;"></i>
            <p style="margin: 0.5rem 0 0;">Configurez le graphique</p>
          </div>`;
        case 'table':
          return `<div style="padding: 1rem; text-align: center; color: var(--text-mention-grey);">
            <i class="ri-table-line" style="font-size: 2rem;"></i>
            <p style="margin: 0.5rem 0 0;">Tableau de données</p>
          </div>`;
        case 'text':
          return `<div style="padding: 0.5rem;">${widget.config.content || ''}</div>`;
        default:
          return '<div>Widget</div>';
      }
    }

    // Exposer les fonctions globalement
    window.editWidget = function(widgetId) {
      const widget = state.dashboard.widgets.find(w => w.id === widgetId);
      if (widget) {
        openConfigModal(widget);
      }
    };

    window.deleteWidget = function(widgetId) {
      if (!confirm('Supprimer ce widget ?')) return;

      const index = state.dashboard.widgets.findIndex(w => w.id === widgetId);
      if (index > -1) {
        const widget = state.dashboard.widgets[index];
        state.dashboard.widgets.splice(index, 1);

        // Restaurer la cellule vide
        const cell = document.querySelector(`.drop-cell[data-row="${widget.position.row}"][data-col="${widget.position.col}"]`);
        if (cell) {
          cell.classList.add('empty');
          cell.innerHTML = `
            <div class="drop-cell-placeholder">
              <i class="ri-add-circle-line"></i>
              <span>Glisser un widget ici</span>
            </div>
          `;
        }

        updateGeneratedCode();
      }
    };

    // ============================================================
    // MODAL DE CONFIGURATION
    // ============================================================
    function openConfigModal(widget) {
      state.selectedWidget = widget;
      const modal = document.getElementById('config-modal');
      const title = document.getElementById('config-modal-title');
      const body = document.getElementById('config-modal-body');

      title.textContent = `Configurer: ${widget.title}`;
      body.innerHTML = getConfigForm(widget);

      modal.classList.add('active');
    }

    function closeConfigModal() {
      document.getElementById('config-modal').classList.remove('active');
      state.selectedWidget = null;
    }

    function getConfigForm(widget) {
      const commonFields = `
        <div class="config-group">
          <label>Titre du widget</label>
          <input type="text" id="config-title" value="${escapeHtml(widget.title)}">
        </div>
      `;

      switch (widget.type) {
        case 'kpi':
          return commonFields + `
            <div class="config-group">
              <label>Valeur (ou expression: sum:field, avg:field)</label>
              <input type="text" id="config-valeur" value="${escapeHtml(widget.config.valeur || '')}">
            </div>
            <div class="config-group">
              <label>Label</label>
              <input type="text" id="config-label" value="${escapeHtml(widget.config.label || '')}">
            </div>
            <div class="config-group">
              <label>Format</label>
              <select id="config-format">
                <option value="nombre" ${widget.config.format === 'nombre' ? 'selected' : ''}>Nombre</option>
                <option value="pourcentage" ${widget.config.format === 'pourcentage' ? 'selected' : ''}>Pourcentage</option>
                <option value="euro" ${widget.config.format === 'euro' ? 'selected' : ''}>Euro</option>
                <option value="texte" ${widget.config.format === 'texte' ? 'selected' : ''}>Texte</option>
              </select>
            </div>
            <div class="config-group">
              <label>Icône (ex: ri-money-euro-circle-line)</label>
              <input type="text" id="config-icone" value="${escapeHtml(widget.config.icone || '')}">
            </div>
          `;

        case 'chart':
          if (widget.config.fromFavorite) {
            return commonFields + `
              <div class="fr-callout fr-callout--green-emeraude">
                <p class="fr-callout__text">
                  Ce graphique provient de vos favoris et utilise sa configuration d'origine.
                </p>
              </div>
            `;
          }
          return commonFields + `
            <div class="config-group">
              <label>Type de graphique</label>
              <select id="config-chartType">
                <option value="bar" ${widget.config.chartType === 'bar' ? 'selected' : ''}>Barres</option>
                <option value="line" ${widget.config.chartType === 'line' ? 'selected' : ''}>Ligne</option>
                <option value="pie" ${widget.config.chartType === 'pie' ? 'selected' : ''}>Camembert</option>
                <option value="radar" ${widget.config.chartType === 'radar' ? 'selected' : ''}>Radar</option>
              </select>
            </div>
            <div class="config-group">
              <label>Champ pour les labels (axe X)</label>
              <input type="text" id="config-labelField" value="${escapeHtml(widget.config.labelField || '')}">
            </div>
            <div class="config-group">
              <label>Champ pour les valeurs (axe Y)</label>
              <input type="text" id="config-valueField" value="${escapeHtml(widget.config.valueField || '')}">
            </div>
            <div class="config-group">
              <label>Palette de couleurs</label>
              <select id="config-palette">
                <option value="categorical" ${widget.config.palette === 'categorical' ? 'selected' : ''}>Catégorielle</option>
                <option value="sequentialAscending" ${widget.config.palette === 'sequentialAscending' ? 'selected' : ''}>Séquentielle</option>
                <option value="divergent" ${widget.config.palette === 'divergent' ? 'selected' : ''}>Divergente</option>
              </select>
            </div>
          `;

        case 'table':
          return commonFields + `
            <div class="config-group">
              <label>Colonnes (séparées par des virgules)</label>
              <input type="text" id="config-columns" value="${(widget.config.columns || []).join(', ')}">
            </div>
            <div class="config-group">
              <label>
                <input type="checkbox" id="config-searchable" ${widget.config.searchable ? 'checked' : ''}>
                Recherche activée
              </label>
            </div>
            <div class="config-group">
              <label>
                <input type="checkbox" id="config-sortable" ${widget.config.sortable ? 'checked' : ''}>
                Tri activé
              </label>
            </div>
          `;

        case 'text':
          return commonFields + `
            <div class="config-group">
              <label>Contenu HTML</label>
              <textarea id="config-content">${escapeHtml(widget.config.content || '')}</textarea>
            </div>
            <div class="config-group">
              <label>Style</label>
              <select id="config-style">
                <option value="paragraph" ${widget.config.style === 'paragraph' ? 'selected' : ''}>Paragraphe</option>
                <option value="title" ${widget.config.style === 'title' ? 'selected' : ''}>Titre</option>
                <option value="callout" ${widget.config.style === 'callout' ? 'selected' : ''}>Callout</option>
              </select>
            </div>
          `;

        default:
          return commonFields;
      }
    }

    function applyConfig() {
      if (!state.selectedWidget) return;

      const widget = state.selectedWidget;

      // Titre commun
      widget.title = document.getElementById('config-title')?.value || widget.title;

      // Config spécifique
      switch (widget.type) {
        case 'kpi':
          widget.config.valeur = document.getElementById('config-valeur')?.value || '';
          widget.config.label = document.getElementById('config-label')?.value || '';
          widget.config.format = document.getElementById('config-format')?.value || 'nombre';
          widget.config.icone = document.getElementById('config-icone')?.value || '';
          break;

        case 'chart':
          if (!widget.config.fromFavorite) {
            widget.config.chartType = document.getElementById('config-chartType')?.value || 'bar';
            widget.config.labelField = document.getElementById('config-labelField')?.value || '';
            widget.config.valueField = document.getElementById('config-valueField')?.value || '';
            widget.config.palette = document.getElementById('config-palette')?.value || 'categorical';
          }
          break;

        case 'table':
          const columnsStr = document.getElementById('config-columns')?.value || '';
          widget.config.columns = columnsStr.split(',').map(c => c.trim()).filter(c => c);
          widget.config.searchable = document.getElementById('config-searchable')?.checked ?? true;
          widget.config.sortable = document.getElementById('config-sortable')?.checked ?? true;
          break;

        case 'text':
          widget.config.content = document.getElementById('config-content')?.value || '';
          widget.config.style = document.getElementById('config-style')?.value || 'paragraph';
          break;
      }

      // Re-render le widget
      const cell = document.querySelector(`.drop-cell[data-row="${widget.position.row}"][data-col="${widget.position.col}"]`);
      if (cell) {
        renderWidget(widget, cell);
      }

      closeConfigModal();
      updateGeneratedCode();
    }

    // ============================================================
    // GESTION DES LIGNES
    // ============================================================
    function addRow() {
      const grid = document.getElementById('dashboard-grid');
      const rowIndex = grid.querySelectorAll('.dashboard-row').length;
      const columns = parseInt(document.getElementById('grid-columns').value) || 2;
      const colSize = Math.floor(12 / columns);

      const row = document.createElement('div');
      row.className = `fr-grid-row ${state.dashboard.layout.gap} dashboard-row`;
      row.dataset.row = rowIndex;

      for (let i = 0; i < columns; i++) {
        const colClass = colSize === 12 ? 'fr-col-12' : `fr-col-12 fr-col-md-${colSize}`;
        row.innerHTML += `
          <div class="${colClass}">
            <div class="drop-cell empty" data-row="${rowIndex}" data-col="${i}" data-colspan="${colSize}">
              <div class="drop-cell-placeholder">
                <i class="ri-add-circle-line"></i>
                <span>Glisser un widget ici</span>
              </div>
            </div>
          </div>
        `;
      }

      grid.appendChild(row);
      initDropZones();
    }

    // ============================================================
    // GÉNÉRATION DE CODE
    // ============================================================
    function updateGeneratedCode() {
      const code = generateHTMLCode();
      document.getElementById('generated-code').textContent = code;
      document.getElementById('generated-json').textContent = JSON.stringify(state.dashboard, null, 2);
    }

    function generateHTMLCode() {
      const { dashboard } = state;
      const columns = dashboard.layout.columns || 2;
      const colSize = Math.floor(12 / columns);
      const colClass = colSize === 12 ? 'fr-col-12' : `fr-col-12 fr-col-md-${colSize}`;

      // Grouper les widgets par ligne
      const widgetsByRow = {};
      dashboard.widgets.forEach(w => {
        if (!widgetsByRow[w.position.row]) {
          widgetsByRow[w.position.row] = [];
        }
        widgetsByRow[w.position.row].push(w);
      });

      let widgetsHTML = '';
      Object.keys(widgetsByRow).sort((a, b) => a - b).forEach(rowIdx => {
        const widgets = widgetsByRow[rowIdx];
        widgetsHTML += `    <div class="fr-grid-row ${dashboard.layout.gap}">\n`;

        widgets.forEach(widget => {
          widgetsHTML += `      <div class="${colClass}">\n`;
          widgetsHTML += generateWidgetHTML(widget);
          widgetsHTML += `      </div>\n`;
        });

        widgetsHTML += `    </div>\n`;
      });

      return `<!DOCTYPE html>
<html lang="fr" data-fr-theme>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${escapeHtml(dashboard.name)} - gouv-widgets</title>

  <!-- DSFR -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/utility/utility.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css">

  <!-- DSFR Chart -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr-chart@2.0.4/dist/DSFRChart/DSFRChart.css">
  <script type="module" src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr-chart@2.0.4/dist/DSFRChart/DSFRChart.js"><\/script>

  <!-- gouv-widgets -->
  <script type="module" src="https://cdn.jsdelivr.net/gh/AubertMusic/datasource-charts-webcomponents@v0.2.0/dist/gouv-widgets.esm.js"><\/script>
</head>
<body>
  <div class="fr-container fr-my-4w">
    <h1>${escapeHtml(dashboard.name)}</h1>

${widgetsHTML}
  </div>

  <script type="module" src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.module.min.js"><\/script>
</body>
</html>`;
    }

    function generateWidgetHTML(widget) {
      const indent = '        ';

      switch (widget.type) {
        case 'kpi':
          const iconeAttr = widget.config.icone ? ` icone="${widget.config.icone}"` : '';
          return `${indent}<gouv-kpi
${indent}  valeur="${escapeHtml(widget.config.valeur || '')}"
${indent}  label="${escapeHtml(widget.config.label || widget.title)}"
${indent}  format="${widget.config.format || 'nombre'}"${iconeAttr}>
${indent}</gouv-kpi>\n`;

        case 'chart':
          if (widget.config.fromFavorite && widget.config.code) {
            // Extraire juste le contenu du graphique du code du favori
            return `${indent}<!-- Graphique: ${escapeHtml(widget.title)} -->\n${indent}${widget.config.code.split('\n').join('\n' + indent)}\n`;
          }
          return `${indent}<gouv-dsfr-chart
${indent}  type="${widget.config.chartType || 'bar'}"
${indent}  label-field="${escapeHtml(widget.config.labelField || '')}"
${indent}  value-field="${escapeHtml(widget.config.valueField || '')}"
${indent}  selected-palette="${widget.config.palette || 'categorical'}">
${indent}</gouv-dsfr-chart>\n`;

        case 'table':
          const columns = widget.config.columns?.length ? ` columns='${JSON.stringify(widget.config.columns)}'` : '';
          const searchable = widget.config.searchable ? ' searchable' : '';
          const sortable = widget.config.sortable ? ' sortable' : '';
          return `${indent}<gouv-datalist${columns}${searchable}${sortable}>
${indent}</gouv-datalist>\n`;

        case 'text':
          if (widget.config.style === 'callout') {
            return `${indent}<div class="fr-callout">
${indent}  <p class="fr-callout__text">${widget.config.content}</p>
${indent}</div>\n`;
          } else if (widget.config.style === 'title') {
            return `${indent}<h2>${widget.config.content}</h2>\n`;
          }
          return `${indent}<p>${widget.config.content}</p>\n`;

        default:
          return `${indent}<!-- Widget: ${escapeHtml(widget.title)} -->\n`;
      }
    }

    // ============================================================
    // SAUVEGARDE / CHARGEMENT
    // ============================================================
    function saveDashboard() {
      const name = document.getElementById('dashboard-title').value.trim();
      if (!name) {
        alert('Veuillez donner un nom au tableau de bord');
        return;
      }

      state.dashboard.name = name;
      state.dashboard.updatedAt = new Date().toISOString();

      if (!state.dashboard.id) {
        state.dashboard.id = `dashboard-${Date.now()}`;
        state.dashboard.createdAt = state.dashboard.updatedAt;
      }

      // Sauvegarder
      const index = state.savedDashboards.findIndex(d => d.id === state.dashboard.id);
      if (index > -1) {
        state.savedDashboards[index] = { ...state.dashboard };
      } else {
        state.savedDashboards.push({ ...state.dashboard });
      }

      localStorage.setItem(STORAGE_KEYS.DASHBOARDS, JSON.stringify(state.savedDashboards));
      alert('Tableau de bord sauvegardé !');
    }

    function newDashboard() {
      if (state.dashboard.widgets.length > 0) {
        if (!confirm('Créer un nouveau tableau de bord ? Les modifications non sauvegardées seront perdues.')) {
          return;
        }
      }

      state.dashboard = {
        id: null,
        name: 'Mon tableau de bord',
        createdAt: null,
        updatedAt: null,
        layout: {
          columns: 2,
          gap: 'fr-grid-row--gutters'
        },
        widgets: [],
        sources: []
      };

      document.getElementById('dashboard-title').value = state.dashboard.name;
      resetGrid();
      updateGeneratedCode();
    }

    function resetGrid() {
      const grid = document.getElementById('dashboard-grid');
      const columns = parseInt(document.getElementById('grid-columns').value) || 2;
      const colSize = Math.floor(12 / columns);
      const colClass = colSize === 12 ? 'fr-col-12' : `fr-col-12 fr-col-md-${colSize}`;

      grid.innerHTML = `
        <div class="fr-grid-row ${state.dashboard.layout.gap} dashboard-row" data-row="0">
          ${Array(columns).fill(0).map((_, i) => `
            <div class="${colClass}">
              <div class="drop-cell empty" data-row="0" data-col="${i}" data-colspan="${colSize}">
                <div class="drop-cell-placeholder">
                  <i class="ri-add-circle-line"></i>
                  <span>Glisser un widget ici</span>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;

      initDropZones();
    }

    function openDashboardsList() {
      const modal = document.getElementById('dashboards-modal');
      const list = document.getElementById('dashboards-list');

      if (state.savedDashboards.length === 0) {
        list.innerHTML = '<p class="favorites-empty">Aucun tableau de bord sauvegardé</p>';
      } else {
        list.innerHTML = state.savedDashboards.map(d => `
          <div class="favorite-item" style="cursor: pointer; margin-bottom: 0.5rem;" onclick="loadDashboard('${d.id}')">
            <i class="ri-dashboard-line"></i>
            <span>${escapeHtml(d.name)}</span>
            <small style="color: var(--text-mention-grey); margin-left: auto;">
              ${new Date(d.updatedAt).toLocaleDateString('fr-FR')}
            </small>
          </div>
        `).join('');
      }

      modal.classList.add('active');
    }

    window.loadDashboard = function(id) {
      const dashboard = state.savedDashboards.find(d => d.id === id);
      if (!dashboard) return;

      state.dashboard = JSON.parse(JSON.stringify(dashboard));
      document.getElementById('dashboard-title').value = state.dashboard.name;
      document.getElementById('grid-columns').value = state.dashboard.layout.columns || 2;

      // Reconstruire la grille
      rebuildGrid();

      document.getElementById('dashboards-modal').classList.remove('active');
      updateGeneratedCode();
    };

    function rebuildGrid() {
      const grid = document.getElementById('dashboard-grid');
      const columns = state.dashboard.layout.columns || 2;
      const colSize = Math.floor(12 / columns);
      const colClass = colSize === 12 ? 'fr-col-12' : `fr-col-12 fr-col-md-${colSize}`;

      // Trouver le nombre de lignes nécessaires
      const maxRow = state.dashboard.widgets.reduce((max, w) => Math.max(max, w.position.row), 0);

      grid.innerHTML = '';

      for (let rowIdx = 0; rowIdx <= maxRow; rowIdx++) {
        const row = document.createElement('div');
        row.className = `fr-grid-row ${state.dashboard.layout.gap} dashboard-row`;
        row.dataset.row = rowIdx;

        for (let colIdx = 0; colIdx < columns; colIdx++) {
          const widget = state.dashboard.widgets.find(w => w.position.row === rowIdx && w.position.col === colIdx);
          const colDiv = document.createElement('div');
          colDiv.className = colClass;

          const cell = document.createElement('div');
          cell.className = 'drop-cell';
          cell.dataset.row = rowIdx;
          cell.dataset.col = colIdx;
          cell.dataset.colspan = colSize;

          if (widget) {
            renderWidget(widget, cell);
          } else {
            cell.classList.add('empty');
            cell.innerHTML = `
              <div class="drop-cell-placeholder">
                <i class="ri-add-circle-line"></i>
                <span>Glisser un widget ici</span>
              </div>
            `;
          }

          colDiv.appendChild(cell);
          row.appendChild(colDiv);
        }

        grid.appendChild(row);
      }

      // Ajouter une ligne vide si besoin
      if (state.dashboard.widgets.length === 0 || state.dashboard.widgets.every(w => w.position.row <= maxRow)) {
        addRow();
      }

      initDropZones();
    }

    function exportHTML() {
      const code = generateHTMLCode();
      const blob = new Blob([code], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${state.dashboard.name.replace(/[^a-z0-9]/gi, '-').toLowerCase()}.html`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ============================================================
    // EVENT LISTENERS
    // ============================================================
    function initEventListeners() {
      // Boutons toolbar
      document.getElementById('btn-new').addEventListener('click', newDashboard);
      document.getElementById('btn-load').addEventListener('click', openDashboardsList);
      document.getElementById('btn-save').addEventListener('click', saveDashboard);
      document.getElementById('btn-export').addEventListener('click', exportHTML);

      // Ajouter ligne
      document.getElementById('add-row-btn').addEventListener('click', addRow);

      // Modal config
      document.getElementById('close-modal').addEventListener('click', closeConfigModal);
      document.getElementById('cancel-config').addEventListener('click', closeConfigModal);
      document.getElementById('apply-config').addEventListener('click', applyConfig);

      // Modal dashboards
      document.getElementById('close-dashboards-modal').addEventListener('click', () => {
        document.getElementById('dashboards-modal').classList.remove('active');
      });

      // Onglets
      document.querySelectorAll('.vde-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.dataset.tab;

          document.querySelectorAll('.vde-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.vde-tab-content').forEach(c => c.classList.remove('active'));

          tab.classList.add('active');
          if (tabName !== 'preview') {
            document.getElementById(`tab-${tabName}`).classList.add('active');
          }
        });
      });

      // Paramètres grille
      document.getElementById('grid-columns').addEventListener('change', (e) => {
        state.dashboard.layout.columns = parseInt(e.target.value);
        // Reconstruire si vide
        if (state.dashboard.widgets.length === 0) {
          resetGrid();
        }
      });

      document.getElementById('grid-gap').addEventListener('change', (e) => {
        state.dashboard.layout.gap = e.target.value;
        updateGeneratedCode();
      });

      // Titre
      document.getElementById('dashboard-title').addEventListener('input', (e) => {
        state.dashboard.name = e.target.value;
        updateGeneratedCode();
      });

      // Source
      document.getElementById('add-source-btn').addEventListener('click', () => {
        window.location.href = 'sources.html';
      });

      // Fermer modals au clic extérieur
      document.querySelectorAll('.config-modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.classList.remove('active');
          }
        });
      });
    }

    // ============================================================
    // UTILITAIRES
    // ============================================================
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
  </script>

  <script type="module" src="https://cdn.jsdelivr.net/npm/@gouvfr/dsfr@1.11.2/dist/dsfr.module.min.js"></script>
</body>
</html>
